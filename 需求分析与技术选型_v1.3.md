# Claude Code ä¼šè¯ç›‘æ§å™¨ - éœ€æ±‚åˆ†æä¸æŠ€æœ¯é€‰å‹æ–‡æ¡£

> **é¡¹ç›®åç§°**: Claude Code Session Monitor
> **ç‰ˆæœ¬**: v1.1 (å¢å¼ºç‰ˆ)
> **æ–‡æ¡£æ—¥æœŸ**: 2025-12-24
> **ç›®æ ‡å¹³å°**: Windows 10/11 (x64)

---

## ç›®å½•

1. [é¡¹ç›®æ¦‚è¿°](#1-é¡¹ç›®æ¦‚è¿°)
2. [éœ€æ±‚åˆ†æ](#2-éœ€æ±‚åˆ†æ)
3. [æŠ€æœ¯é€‰å‹](#3-æŠ€æœ¯é€‰å‹)
4. [ç³»ç»Ÿæ¶æ„è®¾è®¡](#4-ç³»ç»Ÿæ¶æ„è®¾è®¡)
5. [æ•°æ®åº“è®¾è®¡](#5-æ•°æ®åº“è®¾è®¡)
6. [æ ¸å¿ƒæ¨¡å—è®¾è®¡](#6-æ ¸å¿ƒæ¨¡å—è®¾è®¡)
7. [UI/UX è®¾è®¡](#7-uiux-è®¾è®¡)
8. [å¼€å‘è®¡åˆ’](#8-å¼€å‘è®¡åˆ’)
9. [é£é™©åˆ†æä¸åº”å¯¹](#9-é£é™©åˆ†æä¸åº”å¯¹)

---

## 1. é¡¹ç›®æ¦‚è¿°

### 1.1 é¡¹ç›®èƒŒæ™¯

Claude Code CLI æ˜¯ Anthropic å®˜æ–¹æä¾›çš„å‘½ä»¤è¡Œæ™ºèƒ½ç¼–ç åŠ©æ‰‹ï¼Œé€šè¿‡è‡ªç„¶è¯­è¨€æ‰§è¡Œå¼€å‘ä»»åŠ¡ã€‚ç”¨æˆ·åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ç§¯ç´¯å¤§é‡ä¼šè¯æ•°æ®ï¼Œè¿™äº›æ•°æ®åŒ…å«ï¼š

- ä»£ç å˜æ›´å†å²
- å·¥å…·è°ƒç”¨è®°å½•
- é—®é¢˜è§£å†³æ€è·¯
- é¡¹ç›®ä¸Šä¸‹æ–‡ä¿¡æ¯

å½“å‰ç—›ç‚¹ï¼š
1. **ä¸Šä¸‹æ–‡åˆ©ç”¨ä¸è¶³**ï¼šç”¨æˆ·åœ¨å¼€å§‹æ–°ä»»åŠ¡æ—¶ï¼Œéš¾ä»¥æœ‰æ•ˆåˆ©ç”¨å†å²ä¼šè¯çš„ä¸Šä¸‹æ–‡
2. **æç¤ºè¯è´¨é‡ä¾èµ–ç»éªŒ**ï¼šæ–°æ‰‹ç”¨æˆ·ç¼–å†™çš„æç¤ºè¯å¾€å¾€ä¿¡å™ªæ¯”ä½
3. **è·¨ä¼šè¯çŸ¥è¯†å¤ç”¨å›°éš¾**ï¼šå†å²è§£å†³æ–¹æ¡ˆéš¾ä»¥å¿«é€Ÿåº”ç”¨åˆ°æ–°åœºæ™¯

### 1.2 é¡¹ç›®ç›®æ ‡

**æ ¸å¿ƒä»·å€¼**ï¼šæ„å»ºä¸€ä¸ªå®æ—¶ç›‘æ§ Claude Code ä¼šè¯çš„æ¡Œé¢å·¥å…·ï¼Œé€šè¿‡æ™ºèƒ½åˆ†æä¸Šä¸‹æ–‡ï¼Œç”Ÿæˆé«˜è´¨é‡çš„æç¤ºè¯ï¼Œæå‡ AI ç¼–ç¨‹æ•ˆç‡ã€‚

**å…·ä½“ç›®æ ‡**ï¼š
- å®æ—¶æ•è·å¹¶è§£ææ‰€æœ‰æ´»è·ƒçš„ Claude Code ä¼šè¯
- æå–ä¼šè¯ä¸­çš„å…³é”®å†³ç­–ç‚¹å’Œè§£å†³æ–¹æ¡ˆ
- åŸºäºç”¨æˆ·æ„å›¾å’Œå†å²ä¸Šä¸‹æ–‡ï¼Œç”Ÿæˆä¼˜åŒ–çš„æç¤ºè¯
- æä¾›ç›´è§‚çš„ç•Œé¢æµè§ˆå’Œç®¡ç†ä¼šè¯å†å²

### 1.3 ç”¨æˆ·ç”»åƒ

| ç”¨æˆ·ç±»å‹ | ä½¿ç”¨åœºæ™¯ | æ ¸å¿ƒéœ€æ±‚ |
|---------|---------|---------|
| **ç‹¬ç«‹å¼€å‘è€…** | ä¸ªäººé¡¹ç›®å¼€å‘ | å¿«é€Ÿå‚è€ƒå†å²è§£å†³æ–¹æ¡ˆ |
| **æŠ€æœ¯å›¢é˜Ÿ** | åä½œå¼€å‘ | å…±äº«ä¼šè¯çŸ¥è¯†å’Œæœ€ä½³å®è·µ |
| **AI æç¤ºè¯å·¥ç¨‹å¸ˆ** | ä¼˜åŒ–å·¥ä½œæµ | åˆ†ææç¤ºè¯æ¨¡å¼ï¼Œæå‡æ•ˆç‡ |

---

## 2. éœ€æ±‚åˆ†æ

### 2.1 åŠŸèƒ½éœ€æ±‚

#### F1: ä¼šè¯å‘ç°ä¸ç›‘æ§

**æè¿°**ï¼šè‡ªåŠ¨å‘ç°å¹¶ç›‘æ§ç³»ç»Ÿä¸­æ‰€æœ‰æ´»è·ƒçš„ Claude Code ä¼šè¯ã€‚

**å­éœ€æ±‚**ï¼š
- **F1.1** æ‰«æ `~/.claude/projects/` ç›®å½•ï¼Œè¯†åˆ«æ‰€æœ‰ä¼šè¯æ–‡ä»¶
- **F1.2** å®æ—¶ç›‘æ§æ–‡ä»¶å˜æ›´ï¼Œè‡ªåŠ¨æ£€æµ‹æ–°ä¼šè¯
- **F1.3** æå–ä¼šè¯å…ƒæ•°æ®ï¼ˆsession IDã€é¡¹ç›®è·¯å¾„ã€åˆ›å»ºæ—¶é—´ã€æœ€åæ›´æ–°æ—¶é—´ï¼‰
- **F1.4** åŒºåˆ†æ´»è·ƒä¼šè¯å’Œå†å²ä¼šè¯

**éªŒæ”¶æ ‡å‡†**ï¼š
- å¯åŠ¨å 3 ç§’å†…å®Œæˆé¦–æ¬¡æ‰«æ
- æ–°ä¼šè¯åˆ›å»ºå 2 ç§’å†…å‡ºç°åœ¨åˆ—è¡¨ä¸­
- æ”¯æŒåŒæ—¶ç›‘æ§ 100+ ä¼šè¯

#### F2: ä¸Šä¸‹æ–‡è§£æä¸é‡æ„

**æè¿°**ï¼šè§£æ Claude Code çš„ JSONL æ ¼å¼ä¼šè¯æ–‡ä»¶ï¼Œé‡æ„ä¸ºç»“æ„åŒ–ä¸Šä¸‹æ–‡ã€‚

**å­éœ€æ±‚**ï¼š
- **F2.1** æµå¼è§£æ JSONL æ–‡ä»¶ï¼Œæ”¯æŒå¢é‡è¯»å–
- **F2.2** æ ¹æ® `parentUuid` é‡æ„æ¶ˆæ¯æ ‘
- **F2.3** è¯†åˆ«å¹¶æ ‡è®°å…³é”®èŠ‚ç‚¹ï¼ˆå·¥å…·è°ƒç”¨ã€é”™è¯¯ã€è§£å†³æ–¹æ¡ˆï¼‰
- **F2.4** æå–ä»£ç å˜æ›´ã€æ–‡ä»¶æ“ä½œç­‰ç»“æ„åŒ–ä¿¡æ¯
- **F2.5** ç”Ÿæˆå‘é‡åµŒå…¥ç”¨äºè¯­ä¹‰æ£€ç´¢

**æ•°æ®ç»“æ„ç¤ºä¾‹**ï¼š
```typescript
interface MessageNode {
  uuid: string;
  parentUuid: string | null;
  type: 'user' | 'assistant' | 'tool';
  timestamp: string;
  content: any;
  children: MessageNode[];
  metadata: {
    hasError: boolean;
    toolCalls: string[];
    codeChanges: CodeChange[];
    embedding?: number[];  // æ–°å¢ï¼šå‘é‡åµŒå…¥
  };
}

interface SessionContext {
  sessionId: string;
  projectPath: string;
  messageTree: MessageNode[];
  summary: {
    totalMessages: number;
    toolCalls: number;
    errors: number;
    duration: number;
  };
}
```

#### F3: æç¤ºè¯æ™ºèƒ½ä¼˜åŒ–

**æè¿°**ï¼šåŸºäºç”¨æˆ·æ„å›¾å’Œå†å²ä¸Šä¸‹æ–‡ï¼Œç”Ÿæˆé«˜ä¿¡å™ªæ¯”çš„æç¤ºè¯ã€‚

**å­éœ€æ±‚**ï¼š
- **F3.1** æ¥æ”¶ç”¨æˆ·è¾“å…¥çš„ç›®æ ‡/ä»»åŠ¡æè¿°
- **F3.2** ä½¿ç”¨å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢ç›¸å…³å†å²ä¼šè¯
- **F3.3** å‹ç¼©å†—ä½™ä¸Šä¸‹æ–‡ï¼Œä¿ç•™å…³é”®ä¿¡æ¯
- **F3.4** ç”Ÿæˆç»“æ„åŒ–çš„å¢å¼ºæç¤ºè¯
- **F3.5** å®æ—¶æ˜¾ç¤º Token è®¡æ•°å’ŒèŠ‚çœé‡

**ä¼˜åŒ–ç®—æ³•æµç¨‹**ï¼š
```
è¾“å…¥: userGoal, sessionContext
  â†“
1. å‘é‡æ£€ç´¢ç›¸å…³å†å²ä¼šè¯ (sqlite-vec ä½™å¼¦ç›¸ä¼¼åº¦)
  â†“
2. æå–å…³é”®å†³ç­–ç‚¹ (å·¥å…·è°ƒç”¨åºåˆ—ã€ä»£ç å˜æ›´)
  â†“
3. å»é™¤å†—ä½™ä¿¡æ¯ (é‡å¤å·¥å…·è°ƒç”¨ã€ä¸­é—´è¾“å‡º)
  â†“
4. æ„å»º Token é«˜æ•ˆçš„ä¸Šä¸‹æ–‡æ¨¡æ¿
  â†“
5. å®æ—¶ Token è®¡æ•° (tiktoken-rs)
  â†“
è¾“å‡º: enhancedPrompt + tokenStats
```

**è¾“å‡ºæ ¼å¼**ï¼š
```markdown
## Context from Previous Sessions

### Similar Problem #1: [ä¼šè¯æ‘˜è¦]
**Project**: é¡¹ç›®è·¯å¾„
**Solution**:
- ä½¿ç”¨å·¥å…·: [å·¥å…·åˆ—è¡¨]
- å…³é”®æ­¥éª¤: [æ­¥éª¤1, æ­¥éª¤2]
- ä»£ç å˜æ›´: [å…³é”®ä»£ç ç‰‡æ®µ]

### Current Task: [ç”¨æˆ·ç›®æ ‡]

Based on the above patterns, here's an enhanced prompt:
[ä¼˜åŒ–åçš„æç¤ºè¯]

---
ğŸ“Š Token Stats:
- Original: ~12,500 tokens
- Optimized: ~4,200 tokens (66% reduction)
- Estimated cost: $0.012
```

#### F4: å›¾å½¢ç”¨æˆ·ç•Œé¢

**æè¿°**ï¼šæä¾›ç›´è§‚çš„æ¡Œé¢ç•Œé¢å±•ç¤ºå’Œç®¡ç†ä¼šè¯ã€‚

**å­éœ€æ±‚**ï¼š
- **F4.1** ä¼šè¯åˆ—è¡¨è§†å›¾ï¼ˆè¡¨æ ¼/å¡ç‰‡ï¼Œæ”¯æŒæ’åºå’Œè¿‡æ»¤ï¼‰
- **F4.2** ä¸Šä¸‹æ–‡è¯¦æƒ…é¢æ¿ï¼ˆæ¶ˆæ¯æ ‘å¯è§†åŒ–ï¼‰
- **F4.3** æç¤ºè¯æ„å»ºå™¨ï¼ˆè¾“å…¥ç›®æ ‡ã€é¢„è§ˆç»“æœï¼‰
- **F4.4** å®æ—¶æ›´æ–°æŒ‡ç¤ºå™¨
- **F4.5** Diff é«˜äº®æ˜¾ç¤ºï¼ˆMonaco Editorï¼‰
- **F4.6** å®æ—¶ Token è®¡æ•°å™¨

**ç•Œé¢å¸ƒå±€**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Claude Code Session Monitor                    [_][â–¡][Ã—]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚              â”‚                                             â”‚
â”‚  ä¼šè¯åˆ—è¡¨    â”‚           ä¸Šä¸‹æ–‡è¯¦æƒ…                        â”‚
â”‚              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  ğŸ” æœç´¢...  â”‚  â”‚ Session: 3f118f45...                 â”‚    â”‚
â”‚              â”‚  â”‚ Project: C:\project\path            â”‚    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚    â”‚
â”‚  â”‚é¡¹ç›® A    â”‚â”‚  â”‚                                     â”‚    â”‚
â”‚  â”‚  ä¼šè¯1   â”‚â”‚  â”‚  ğŸ“‹ æ¶ˆæ¯æ ‘                          â”‚    â”‚
â”‚  â”‚  ä¼šè¯2   â”‚â”‚  â”‚  ğŸŒ¿ User: åˆ†æä»£ç ç»“æ„              â”‚    â”‚
â”‚  â”‚          â”‚â”‚  â”‚  ğŸŒ¿ Assistant: ä½¿ç”¨ Glob å·¥å…·       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚  ğŸŒ¿ Tool: è¿”å›æ–‡ä»¶åˆ—è¡¨              â”‚    â”‚
â”‚              â”‚  â”‚  ğŸŒ¿ Assistant: åˆ†æå®Œæˆ             â”‚    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚                                     â”‚    â”‚
â”‚  â”‚é¡¹ç›® B    â”‚â”‚  â”‚  ğŸ“ ä»£ç å¯¹æ¯” (Diff View)            â”‚    â”‚
â”‚  â”‚  ä¼šè¯3   â”‚â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚  â”‚- function oldMethod()      â”‚   â”‚    â”‚
â”‚              â”‚  â”‚  â”‚+ function newMethod()      â”‚   â”‚    â”‚
â”‚  ğŸ“Š ç»Ÿè®¡     â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  3 ä¸ªæ´»è·ƒ   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  12 ä¸ªå†å²  â”‚                                             â”‚
â”‚              â”‚  ğŸ¯ æç¤ºè¯ä¼˜åŒ–å™¨                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
                 â”‚ ç›®æ ‡: [è¾“å…¥æ¡†...]                     â”‚    â”‚
                 â”‚ Token: ~4,200 (66% â†“) ğŸ’° $0.012       â”‚    â”‚
                 â”‚                                          â”‚    â”‚
                 â”‚  [ç”Ÿæˆä¼˜åŒ–æç¤ºè¯]     [å¤åˆ¶] [ä¿å­˜]    â”‚    â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### F5: æ•°æ®æŒä¹…åŒ–

**æè¿°**ï¼šä½¿ç”¨ SQLite + sqlite-vec æ‰©å±•å­˜å‚¨ä¼šè¯ç´¢å¼•ã€å‘é‡å’Œä¼˜åŒ–ç»“æœã€‚

**å­éœ€æ±‚**ï¼š
- **F5.1** å­˜å‚¨ä¼šè¯å…ƒæ•°æ®ï¼ˆå¿«é€Ÿæ£€ç´¢ï¼‰
- **F5.2** å­˜å‚¨æ¶ˆæ¯ç´¢å¼•å’Œå‘é‡åµŒå…¥ï¼ˆè¯­ä¹‰æœç´¢ï¼‰
- **F5.3** ä¿å­˜ç”¨æˆ·ç”Ÿæˆçš„ä¼˜åŒ–æç¤ºè¯
- **F5.4** æ”¯æŒæ•°æ®å¯¼å‡ºï¼ˆJSON/CSV/Markdownï¼‰

### F6: LLM API ç®¡ç†ä¸­å¿ƒ

**æè¿°**ï¼šé›†æˆå¤šæ¨¡å‹ç®¡ç†é¢æ¿ï¼Œå…è®¸ç”¨æˆ·åˆ‡æ¢æ¨ç†åç«¯ï¼ˆä¸ä»…é™äº Claude Code é»˜è®¤æ¨¡å‹ï¼‰ï¼Œç”¨äºæ‰§è¡Œæç¤ºè¯ä¼˜åŒ–å’Œä»£ç è§£é‡Šä»»åŠ¡ã€‚

**å­éœ€æ±‚**ï¼š

- **F6.1 å¤šå‚å•†æ”¯æŒ**ï¼šæ”¯æŒé…ç½® OpenAI, Anthropic, Gemini, DeepSeek ä»¥åŠæœ¬åœ° Ollama/vLLMã€‚
- **F6.2 å¯†é’¥å®‰å…¨ç®¡ç†**ï¼šä½¿ç”¨ç³»ç»Ÿçº§å¯†é’¥åº“ (Windows Credential Manager) å­˜å‚¨ API Keyï¼Œè€Œéæ˜æ–‡å­˜æ•°æ®åº“ã€‚
- **F6.3 è‡ªå®šä¹‰å‚æ•°**ï¼šé’ˆå¯¹æ¯ä¸ªæ¨¡å‹å•ç‹¬é…ç½® `temperature`, `top_p`, `context_window`ã€‚
- **F6.4 ä»£ç†ä¸è·¯ç”±**ï¼šæ”¯æŒè‡ªå®šä¹‰ Base URL (ç”¨äºå…¼å®¹ OneAPI æˆ–ä¸­è½¬æœåŠ¡)ã€‚
- **F6.5 è¿æ¥æ€§æµ‹è¯•**ï¼šæä¾› "Check Connection" æŒ‰é’®éªŒè¯ API è¿é€šæ€§ã€‚

#### F7: å¤šé¡¹ç›®ä¸ä¼šè¯èµ„äº§ç®¡ç† (æ–°å¢ v1.3)

**æè¿°**ï¼šåŸºäºæ–‡ä»¶ç›®å½•ç»“æ„è‡ªåŠ¨èšåˆé¡¹ç›®ï¼Œå¹¶æä¾›å¯¹ä¼šè¯èµ„äº§çš„ç²¾ç»†åŒ–ç®¡ç†ã€‚

- **F7.1 è‡ªåŠ¨é¡¹ç›®èšåˆ**ï¼šæ‰«æ `~/.claude/projects/`ï¼Œå°†å­ç›®å½•è¯†åˆ«ä¸ºç‹¬ç«‹é¡¹ç›®ã€‚

- **F7.2 æ™ºèƒ½ä¸Šä¸‹æ–‡åˆ‡æ¢**ï¼šç”¨æˆ·åœ¨ä¾§è¾¹æ é€‰æ‹©é¡¹ç›®æ—¶ï¼Œè‡ªåŠ¨å®šä½å¹¶åŠ è½½è¯¥é¡¹ç›®ä¸‹â€œæœ€è¿‘ä¸€æ¬¡æ´»è·ƒâ€çš„ä¼šè¯ã€‚

- F7.3 ä¼šè¯è¯„åˆ†ä¸æ ‡ç­¾

  ï¼š

  - æ”¯æŒ 1-5 æ˜Ÿè¯„åˆ†ï¼ˆé«˜åˆ†ä¼šè¯å°†ä¼˜å…ˆç”¨äº RAG æ£€ç´¢ï¼‰ã€‚
  - æ”¯æŒæ·»åŠ æ ‡ç­¾ï¼ˆå¦‚ `bugfix`, `feature`, `refactor`ï¼‰ã€‚

- **F7.4 å½’æ¡£ç®¡ç†**ï¼šæ”¯æŒå°†ä¼šè¯æ ‡è®°ä¸ºâ€œå½’æ¡£â€ï¼Œä»æ´»è·ƒåˆ—è¡¨ç§»é™¤ä½†ä¿ç•™åœ¨æœç´¢ç´¢å¼•ä¸­ã€‚

#### F8: æ™ºèƒ½æ—¥å¿—æå–ä¸è§†å›¾ (æ–°å¢ v1.3)

**æè¿°**ï¼šæä¾›ä¸åŒé¢—ç²’åº¦çš„æ—¥å¿—æŸ¥çœ‹å’Œå¯¼å‡ºæ¨¡å¼ï¼Œä»¥åº”å¯¹ Token æˆæœ¬æ§åˆ¶å’Œä¸åŒé˜…è¯»åœºæ™¯ã€‚

- F8.1 è§†å›¾/æå–ç­‰çº§ (View Levels)

  ï¼š

  - **L1 - Full Trace**: åŒ…å«æ‰€æœ‰ Thinkingã€Tool Call å‚æ•°ã€å®Œæ•´ Outputï¼ˆè°ƒè¯•ç”¨ï¼‰ã€‚
  - **L2 - Clean Flow**: éšè—å·¥å…·è°ƒç”¨çš„å…·ä½“å‚æ•°å’Œä¸­é—´å†—ä½™è¾“å‡ºï¼Œä¿ç•™å†³ç­–æµï¼ˆé»˜è®¤è§†å›¾ï¼‰ã€‚
  - **L3 - Prompt Only**: ä»…æå– User Query å’Œ Assistant Final Answerï¼ˆç”¨äºæç‚¼ QA å¯¹ï¼‰ã€‚

- **F8.2 ç»“æ„åŒ–å¯¼å‡º**ï¼šæ”¯æŒå°†é€‰å®šç­‰çº§çš„å†…å®¹å¯¼å‡ºä¸º Markdown æˆ– JSONã€‚

#### F9: æç¤ºè¯å®éªŒå®¤ (Prompt Lab) (æ–°å¢ v1.3)

**æè¿°**ï¼šç»Ÿä¸€ç®¡ç†ç”Ÿæˆçš„æç¤ºè¯ã€ä¸‹ä¸€æ­¥ç›®æ ‡å’Œç³»ç»Ÿåˆ†ææ¨¡æ¿ã€‚

- F9.1 æç¤ºè¯åˆ†ç±»åº“

  ï¼š

  - **Next Goal**: ç”¨æˆ·è¾“å…¥çš„ä»»åŠ¡æè¿°ã€‚
  - **AI Analysis**: ç³»ç»Ÿç”Ÿæˆçš„ä¸Šä¸‹æ–‡åˆ†æç»“æœã€‚
  - **Meta Template**: ç”¨äºé©±åŠ¨æœ¬ç³»ç»Ÿè¿›è¡Œâ€œæ€»ç»“â€æˆ–â€œç”Ÿæˆâ€çš„åº•å±‚ Promptã€‚

- **F9.2 æç¤ºè¯è¯„åˆ†**ï¼šå¯¹ç”Ÿæˆçš„ Prompt è¿›è¡Œæ‰“åˆ†ï¼Œç”¨äºä¼˜åŒ–åç»­çš„æ¨èç®—æ³•ã€‚

- **F9.3 Meta-Prompt é…ç½®**ï¼šå…è®¸ç”¨æˆ·ä¿®æ”¹â€œåˆ†æä¼šè¯â€å’Œâ€œç”Ÿæˆä¼˜åŒ–æç¤ºè¯â€æ‰€ä½¿ç”¨çš„ç³»ç»Ÿæç¤ºè¯ï¼ˆå¦‚ï¼šâ€œä½ æ˜¯ä¸€ä¸ªèµ„æ·±æ¶æ„å¸ˆ...â€ï¼‰

### 2.2 éåŠŸèƒ½éœ€æ±‚

#### NF1: æ€§èƒ½è¦æ±‚

| æŒ‡æ ‡ | è¦æ±‚ | è¯´æ˜ |
|------|------|------|
| å¯åŠ¨æ—¶é—´ | < 3 ç§’ | ä»åŒå‡»åˆ°ç•Œé¢å¯äº¤äº’ |
| ä¼šè¯æ‰«æ | < 2 ç§’ | å®Œæˆ 100 ä¸ªä¼šè¯çš„åˆæ¬¡æ‰«æ |
| å®æ—¶æ›´æ–°å»¶è¿Ÿ | < 1 ç§’ | æ–‡ä»¶å˜æ›´åˆ°ç•Œé¢æ›´æ–° |
| å‘é‡æ£€ç´¢ | < 100ms | 1000+ ä¼šè¯ä¸­æ£€ç´¢ Top-5 |
| å†…å­˜å ç”¨ | < 150 MB | ç©ºé—²çŠ¶æ€å¸¸é©»å†…å­˜ |
| CPU å ç”¨ | < 5% | ç©ºé—²çŠ¶æ€ |

#### NF2: å¯é æ€§è¦æ±‚

- **ç¨³å®šæ€§**ï¼šè¿ç»­è¿è¡Œ 24 å°æ—¶æ— å´©æºƒ
- **æ•°æ®å®Œæ•´æ€§**ï¼šå¼‚å¸¸å…³é—­ä¸ä¸¢å¤±å·²è§£ææ•°æ®
- **é”™è¯¯æ¢å¤**ï¼šæŸåçš„ä¼šè¯æ–‡ä»¶ä¸å½±å“å…¶ä»–åŠŸèƒ½
- **å¹¶å‘è¯»å–**ï¼šæ”¯æŒä¸ Claude Code åŒæ—¶è¯»å†™æ–‡ä»¶ï¼ˆFileShare æ¨¡å¼ï¼‰

#### NF3: å®‰å…¨æ€§è¦æ±‚

- **æœ¬åœ°å­˜å‚¨**ï¼šæ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨æœ¬åœ°ï¼Œä¸ä¸Šä¼ äº‘ç«¯
- **æƒé™æœ€å°åŒ–**ï¼šä»…è¯»å– `~/.claude/` ç›®å½•
- **æ•°æ®è„±æ•**ï¼šè¯†åˆ«å¹¶é®è”½æ•æ„Ÿä¿¡æ¯ï¼ˆAPI Keyã€å¯†ç ï¼‰

#### NF4: å…¼å®¹æ€§è¦æ±‚

- **æ“ä½œç³»ç»Ÿ**ï¼šWindows 10 1903+ / Windows 11
- **æ¶æ„**ï¼šx64
- **Claude Code ç‰ˆæœ¬**ï¼š2.0.x

#### NF5: æ‰©å±•æ€§éœ€æ±‚

- **æ¶æ„è§£è€¦**ï¼šè™½ç„¶ç›®å‰ä»…æ”¯æŒ Claude Codeï¼Œä½†ç³»ç»Ÿè®¾è®¡åº”é‡‡ç”¨ **Trait-based Parser** æ¨¡å¼ï¼Œæœªæ¥å¯æ’ä»¶åŒ–æ”¯æŒ Cursor (`.cursor/rules`) æˆ–å…¶ä»–å·¥å…·ï¼Œè€Œä¸å¿…é‡æ„æ ¸å¿ƒé€»è¾‘ã€‚

### 

---

## 3. æŠ€æœ¯é€‰å‹

### 3.1 æ€»ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Presentation Layer                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              React + TypeScript                     â”‚   â”‚
â”‚  â”‚  â€¢ UI Components (shadcn/ui + TailwindCSS)        â”‚   â”‚
â”‚  â”‚  â€¢ Monaco Editor (ä»£ç å¯¹æ¯”)                         â”‚   â”‚
â”‚  â”‚  â€¢ State Management (Zustand)                       â”‚   â”‚
â”‚  â”‚  â€¢ Data Fetching (React Query)                      â”‚   â”‚
â”‚  â”‚  â€¢ Token Counter (tiktoken)                         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ Tauri IPC (invoke)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         â”‚          Business Layer           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚              Rust Backend (Tauri)                   â”‚   â”‚
â”‚  â”‚  â€¢ Session Monitor (æ–‡ä»¶ç›‘æ§ + FileShare)          â”‚   â”‚
â”‚  â”‚  â€¢ JSONL Parser (å¢é‡è§£æ + ç¼“å†²åŒºå¤„ç†)            â”‚   â”‚
â”‚  â”‚  â€¢ Context Builder (æ ‘é‡æ„)                         â”‚   â”‚
â”‚  â”‚  â€¢ Embedding Generator (å‘é‡åŒ–)                     â”‚   â”‚
â”‚  â”‚  â€¢ Prompt Optimizer (å‘é‡æ£€ç´¢ + ç®—æ³•å¼•æ“)          â”‚   â”‚
â”‚  â”‚  â€¢ File Reader (offset seek)                        â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ SQL + Vector
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         â”‚        Persistence Layer         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   SQLite + sqlite-vec (å‘é‡æ‰©å±•)                    â”‚   â”‚
â”‚  â”‚  â€¢ sessions (ä¼šè¯å…ƒæ•°æ®)                             â”‚   â”‚
â”‚  â”‚  â€¢ messages (æ¶ˆæ¯ç´¢å¼• + å‘é‡)                        â”‚   â”‚
â”‚  â”‚  â€¢ message_embeddings (å‘é‡å­˜å‚¨)                    â”‚   â”‚
â”‚  â”‚  â€¢ prompts (ä¼˜åŒ–å†å²)                                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æŠ€æœ¯æ ˆå¯¹æ¯”

#### 3.2.1 æ¡†æ¶é€‰å‹

| æ–¹æ¡ˆ | ä¼˜åŠ¿ | åŠ£åŠ¿ | è¯„åˆ† |
|------|------|------|------|
| **Tauri 2.0** | â€¢ ä½“ç§¯å° (~5MB)<br>â€¢ æ€§èƒ½é«˜ (Rust)<br>â€¢ å®‰å…¨æ€§å¥½ | â€¢ ç”Ÿæ€è¾ƒæ–°<br>â€¢ éœ€è¦å­¦ä¹  Rust | â­â­â­â­â­ |
| Electron | â€¢ æˆç†Ÿç”Ÿæ€<br>â€¢ Web æŠ€æœ¯æ ˆ | â€¢ ä½“ç§¯å¤§ (~200MB)<br>â€¢ å†…å­˜å ç”¨é«˜ | â­â­â­ |
| Qt (Python) | â€¢ åŸç”Ÿæ€§èƒ½ | â€¢ UI å¼€å‘å¤æ‚<br>â€¢ æ‰“åŒ…ä½“ç§¯å¤§ | â­â­â­ |
| .NET WPF | â€¢ Windows åŸç”Ÿ | â€¢ ä¸è·¨å¹³å°<br>â€¢ UI æŠ€æœ¯é™ˆæ—§ | â­â­ |

**é€‰æ‹©ç†ç”±**ï¼šTauri 2.0 åœ¨ä½“ç§¯ã€æ€§èƒ½ã€å®‰å…¨æ€§ä¸Šä¼˜åŠ¿æ˜æ˜¾ï¼Œé€‚åˆæœ¬é¡¹ç›®çš„ç›‘æ§åœºæ™¯ã€‚

#### 3.2.2 å‰ç«¯æŠ€æœ¯æ ˆ

```json
{
  "framework": "React 18.2",
  "language": "TypeScript 5.3",
  "bundling": "Vite 5.0",
  "ui_library": "shadcn/ui + TailwindCSS",
  "state_management": "Zustand 4.4",
  "data_fetching": "@tanstack/react-query 5.0",
  "editor": "@monaco-editor/react 4.6",
  "diff_viewer": "react-diff-viewer-continued",
  "date_library": "date-fns 3.0",
  "icons": "lucide-react 0.300"
}
```

**æ–°å¢ç»„ä»¶è¯´æ˜**ï¼š
- **Monaco Editor**ï¼šVSCode åŒæ¬¾ç¼–è¾‘å™¨ï¼Œæ”¯æŒä»£ç é«˜äº®å’Œ Diff å¯¹æ¯”
- **react-diff-viewer-continued**ï¼šä¸“ä¸šçš„ Git é£æ ¼ä»£ç å¯¹æ¯”ç»„ä»¶
- **tiktoken å‰ç«¯ç»‘å®š**ï¼šå®æ—¶ Token è®¡æ•°

#### 3.2.3 åç«¯æŠ€æœ¯æ ˆ

```toml
[dependencies]
tauri = { version = "2.0", features = ["shell-open"] }
tokio = { version = "1.35", features = ["full"] }
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
rusqlite = { version = "0.30", features = ["bundled"] }
sqlite-vec = { version = "0.5" }  # æ–°å¢ï¼šå‘é‡æ‰©å±•
notify = "6.1"
regex = "1.10"
chrono = { version = "0.4", features = ["serde"] }
uuid = { version = "1.6", features = ["v4", "serde"] }
thiserror = "1.0"
anyhow = "1.0"
reqwest = { version = "0.11", features = ["json", "stream"] }
keyring = "2.3"             # è·¨å¹³å°å¯†é’¥åº“ç®¡ç†
secrecy = "0.8"             # é˜²æ­¢æ—¥å¿—æ„å¤–æ‰“å°å¯†é’¥
async-openai = "0.18"       # ç¤¾åŒºæˆç†Ÿçš„ OpenAI å®¢æˆ·ç«¯ SDK

# æ–°å¢ä¾èµ–
fastembed = "3.3"           # æœ¬åœ°åµŒå…¥æ¨¡å‹
tiktoken-rs = "0.1"         # Token è®¡æ•°
memmap2 = "0.9"             # å†…å­˜æ˜ å°„æ–‡ä»¶
```

**æ–°å¢ä¾èµ–è¯´æ˜**ï¼š
- **sqlite-vec**ï¼šSQLite å‘é‡ç›¸ä¼¼åº¦æœç´¢æ‰©å±•
- **fastembed**ï¼šçº¯ Rust çš„æœ¬åœ°åµŒå…¥æ¨¡å‹ï¼ˆæ— éœ€å¤–éƒ¨ APIï¼‰
- **tiktoken-rs**ï¼šOpenAI Tiktoken çš„ Rust å®ç°
- **memmap2**ï¼šé«˜æ•ˆçš„å†…å­˜æ˜ å°„æ–‡ä»¶è¯»å–

#### 3.2.4 å‘é‡æ•°æ®åº“é€‰å‹

| æ–¹æ¡ˆ | ä¼˜åŠ¿ | åŠ£åŠ¿ | é€‚ç”¨åœºæ™¯ |
|------|------|------|---------|
| **SQLite + sqlite-vec** | â€¢ é›¶é…ç½®<br>â€¢ å†…åµŒå¼<br>â€¢ SQL é›†æˆ | â€¢ éœ€è¦ç¼–è¯‘æ‰©å±• | âœ… æœ¬åœ°å‘é‡æ£€ç´¢ |
| pgvector | â€¢ åŠŸèƒ½å¼ºå¤§ | â€¢ éœ€è¦ PostgreSQL | âŒ è¿‡åº¦è®¾è®¡ |
| Qdrant | â€¢ ä¸“ä¸šå‘é‡æ•°æ®åº“ | â€¢ å¤–éƒ¨æœåŠ¡ | âŒ å¢åŠ å¤æ‚åº¦ |
| lancedb | â€¢ çº¯ Python | â€¢ Python ç”Ÿæ€ | âŒ éæœ¬åº”ç”¨ |

**é€‰æ‹©ç†ç”±**ï¼šsqlite-vec ç›´æ¥é›†æˆåˆ° SQLiteï¼Œæ— å¤–éƒ¨ä¾èµ–ï¼Œå®Œç¾åŒ¹é…æœ¬åœ°çš„è¯­ä¹‰æ£€ç´¢éœ€æ±‚ã€‚

### 3.3 å…³é”®æŠ€æœ¯ç‚¹

#### 3.3.1 å¢é‡ JSONL è§£æï¼ˆå¢å¼ºç‰ˆ - FileShare + ç¼“å†²åŒºï¼‰

```rust
use std::io::{BufReader, SeekFrom};
use std::fs::OpenOptions;
use windows::Win32::Storage::FileSystem::{FILE_SHARE_READ, FILE_SHARE_WRITE};

struct JsonlParser {
    file_path: PathBuf,
    last_offset: u64,
    session_id: String,
    buffer: String,  // æ–°å¢ï¼šå¤„ç†æœªå†™å®Œçš„è¡Œ
}

impl JsonlParser {
    fn open_shared(path: &Path) -> Result<std::fs::File> {
        // Windows FileShare æ¨¡å¼ï¼šå…è®¸å¹¶å‘è¯»å†™
        OpenOptions::new()
            .read(true)
            .custom_flags(FILE_SHARE_READ.0 | FILE_SHARE_WRITE.0)
            .open(path)
    }

    /// å¢é‡è§£æï¼Œå¤„ç†æœªå®Œæˆçš„è¡Œ
    fn parse_incremental(&mut self) -> Result<Vec<Message>> {
        let mut file = Self::open_shared(&self.file_path)?;
        file.seek(SeekFrom::Start(self.last_offset))?;

        let mut reader = BufReader::new(file);
        let mut new_messages = Vec::new();
        let mut incomplete_line = self.buffer.clone();

        loop {
            let mut line = String::new();
            let bytes_read = reader.read_line(&mut line)?;

            if bytes_read == 0 {
                // æ–‡ä»¶ç»“æŸï¼Œä¿å­˜æœªå®Œæˆçš„è¡Œ
                self.buffer = incomplete_line;
                break;
            }

            let full_line = if incomplete_line.is_empty() {
                line
            } else {
                format!("{}{}", incomplete_line, line)
            };

            match serde_json::from_str::<Message>(&full_line) {
                Ok(msg) => {
                    new_messages.push(msg);
                    self.last_offset = reader.stream_position()?;
                    incomplete_line = String::new();
                }
                Err(_) if full_line.ends_with('\n') => {
                    // å®Œæ•´çš„è¡Œä½†è§£æå¤±è´¥ï¼Œè·³è¿‡
                    incomplete_line = String::new();
                    self.last_offset = reader.stream_position()?;
                }
                Err(_) => {
                    // æœªå®Œæˆçš„è¡Œï¼Œç­‰å¾…ä¸‹æ¬¡å˜æ›´
                    incomplete_line = full_line;
                }
            }
        }

        Ok(new_messages)
    }

    /// ç›´æ¥ä» offset è¯»å–å•ä¸ªæ¶ˆæ¯
    fn read_message_at(&self, offset: u64, length: u64) -> Result<Message> {
        let mut file = Self::open_shared(&self.file_path)?;
        file.seek(SeekFrom::Start(offset))?;

        let mut buffer = vec![0u8; length as usize];
        file.read_exact(&mut buffer)?;

        let text = String::from_utf8(buffer)?;
        Ok(serde_json::from_str(&text)?)
    }
}
```

#### 3.3.2 æ¶ˆæ¯æ ‘é‡æ„ï¼ˆä¸å˜ï¼‰

```rust
use std::collections::HashMap;

struct MessageTreeBuilder {
    nodes: HashMap<String, MessageNode>,
    roots: Vec<String>,
}

impl MessageTreeBuilder {
    fn insert(&mut self, msg: Message) {
        let uuid = msg.uuid.clone();
        let parent = msg.parent_uuid.clone();

        self.nodes.insert(uuid.clone(), MessageNode {
            uuid,
            parent,
            children: Vec::new(),
            data: msg,
        });

        if let Some(parent_uuid) = parent {
            if let Some(parent_node) = self.nodes.get_mut(&parent_uuid) {
                parent_node.children.push(uuid);
            }
        } else {
            self.roots.push(uuid);
        }
    }

    fn build(self) -> Vec<MessageNode> {
        self.roots.into_iter()
            .filter_map(|uuid| self.nodes.remove(&uuid))
            .collect()
    }
}
```

#### 3.3.3 å‘é‡åµŒå…¥ç”Ÿæˆ

```rust
use fastembed::{EmbeddingModel, InitOptions};

struct EmbeddingGenerator {
    model: EmbeddingModel,
}

impl EmbeddingGenerator {
    fn new() -> Result<Self> {
        let model = EmbeddingModel::try_new(InitOptions {
            model_name: fastembed::EmbeddingModelName::BGESmallENV15Quantized,
            ..Default::default()
        })?;
        Ok(Self { model })
    }

    fn generate_for_message(&self, content: &str) -> Result<Vec<f32>> {
        self.model.embed(content, None)
    }

    fn generate_batch(&self, contents: &[String]) -> Result<Vec<Vec<f32>>> {
        self.model.embed(contents, None)
    }
}
```

#### 3.3.4 Token è®¡æ•°

```rust
use tiktoken_rs::tiktoken::cl100k_base;

fn count_tokens(text: &str) -> Result<usize> {
    let bpe = cl100k_base()?;
    let tokens = bpe.encode_with_special_tokens(text)?;
    Ok(tokens.len())
}

fn estimate_cost(tokens: usize) -> f64 {
    // GPT-4 Turbo å®šä»· (æ¯ç™¾ä¸‡ tokens)
    let input_cost = 0.01;  // $0.01 per 1M
    let output_cost = 0.03; // $0.03 per 1M

    let per_token_cost = (input_cost + output_cost) / 2_000_000.0;
    tokens as f64 * per_token_cost
}
```

#### 3.3.5 Tauri IPC é€šä¿¡ï¼ˆå¢å¼ºç‰ˆï¼‰

```rust
// Rust åç«¯
#[tauri::command]
async fn get_session_context(
    session_id: String,
    state: State<'_, AppState>,
) -> Result<SessionContext, String> {
    state.monitor
        .get_context(&session_id)
        .await
        .map_err(|e| e.to_string())
}

#[tauri::command]
async fn get_message_at_offset(
    session_id: String,
    offset: u64,
    length: u64,
    state: State<'_, AppState>,
) -> Result<Message, String> {
    state.parser
        .read_message_at(&session_id, offset, length)
        .map_err(|e| e.to_string())
}

#[tauri::command]
async fn optimize_prompt(
    goal: String,
    session_ids: Vec<String>,
    state: State<'_, AppState>,
) -> Result<EnhancedPrompt, String> {
    state.optimizer
        .optimize(goal, session_ids)
        .await
        .map_err(|e| e.to_string())
}

#[tauri::command]
async fn count_prompt_tokens(
    prompt: String,
) -> Result<TokenStats, String> {
    let tokens = count_tokens(&prompt).map_err(|e| e.to_string())?;
    Ok(TokenStats {
        count: tokens,
        estimated_cost: estimate_cost(tokens),
    })
}
```

```typescript
// React å‰ç«¯
import { invoke } from '@tauri-apps/api/core';

const context = await invoke<SessionContext>('get_session_context', {
  sessionId: '3f118f45-...'
});

// æŒ‰éœ€åŠ è½½æ¶ˆæ¯å†…å®¹
const message = await invoke<Message>('get_message_at_offset', {
  sessionId: '3f118f45-...',
  offset: 12345,
  length: 678
});

const enhanced = await invoke<EnhancedPrompt>('optimize_prompt', {
  goal: 'å®ç°ç”¨æˆ·è®¤è¯åŠŸèƒ½',
  sessionIds: ['3f118f45...', '6d9b16dc...']
});

// Token è®¡æ•°
const stats = await invoke<TokenStats>('count_prompt_tokens', {
  prompt: enhanced.enhancedPrompt
});
console.log(`Tokens: ${stats.count}, Cost: $${stats.estimatedCost.toFixed(4)}`);
```

---

## 4. ç³»ç»Ÿæ¶æ„è®¾è®¡

### 4.1 æ¨¡å—åˆ’åˆ†

```
src-tauri/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.rs                    # å…¥å£ï¼ŒTauri åˆå§‹åŒ–
â”‚   â”œâ”€â”€ lib.rs                     # åº“å¯¼å‡º
â”‚   â”œâ”€â”€ error.rs                   # é”™è¯¯ç±»å‹å®šä¹‰
â”‚   â”‚
â”‚   â”œâ”€â”€ monitor/                   # ä¼šè¯ç›‘æ§æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ scanner.rs             # ä¼šè¯æ‰«æ
â”‚   â”‚   â”œâ”€â”€ watcher.rs             # æ–‡ä»¶å˜æ›´ç›‘æ§
â”‚   â”‚   â””â”€â”€ collector.rs           # ä¼šè¯æ•°æ®æ”¶é›†
â”‚   â”‚
â”‚   â”œâ”€â”€ parser/                    # è§£ææ¨¡å—
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ jsonl.rs               # JSONL è§£æ (FileShare + ç¼“å†²åŒº)
â”‚   â”‚   â”œâ”€â”€ tree.rs                # æ¶ˆæ¯æ ‘æ„å»º
â”‚   â”‚   â”œâ”€â”€ extractor.rs           # ä¿¡æ¯æå–
â”‚   â”‚   â””â”€â”€ reader.rs              # Offset æ–‡ä»¶è¯»å–å™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ database/                  # æ•°æ®åº“æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ connection.rs          # SQLite + sqlite-vec è¿æ¥
â”‚   â”‚   â”œâ”€â”€ models.rs              # æ•°æ®æ¨¡å‹
â”‚   â”‚   â”œâ”€â”€ migrations.rs          # è¿ç§»è„šæœ¬
â”‚   â”‚   â”œâ”€â”€ vector.rs              # å‘é‡ç´¢å¼•ç®¡ç†
â”‚   â”‚   â””â”€â”€ repository.rs          # æ•°æ®è®¿é—®å±‚
â”‚   â”‚
â”‚   â”œâ”€â”€ embedding/                 # åµŒå…¥æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â””â”€â”€ generator.rs           # å‘é‡ç”Ÿæˆå™¨
â”‚   â”‚
â”‚   â”œâ”€â”€ parser/
â”‚   â”‚   â”œâ”€â”€ trait.rs               # å®šä¹‰ SessionParser æ¥å£ (æ‰©å±•æ€§)
â”‚   â”‚   â”œâ”€â”€ claude_code.rs         # Claude Code å®ç°
â”‚   â”‚   â””â”€â”€ extractor.rs           # æ–°å¢ï¼šæ—¥å¿—ç­‰çº§æå–å¼•æ“
â”‚   â”‚
â”‚   â”œâ”€â”€ knowledge/                 # æ–°å¢ï¼šçŸ¥è¯†åº“æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ project_manager.rs     # é¡¹ç›®èšåˆé€»è¾‘
â”‚   â”‚   â””â”€â”€ rating_system.rs       # è¯„åˆ†ä¸æƒé‡è®¡ç®—
â”‚   â”‚
â”‚   â”œâ”€â”€ optimizer/                 # æç¤ºè¯ä¼˜åŒ–æ¨¡å—
â”‚   â”‚   â”œâ”€â”€ mod.rs
â”‚   â”‚   â”œâ”€â”€ analyzer.rs            # ä¸Šä¸‹æ–‡åˆ†æ
â”‚   â”‚   â”œâ”€â”€ compressor.rs          # ä¸Šä¸‹æ–‡å‹ç¼©
â”‚   â”‚   â”œâ”€â”€ retriever.rs           # å‘é‡æ£€ç´¢
â”‚   â”‚   â”œâ”€â”€ generator.rs           # æç¤ºè¯ç”Ÿæˆ
â”‚   â”‚   â”œâ”€â”€ rag_engine.rs          # è¯„åˆ†åŠ æƒçš„æ£€ç´¢å¼•æ“
â”‚   â”‚   â””â”€â”€ meta_prompt.rs         # Meta-Prompt ç®¡ç†
â”‚   â”‚
â”‚   â””â”€â”€ commands.rs                # Tauri å‘½ä»¤å®šä¹‰
â”‚
â””â”€â”€ Cargo.toml
```

### 4.2 æ•°æ®æµè®¾è®¡ï¼ˆå¢å¼ºç‰ˆ - é‡ç´¢å¼•è½»å­˜å‚¨ï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    scan     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    parse    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ~/.claude/  â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚   Scanner   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€> â”‚   Parser    â”‚
â”‚  projects/  â”‚             â”‚             â”‚            â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                                                               â”‚
                        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                        â”‚                                  â†“
                        â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                        â”‚                          â”‚ Embedding   â”‚
                        â”‚                          â”‚  Generator  â”‚
                        â”‚                          â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                        â”‚                                 â”‚
                        â†“                                 â†“
                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                  â”‚  Database   â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚   VecData   â”‚
                  â”‚  (SQLite)   â”‚                 â”‚             â”‚
                  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
        â†“                â†“                â†“
  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â”‚ UI List  â”‚   â”‚Retriever â”‚   â”‚ Optimizerâ”‚
  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
                      â”‚              â”‚
                      â†“              â†“
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚Vector   â”‚    â”‚Enhanced    â”‚
                â”‚Search   â”‚    â”‚Prompt      â”‚
                â”‚(vec0)   â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â†“
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚ JSONL File Seek â”‚
            â”‚   (æŒ‰éœ€åŠ è½½)      â”‚
            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å…³é”®å˜åŒ–**ï¼š
1. **Messages è¡¨ä¸å†å­˜å‚¨ content_json**ï¼Œåªå­˜å‚¨ç´¢å¼•å’Œå‘é‡
2. **æ–°å¢ message_embeddings è¡¨**å­˜å‚¨å‘é‡
3. **è§£ææ—¶ç”Ÿæˆ embedding**ï¼Œå­˜å…¥æ•°æ®åº“
4. **æ£€ç´¢æ—¶ä½¿ç”¨ sqlite-vec** è¿›è¡Œå‘é‡ç›¸ä¼¼åº¦æœç´¢
5. **å‰ç«¯éœ€è¦è¯¦æƒ…æ—¶**ï¼Œé€šè¿‡ offset ç›´æ¥ä» JSONL æ–‡ä»¶ seek è¯»å–

### 4.3 æ¥å£è®¾è®¡

#### 4.3.1 Tauri Commandsï¼ˆå¢å¼ºç‰ˆï¼‰

| å‘½ä»¤ | è¾“å…¥ | è¾“å‡º | æè¿° |
|------|------|------|------|
| `scan_sessions` | - | `Vec<SessionMeta>` | æ‰«ææ‰€æœ‰ä¼šè¯ |
| `get_session` | `sessionId: string` | `SessionDetail` | è·å–ä¼šè¯è¯¦æƒ… |
| `search_sessions` | `query: string, limit: number` | `Vec<SessionMatch>` | å‘é‡è¯­ä¹‰æœç´¢ä¼šè¯ |
| `get_messages_page` | `sessionId: string, offset: number, limit: number` | `MessagePage` | åˆ†é¡µè·å–æ¶ˆæ¯ |
| `get_message_at` | `sessionId: string, offset: number, length: number` | `Message` | æŒ‰ä½ç½®è¯»å–å•æ¡æ¶ˆæ¯ |
| `get_context` | `sessionId: string` | `SessionContext` | è·å–ç»“æ„åŒ–ä¸Šä¸‹æ–‡ |
| `optimize_prompt` | `goal: string, sessionIds: string[]` | `EnhancedPrompt` | ç”Ÿæˆä¼˜åŒ–æç¤ºè¯ |
| `count_tokens` | `text: string` | `TokenStats` | è®¡ç®— Token æ•°é‡ |
| `export_session` | `sessionId: string, format: string` | `string` | å¯¼å‡ºä¼šè¯ |

#### 4.3.2 æ•°æ®æ¨¡å‹ï¼ˆå¢å¼ºç‰ˆï¼‰

```typescript
// ä¼šè¯å…ƒæ•°æ®
interface SessionMeta {
  sessionId: string;
  projectPath: string;
  createdAt: string;
  updatedAt: string;
  messageCount: number;
  isActive: boolean;
}

// ä¼šè¯è¯¦æƒ…
interface SessionDetail extends SessionMeta {
  duration: number;
  toolCalls: number;
  errors: number;
  lastMessages: MessageHeader[];  // åªåŒ…å«å¤´éƒ¨ä¿¡æ¯
}

// æ¶ˆæ¯å¤´éƒ¨ï¼ˆç´¢å¼•ä¿¡æ¯ï¼‰
interface MessageHeader {
  uuid: string;
  parentUuid: string | null;
  type: 'user' | 'assistant' | 'tool';
  timestamp: string;
  offset: number;      // åœ¨ JSONL æ–‡ä»¶ä¸­çš„å­—èŠ‚åç§»
  length: number;      // JSON å¯¹è±¡çš„å­—èŠ‚é•¿åº¦
  summary: string;     // å†…å®¹æ‘˜è¦
}

// å®Œæ•´æ¶ˆæ¯ï¼ˆæŒ‰éœ€åŠ è½½ï¼‰
interface Message extends MessageHeader {
  content: MessageContent;
}

// æ¶ˆæ¯èŠ‚ç‚¹
interface MessageNode {
  uuid: string;
  parentUuid: string | null;
  type: 'user' | 'assistant' | 'tool';
  timestamp: string;
  content: MessageContent;
  children: MessageNode[];
  metadata: MessageMetadata;
}

// ä¼šè¯ä¸Šä¸‹æ–‡
interface SessionContext {
  sessionId: string;
  projectPath: string;
  messageTree: MessageNode[];
  summary: ContextSummary;
  keyDecisions: DecisionPoint[];
  codeChanges: CodeChange[];
}

// ä¼˜åŒ–ç»“æœï¼ˆå¢å¼ºç‰ˆï¼‰
interface EnhancedPrompt {
  originalGoal: string;
  referencedSessions: SessionReference[];
  enhancedPrompt: string;
  tokenStats: {
    original: number;
    optimized: number;
    reduction: number;  // ç™¾åˆ†æ¯”
    estimatedCost: number;
  };
  confidence: number;
}

// Token ç»Ÿè®¡
interface TokenStats {
  count: number;
  estimatedCost: number;
}

// å‘é‡æœç´¢ç»“æœ
interface SessionMatch {
  sessionId: string;
  projectPath: string;
  similarity: number;  // 0-1
  summary: string;
}
```

---

## 5. æ•°æ®åº“è®¾è®¡ï¼ˆå¢å¼ºç‰ˆï¼‰

### 5.1 ER å›¾ï¼ˆæ›´æ–°ç‰ˆï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     sessions     â”‚       â”‚    messages     â”‚       â”‚    message_embeddings      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)          â”‚â”€â”€â”    â”‚ id (PK)          â”‚â”€â”€â”    â”‚ id (PK)                    â”‚
â”‚ session_id (UQ)  â”‚  â”‚    â”‚ session_id (FK)  â”‚  â”‚    â”‚ message_id (FK)            â”‚
â”‚ project_path     â”‚  â”‚    â”‚ uuid (UQ)        â”‚  â”‚    â”‚ embedding (BLOB)            â”‚
â”‚ file_path        â”‚  â”‚    â”‚ parent_uuid      â”‚  â”‚    â”‚ summary                     â”‚
â”‚ created_at       â”‚  â”‚    â”‚ type             â”‚  â”‚    â”‚ created_at                  â”‚
â”‚ updated_at       â”‚  â”‚    â”‚ timestamp        â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ message_count    â”‚  â”‚    â”‚ offset (NEW)     â”‚  â”‚
â”‚ is_active        â”‚  â”‚    â”‚ length (NEW)     â”‚  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚ summary (NEW)    â”‚  â”‚
                       â”‚    â”‚ parent_idx       â”‚  â”‚
                       â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                       â”‚                           â”‚
                       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                       â”‚    â”‚     prompts      â”‚   â”‚
                       â”‚    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚
                       â”‚    â”‚ id (PK)          â”‚   â”‚
                       â”‚    â”‚ session_id (FK)  â”‚â—„â”€â”€â”˜
                       â”‚    â”‚ original_goal    â”‚
                       â”‚    â”‚ enhanced_prompt  â”‚
                       â”‚    â”‚ token_stats      â”‚
                       â”‚    â”‚ created_at       â”‚
                       â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 è¡¨ç»“æ„ï¼ˆæ›´æ–°ç‰ˆï¼‰

#### sessions

```sql
CREATE TABLE sessions (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id      TEXT NOT NULL UNIQUE,
    project_path    TEXT NOT NULL,
    project_name    TEXT NOT NULL,    -- æ–°å¢ï¼šä¾¿äºåˆ†ç»„æŸ¥è¯¢
    file_path       TEXT NOT NULL,
    
    -- èµ„äº§ç®¡ç†å­—æ®µ
    rating          INTEGER DEFAULT 0, -- 0(æœªè¯„), 1-5(æ˜Ÿçº§)
    tags            TEXT,              -- JSON Array: ["bugfix", "v1.0"]
    is_archived     INTEGER DEFAULT 0, -- 1=å½’æ¡£
    is_active       INTEGER DEFAULT 1, -- æ–‡ä»¶ç³»ç»Ÿå±‚é¢çš„æ´»è·ƒçŠ¶æ€
    
    created_at      TEXT NOT NULL,
    updated_at      TEXT NOT NULL
);
CREATE INDEX idx_sessions_project ON sessions(project_name, updated_at DESC);
CREATE INDEX idx_sessions_rating ON sessions(rating DESC);
```

#### messagesï¼ˆè½»é‡åŒ–å­˜å‚¨ï¼‰

```sql
CREATE TABLE messages (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id      TEXT NOT NULL,
    uuid            TEXT NOT NULL UNIQUE,
    parent_uuid     TEXT,
    type            TEXT NOT NULL,  -- 'user' | 'assistant' | 'tool'
    timestamp       TEXT NOT NULL,

    -- æ–°å¢ï¼šè½»é‡åŒ–å­˜å‚¨
    offset          INTEGER NOT NULL,  -- JSONL æ–‡ä»¶ä¸­çš„å­—èŠ‚åç§»
    length          INTEGER NOT NULL,  -- JSON å¯¹è±¡çš„å­—èŠ‚é•¿åº¦
    summary         TEXT NOT NULL,     -- å†…å®¹æ‘˜è¦ï¼ˆç”¨äºåˆ—è¡¨æ˜¾ç¤ºï¼‰

    parent_idx      INTEGER,           -- åœ¨çˆ¶æ¶ˆæ¯ä¸­çš„ä½ç½®

    FOREIGN KEY (session_id) REFERENCES sessions(session_id) ON DELETE CASCADE,

    -- ç´¢å¼•
    idx_messages_session_uuid (session_id, uuid),
    idx_messages_parent_uuid (parent_uuid),
    idx_messages_timestamp (timestamp DESC)
);
```

**å…³é”®å˜åŒ–**ï¼š
- âŒ ç§»é™¤ `content_json`ï¼šä¸å†å­˜å‚¨å®Œæ•´å†…å®¹
- âœ… æ–°å¢ `offset` + `length`ï¼šè®°å½•æ–‡ä»¶ä½ç½®
- âœ… æ–°å¢ `summary`ï¼šå­˜å‚¨æ‘˜è¦ç”¨äºå±•ç¤º

#### message_embeddingsï¼ˆå‘é‡è¡¨ï¼‰

```sql
-- å¯ç”¨ sqlite-vec æ‰©å±•
SELECT load_extension('vec0');

CREATE VIRTUAL TABLE message_embeddings USING vec0(
    embedding FLOAT(384)  -- BGE-small å‘é‡ç»´åº¦
);

CREATE TABLE message_metadata (
    message_id   INTEGER PRIMARY KEY,
    message_uuid TEXT NOT NULL UNIQUE,
    session_id   TEXT NOT NULL,
    summary      TEXT,
    created_at   TEXT NOT NULL,

    FOREIGN KEY (message_id) REFERENCES messages(id)
);

-- å…³è”å‘é‡ä¸å…ƒæ•°æ®
-- sqlite-vec è‡ªåŠ¨åˆ›å»ºå†…éƒ¨ç´¢å¼•
```

#### saved_prompts

```sql
CREATE TABLE saved_prompts (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    session_id      TEXT,              -- å¯ä¸ºç©ºï¼ˆé€šç”¨æ¨¡æ¿ï¼‰
    
    -- åˆ†ç±»ç®¡ç†
    category        TEXT NOT NULL,     -- 'next_goal', 'analysis_result', 'system_gen'
    title           TEXT NOT NULL,     -- æ ‡é¢˜/æ‘˜è¦
    content         TEXT NOT NULL,
    
    -- è¯„ä¼°ä¸åé¦ˆ
    rating          INTEGER DEFAULT 0, -- ç”¨æˆ·æ‰“åˆ†
    usage_count     INTEGER DEFAULT 0, -- å¼•ç”¨æ¬¡æ•°
    
    tokens          INTEGER,           -- Token è®¡æ•°ç¼“å­˜
    created_at      TEXT NOT NULL
);
```

#### api_providers

```sql
CREATE TABLE api_providers (
    id              INTEGER PRIMARY KEY AUTOINCREMENT,
    provider_type   TEXT NOT NULL,  -- 'openai', 'anthropic', 'ollama', 'azure'
    name            TEXT NOT NULL,  -- æ˜¾ç¤ºåç§°ï¼Œå¦‚ "My Company Proxy"
    base_url        TEXT,           -- è‡ªå®šä¹‰ API ç«¯ç‚¹
    api_key_ref     TEXT,           -- ä»…å­˜å‚¨å¯†é’¥å¼•ç”¨IDï¼Œå®é™…Keyå­˜ç³»ç»Ÿé’¥åŒ™ä¸²
    
    -- æ¨¡å‹å‚æ•°é…ç½® (JSON å­˜å‚¨ä»¥é€‚åº”ä¸åŒå‚å•†çš„ç‰¹æ®Šå­—æ®µ)
    config_json     TEXT DEFAULT '{}', 
    
    is_active       INTEGER DEFAULT 0,
    created_at      TEXT NOT NULL
);

-- ç¤ºä¾‹ config_json:
-- {
--   "model_list": ["gpt-4-turbo", "claude-3-opus"],
--   "default_model": "gpt-4-turbo",
--   "temperature": 0.7,
--   "max_tokens": 4096
-- }
```

#### meta_templates

```sql
CREATE TABLE meta_templates (
    id          INTEGER PRIMARY KEY AUTOINCREMENT,
    key         TEXT NOT NULL UNIQUE,  -- e.g., 'optimizer_system_prompt'
    name        TEXT NOT NULL,         -- e.g., "Default Optimizer"
    content     TEXT NOT NULL,         -- å®é™…çš„ System Prompt
    description TEXT,
    is_active   INTEGER DEFAULT 1,
    updated_at  TEXT NOT NULL
);
-- åˆå§‹åŒ–æ•°æ®ï¼šæ’å…¥é»˜è®¤çš„åˆ†æä¸ä¼˜åŒ– Prompt
```



### 5.3 æ•°æ®è¯»å–æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     è¯»å–ä¼šè¯æ¶ˆæ¯æµç¨‹                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  1. å‰ç«¯è¯·æ±‚æ¶ˆæ¯åˆ—è¡¨                                        â”‚
â”‚     â”œâ”€> invoke('get_messages_page', { sessionId, limit }) â”‚
â”‚     â”‚                                                         â”‚
â”‚  2. åç«¯æŸ¥è¯¢æ•°æ®åº“                                          â”‚
â”‚     â”œâ”€> SELECT uuid, type, timestamp, summary, offset       â”‚
â”‚     â”‚        FROM messages WHERE session_id = ?            â”‚
â”‚     â”‚        ORDER BY timestamp LIMIT 20                    â”‚
â”‚     â”‚                                                         â”‚
â”‚  3. è¿”å›æ¶ˆæ¯å¤´éƒ¨ï¼ˆè½»é‡ï¼‰                                    â”‚
â”‚     â””â”€> [{ uuid, type, summary, offset, length }, ...]     â”‚
â”‚                                                             â”‚
â”‚  4. ç”¨æˆ·å±•å¼€æ¶ˆæ¯è¯¦æƒ…                                        â”‚
â”‚     â”œâ”€> invoke('get_message_at', { sessionId, offset, length }) â”‚
â”‚     â”‚                                                         â”‚
â”‚  5. åç«¯ä» JSONL æ–‡ä»¶ seek è¯»å–                              â”‚
â”‚     â”œâ”€> file.seek(SeekFrom::Start(offset))                  â”‚
â”‚     â”œâ”€> file.read_exact(length, buffer)                     â”‚
â”‚     â”œâ”€> let msg: Message = serde_json::from_slice(&buffer)? â”‚
â”‚     â””â”€> è¿”å›å®Œæ•´æ¶ˆæ¯                                         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.4 å‘é‡æ£€ç´¢æµç¨‹

```rust
use sqlite_vec::sqlite3_vec;

async fn search_similar_sessions(
    db: &Connection,
    query_embedding: &[f32],
    limit: usize,
) -> Result<Vec<SessionMatch>> {
    let query_vec = serde_json::to_string(query_embedding)?;

    let sql = r#"
        SELECT
            s.session_id,
            s.project_path,
            m.summary,
            distance(embedding, ?) AS similarity
        FROM message_embeddings me
        JOIN message_metadata mm ON me.rowid = mm.rowid
        JOIN messages m ON m.uuid = mm.message_uuid
        JOIN sessions s ON s.session_id = m.session_id
        ORDER BY similarity
        LIMIT ?
    "#;

    let mut stmt = db.prepare(sql)?;
    let matches = stmt.query_map(
        [&query_vec, &limit],
        |row| {
            Ok(SessionMatch {
                sessionId: row.get(1)?,
                projectPath: row.get(2)?,
                summary: row.get(3)?,
                similarity: 1.0 - row.get::<f64, _>(4)?,  // è½¬æ¢ä½™å¼¦è·ç¦»
            })
        },
    )?.collect()?;

    Ok(matches)
}
```

### 5.5 Rust æ•°æ®æ¨¡å‹ï¼ˆæ›´æ–°ç‰ˆï¼‰

```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Session {
    pub id: i64,
    pub session_id: String,
    pub project_path: String,
    pub file_path: String,
    pub created_at: chrono::DateTime<chrono::Utc>,
    pub updated_at: chrono::DateTime<chrono::Utc>,
    pub message_count: i64,
    pub is_active: bool,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Message {
    pub id: i64,
    pub session_id: String,
    pub uuid: String,
    pub parent_uuid: Option<String>,
    pub r#type: MessageType,
    pub timestamp: chrono::DateTime<chrono::Utc>,
    pub offset: u64,      // æ–°å¢ï¼šæ–‡ä»¶åç§»
    pub length: u64,      // æ–°å¢ï¼šå†…å®¹é•¿åº¦
    pub summary: String,  // æ–°å¢ï¼šæ‘˜è¦
    pub parent_idx: Option<i32>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub enum MessageType {
    User,
    Assistant,
    Tool,
}
```

---

## 6. æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 6.1 ä¼šè¯ç›‘æ§å™¨ (SessionMonitor)

```rust
use notify::{Watcher, RecursiveMode, RecommendedWatcher, event::ModifyKind};
use std::sync::Arc;
use tokio::sync::mpsc;

pub struct SessionMonitor {
    watcher: RecommendedWatcher,
    db: Arc<Database>,
    tx: mpsc::Sender<MonitorEvent>,
    parser: Arc<Mutex<JsonlParser>>,
}

impl SessionMonitor {
    pub fn new(db: Arc<Database>) -> Result<Self> {
        let (tx, rx) = mpsc::channel(1000);

        let mut watcher = notify::recommended_watcher({
            let tx = tx.clone();
            move |res: notify::Result<notify::Event>| {
                if let Ok(event) = res {
                    let _ = tx.blocking_send(MonitorEvent::FileChanged(event));
                }
            }
        })?;

        watcher.watch(
            Path::new(&format!("{}/.claude/projects", env::var("USERPROFILE")?)),
            RecursiveMode::Recursive
        )?;

        Ok(Self {
            watcher,
            db,
            tx,
            parser: Arc::new(Mutex::new(JsonlParser::new())),
        })
    }

    pub async fn scan(&self) -> Result<Vec<Session>> {
        let claude_dir = PathBuf::from(format!(
            "{}/.claude/projects",
            env::var("USERPROFILE")?
        ));

        let entries: Vec<_> = glob::glob(
            claude_dir.join("**/*.jsonl").to_str().unwrap()
        )?
        .filter_map(Result::ok)
        .collect();

        let mut sessions = Vec::new();
        for entry in entries {
            if let Ok(session) = self.parse_session_file(&entry).await {
                sessions.push(session);
            }
        }

        Ok(sessions)
    }

    async fn watch_loop(&self) {
        let mut rx = self.tx.subscribe();
        while let Ok(event) = rx.recv().await {
            match event {
                MonitorEvent::FileChanged(event) => {
                    if event.kind.is_modify() || event.kind.is_create() {
                        for path in event.paths {
                            if path.extension() == Some("jsonl".into()) {
                                self.handle_file_change(path).await;
                            }
                        }
                    }
                }
                _ => {}
            }
        }
    }

    async fn handle_file_change(&self, path: PathBuf) {
        let mut parser = self.parser.lock().await;
        match parser.parse_incremental(&path) {
            Ok(new_messages) => {
                for msg in new_messages {
                    // ç”ŸæˆåµŒå…¥
                    let embedding = self.db.embedding_gen
                        .generate_for_message(&msg.summary)
                        .await?;

                    // å­˜å‚¨åˆ°æ•°æ®åº“
                    self.db.insert_message(&msg, &embedding).await;
                }
            }
            Err(e) => {
                eprintln!("Parse error for {:?}: {}", path, e);
            }
        }
    }
}

pub enum MonitorEvent {
    FileChanged(notify::Event),
    SessionDiscovered(Session),
    SessionUpdated(String),
}
```

### 6.2 æç¤ºè¯ä¼˜åŒ–å™¨ (PromptOptimizer - å¢å¼ºç‰ˆ)

```rust
pub struct PromptOptimizer {
    db: Arc<Database>,
    retriever: ContextRetriever,
    compressor: ContextCompressor,
    tokenizer: TokenCounter,
}

impl PromptOptimizer {
    pub async fn optimize(
        &self,
        goal: &str,
        session_ids: &[String],
    ) -> Result<EnhancedPrompt> {
        // 1. å‘é‡æ£€ç´¢ç›¸å…³å†å²ä¼šè¯
        let goal_embedding = self.db.embedding_gen
            .generate_for_message(goal)
            .await?;

        let relevant_sessions = self.retriever
            .vector_search(&goal_embedding, 5)
            .await?;

        // 2. æŒ‰éœ€åŠ è½½ä¸Šä¸‹æ–‡ï¼ˆä½¿ç”¨ offsetï¼‰
        let contexts: Vec<_> = futures::future::join_all(
            session_ids.iter()
                .chain(relevant_sessions.iter().map(|s| &s.session_id))
                .map(|id| self.load_context_lazy(id))
        ).await;

        // 3. å‹ç¼©ä¸Šä¸‹æ–‡
        let compressed = self.compressor.compress(&contexts)?;

        // 4. ç”Ÿæˆä¼˜åŒ–æç¤ºè¯
        let enhanced = self.generate(goal, &compressed)?;

        // 5. Token ç»Ÿè®¡
        let original_tokens = self.tokenizer.count(goal)?;
        let optimized_tokens = self.tokenizer.count(&enhanced)?;
        let original_cost = self.tokenizer.estimate_cost(original_tokens);
        let optimized_cost = self.tokenizer.estimate_cost(optimized_tokens);

        Ok(EnhancedPrompt {
            original_goal: goal.to_string(),
            referenced_sessions: session_ids.to_vec(),
            enhanced_prompt: enhanced,
            token_stats: TokenStats {
                original: original_tokens,
                optimized: optimized_tokens,
                reduction: ((original_tokens - optimized_tokens) as f64 / original_tokens as f64 * 100.0),
                estimated_cost: optimized_cost,
            },
            confidence: self.calculate_confidence(&compressed),
        })
    }

    /// æŒ‰éœ€åŠ è½½ä¸Šä¸‹æ–‡ï¼ˆåªè¯»å–éœ€è¦çš„æ¶ˆæ¯ï¼‰
    async fn load_context_lazy(&self, session_id: &str) -> Result<SessionContext> {
        // ä»æ•°æ®åº“è¯»å–æ¶ˆæ¯ç´¢å¼•
        let headers = self.db.get_message_headers(session_id).await?;

        // æŒ‰éœ€è¯»å–å®Œæ•´æ¶ˆæ¯ï¼ˆä½¿ç”¨ offsetï¼‰
        let mut messages = Vec::new();
        for header in headers {
            let full_message = self.db.read_message_at_offset(
                session_id,
                header.offset,
                header.length
            ).await?;
            messages.push(full_message);
        }

        // æ„å»ºæ¶ˆæ¯æ ‘
        let tree = self.build_message_tree(messages)?;
        Ok(SessionContext { /* ... */ })
    }
}
```

### 6.3 æ–‡ä»¶è¯»å–å™¨

```rust
use std::fs::OpenOptions;
use std::io::{Read, Seek, SeekFrom};
use windows::Win32::Storage::FileSystem::{CreateFileW, FILE_SHARE_READ, FILE_SHARE_WRITE, GENERIC_READ, OPEN_EXISTING};

pub struct JsonlReader {
    file_path: PathBuf,
}

impl JsonlReader {
    /// ä½¿ç”¨ FileShare æ¨¡å¼æ‰“å¼€æ–‡ä»¶ï¼ˆé¿å…é”å®šï¼‰
    fn open_shared(path: &Path) -> Result<std::fs::File> {
        // Windows ç‰¹å®šçš„æ‰“å¼€æ–¹å¼
        use std::os::windows::fs::OpenOptionsExt;

        OpenOptions::new()
            .read(true)
            .share_mode(0x3)  // FILE_SHARE_READ | FILE_SHARE_WRITE
            .open(path)
            .or_else(|_| {
                // é™çº§åˆ°æ™®é€šæ¨¡å¼
                OpenOptions::new().read(true).open(path)
            })
    }

    /// ä»æŒ‡å®šåç§»è¯»å–æ¶ˆæ¯
    pub fn read_at(&self, offset: u64, length: u64) -> Result<Message> {
        let mut file = Self::open_shared(&self.file_path)?;
        file.seek(SeekFrom::Start(offset))?;

        let mut buffer = vec![0u8; length as usize];
        file.read_exact(&mut buffer)?;

        let text = String::from_utf8(buffer)?;
        Ok(serde_json::from_str(&text)?)
    }

    /// æµå¼è§£æï¼ˆå¸¦ç¼“å†²åŒºå¤„ç†ï¼‰
    pub fn parse_incremental(&self, last_offset: u64) -> Result<(Vec<Message>, u64, String)> {
        let mut file = Self::open_shared(&self.file_path)?;
        file.seek(SeekFrom::Start(last_offset))?;

        let mut reader = BufReader::new(file);
        let mut messages = Vec::new();
        let mut current_offset = last_offset;
        let mut incomplete_line = String::new();

        loop {
            let mut line = String::new();
            let bytes_read = reader.read_line(&mut line)?;

            if bytes_read == 0 {
                break;
            }

            let full_line = if incomplete_line.is_empty() {
                line
            } else {
                format!("{}{}", incomplete_line, line)
            };

            match serde_json::from_str::<Message>(&full_line) {
                Ok(msg) => {
                    messages.push(msg);
                    current_offset = reader.stream_position()?;
                    incomplete_line = String::new();
                }
                Err(_) if !line.ends_with('\n') => {
                    // æœªå®Œæˆçš„è¡Œï¼Œä¿ç•™ç­‰å¾…ä¸‹æ¬¡
                    incomplete_line = full_line;
                }
                Err(_) => {
                    // è·³è¿‡æ— æ•ˆè¡Œ
                    current_offset = reader.stream_position()?;
                }
            }
        }

        Ok((messages, current_offset, incomplete_line))
    }
}
```

### 6.4 LLM å®¢æˆ·ç«¯ç®¡ç†å™¨ (LLMClientManager) 

å‚è€ƒ `Chatbox` çš„ Rust å®ç°ï¼Œä½¿ç”¨ `reqwest` å¤„ç† HTTP è¯·æ±‚ï¼Œå¹¶é€šè¿‡ `keyring` crate å®‰å…¨å­˜å‚¨å¯†é’¥ã€‚

```rust
// src-tauri/src/llm/client.rs

use reqwest::Client;
use keyring::Entry; // ç”¨äºå®‰å…¨å­˜å‚¨ API Key[ 4 (https://vertexaisearch.cloud.google.com/grounding-api-redirect/AUZIYQGP8Z6Yy81irClSogA1T6n8p-RszON-v8oyJ6jV9-rE5IsBPa8DcP9aEc6bySN1f46Ha8Pes0NfCAnGtDxjKBqi9SP75XQjCA4Qro2L88UqQ4FH7bjNcdPfYIzQew8OJFkFDbh0Mlk=)]

pub struct LLMClientManager {
    http_client: Client,
    active_provider: Option<ProviderConfig>,
}

impl LLMClientManager {
    /// ä»ç³»ç»Ÿå‡­æ®ç®¡ç†å™¨è·å– Keyï¼Œä¸è½åœ°åˆ°ç£ç›˜
    pub fn get_secure_key(provider_id: &str) -> Result<String> {
        let entry = Entry::new("claude-session-monitor", provider_id)?;
        entry.get_password().map_err(|e| e.into())
    }

    /// è®¾ç½®æ–°çš„ Key
    pub fn set_secure_key(provider_id: &str, key: &str) -> Result<()> {
        let entry = Entry::new("claude-session-monitor", provider_id)?;
        entry.set_password(key).map_err(|e| e.into())
    }
    
    /// é€šç”¨å¯¹è¯æ¥å£ï¼ˆé€‚é…ä¸åŒå‚å•†ï¼‰
    pub async fn chat_completion(&self, messages: Vec<Message>, params: ModelParams) -> Result<StreamResponse> {
        match self.active_provider.type {
            ProviderType::OpenAI => self.openai_chat(messages, params).await,
            ProviderType::Anthropic => self.anthropic_chat(messages, params).await,
            ProviderType::Ollama => self.ollama_chat(messages, params).await,
        }
    }
}
```

### 6.1 åŠ æƒå‘é‡æ£€ç´¢ (Weighted RAG)

åœ¨æ£€ç´¢å†å²ä¸Šä¸‹æ–‡æ—¶ï¼Œä¸å†ä»…ä»…ä¾èµ–æ–‡æœ¬ç›¸ä¼¼åº¦ï¼Œè€Œæ˜¯ç»“åˆâ€œç›¸ä¼¼åº¦â€ä¸â€œä¼šè¯è¯„åˆ†â€ã€‚

```rust
// src-tauri/src/optimizer/rag_engine.rs

pub async fn search_best_practices(&self, query_vec: &[f32]) -> Result<Vec<SessionMatch>> {
    // æ··åˆè¯„åˆ†å…¬å¼ï¼š
    // Score = (CosineSimilarity * 0.7) + (NormalizedRating * 0.3)
    // ç›®çš„ï¼šå³ä½¿ç›¸ä¼¼åº¦ç¨ä½ï¼Œå¦‚æœæ˜¯ 5 æ˜Ÿçš„é«˜è´¨é‡è§£å†³æ¡ˆä¾‹ï¼Œä¹Ÿåº”è¢«æå‡æ’å
    
    let sql = r#"
        SELECT 
            s.session_id, 
            s.project_name,
            m.summary,
            distance(me.embedding, ?) AS vec_dist,
            s.rating
        FROM message_embeddings me
        JOIN message_metadata mm ON me.rowid = mm.rowid
        JOIN messages m ON m.uuid = mm.message_uuid
        JOIN sessions s ON s.session_id = m.session_id
        WHERE 
            s.is_archived = 0       -- æ’é™¤å½’æ¡£
            AND s.rating >= 2       -- æ’é™¤ä½åˆ†/å¤±è´¥çš„ä¼šè¯
        ORDER BY 
            ( (1.0 - distance(me.embedding, ?)) * 0.7 + (IFNULL(s.rating, 2.5)/5.0 * 0.3) ) DESC
        LIMIT 5
    "#;
    
    // ... æ‰§è¡ŒæŸ¥è¯¢ ...
}
```

### 6.2 æ—¥å¿—æå–å¼•æ“ (Extraction Engine)

å¤„ç†ä¸åŒç­‰çº§çš„æ—¥å¿—è§†å›¾ã€‚

```rust
// src-tauri/src/parser/extractor.rs

pub enum ExtractionLevel {
    Full,    // æ‰€æœ‰å†…å®¹
    Clean,   // è¿‡æ»¤ ToolInput/Outputï¼Œä¿ç•™ ToolName å’Œ ResultSummary
    Compact, // ä»… User Query å’Œ Assistant Final Answer
}

impl ExtractionEngine {
    pub fn extract(&self, nodes: &[MessageNode], level: ExtractionLevel) -> String {
        match level {
            ExtractionLevel::Full => self.render_full(nodes),
            ExtractionLevel::Clean => {
                nodes.iter()
                    .filter(|n| n.type != "tool_input" && n.type != "tool_output") 
                    // æ³¨æ„ï¼šå®é™…é€»è¾‘æ›´å¤æ‚ï¼Œéœ€è¦ä¿ç•™å·¥å…·è°ƒç”¨çš„â€œæ„å›¾â€èŠ‚ç‚¹
                    .map(|n| self.render_node(n))
                    .collect()
            },
            ExtractionLevel::Compact => {
                // ä»…æå–æ ¹èŠ‚ç‚¹(User)å’Œå¶å­èŠ‚ç‚¹(Final Answer)
                // ...
            }
        }
    }
}
```



---

## 7. UI/UX è®¾è®¡

### 7.1 ç»„ä»¶ç»“æ„

```
src/
â”œâ”€â”€ App.tsx
â”œâ”€â”€ pages/
â”‚   â”œâ”€â”€ Dashboard.tsx           # ä¸»ä»ªè¡¨ç›˜
â”‚   â””â”€â”€ SessionDetail.tsx       # ä¼šè¯è¯¦æƒ…é¡µ
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ SessionList.tsx         # ä¼šè¯åˆ—è¡¨
â”‚   â”œâ”€â”€ SessionCard.tsx         # ä¼šè¯å¡ç‰‡
â”‚   â”œâ”€â”€ MessageTree.tsx         # æ¶ˆæ¯æ ‘
â”‚   â”œâ”€â”€ DiffViewer.tsx          # ä»£ç å¯¹æ¯”è§†å›¾
â”‚   â”œâ”€â”€ PromptBuilder.tsx       # æç¤ºè¯æ„å»ºå™¨
â”‚   â”œâ”€â”€ TokenCounter.tsx        # Token è®¡æ•°å™¨
â”‚   â””â”€â”€ VectorSearch.tsx        # å‘é‡æœç´¢
â””â”€â”€ hooks/
    â”œâ”€â”€ useSessionMonitor.ts    # å®æ—¶ç›‘æ§
    â”œâ”€â”€ useVectorSearch.ts     # å‘é‡æ£€ç´¢
    â””â”€â”€ useTokenizer.ts        # Token è®¡æ•°
```

### 7.2 å…³é”®ç»„ä»¶

#### 7.2.1 ä»£ç å¯¹æ¯”è§†å›¾

```tsx
import ReactDiffViewer, { DiffMethod } from 'react-diff-viewer-continued';

interface DiffViewerProps {
  oldValue: string;
  newValue: string;
  language?: string;
}

export function DiffViewer({ oldValue, newValue, language = 'typescript' }: DiffViewerProps) {
  return (
    <ReactDiffViewer
      oldValue={oldValue}
      newValue={newValue}
      splitView={true}
      useDarkTheme={true}
      compareMethod={DiffMethod.WORDS}
      leftTitle="Original"
      rightTitle="Modified"
      language={language}
      styles={{
        line: { fontSize: '13px' },
        contentText: { fontSize: '13px' },
        diffContainer: { height: '100%' }
      }}
    />
  );
}
```

#### 7.2.2 Token è®¡æ•°å™¨

```tsx
import { invoke } from '@tauri-apps/api/core';
import { useQuery } from '@tanstack/react-query';

interface TokenCounterProps {
  text: string;
}

export function TokenCounter({ text }: TokenCounterProps) {
  const { data: stats } = useQuery({
    queryKey: ['countTokens', text],
    queryFn: () => invoke<TokenStats>('count_tokens', { text }),
    enabled: text.length > 0,
  });

  if (!stats) return null;

  return (
    <div className="flex items-center gap-4 text-sm">
      <div className="flex items-center gap-1">
        <span className="text-muted-foreground">Tokens:</span>
        <span className="font-mono font-bold">{stats.count.toLocaleString()}</span>
      </div>
      <div className="flex items-center gap-1">
        <span className="text-muted-foreground">Est. Cost:</span>
        <span className="font-mono text-green-600">${stats.estimatedCost.toFixed(4)}</span>
      </div>
    </div>
  );
}
```

#### 7.2.3 æç¤ºè¯æ„å»ºå™¨

```tsx
export function PromptBuilder() {
  const [goal, setGoal] = useState('');
  const [selectedSessions, setSelectedSessions] = useState<string[]>([]);
  const [result, setResult] = useState<EnhancedPrompt | null>(null);
  const [isGenerating, setIsGenerating] = useState(false);

  const handleGenerate = async () => {
    setIsGenerating(true);
    try {
      const enhanced = await invoke<EnhancedPrompt>('optimize_prompt', {
        goal,
        sessionIds: selectedSessions,
      });
      setResult(enhanced);
    } finally {
      setIsGenerating(false);
    }
  };

  return (
    <div className="space-y-4">
      <Textarea
        placeholder="æè¿°ä½ æƒ³è¦å®ç°çš„åŠŸèƒ½..."
        value={goal}
        onChange={(e) => setGoal(e.target.value)}
        rows={3}
      />

      {result && (
        <TokenCounter text={result.enhancedPrompt} />
      )}

      <div className="flex gap-2">
        <Button onClick={handleGenerate} disabled={!goal || isGenerating}>
          {isGenerating && <Loader2 className="animate-spin mr-2" />}
          ç”Ÿæˆä¼˜åŒ–æç¤ºè¯
        </Button>
        {result && (
          <>
            <Button variant="outline" onClick={() => copyToClipboard(result.enhancedPrompt)}>
              å¤åˆ¶
            </Button>
            <Button variant="outline" onClick={() => savePrompt(result)}>
              ä¿å­˜
            </Button>
          </>
        )}
      </div>

      {result && (
        <div className="space-y-4">
          <div className="rounded-lg border p-4">
            <pre className="whitespace-pre-wrap">{result.enhancedPrompt}</pre>
          </div>

          <div className="grid grid-cols-3 gap-4 text-center">
            <div>
              <div className="text-2xl font-bold">{result.tokenStats.original.toLocaleString()}</div>
              <div className="text-sm text-muted-foreground">åŸå§‹ Tokens</div>
            </div>
            <div>
              <div className="text-2xl font-bold text-green-600">
                {result.tokenStats.optimized.toLocaleString()}
              </div>
              <div className="text-sm text-muted-foreground">
                ä¼˜åŒ– Tokens ({result.tokenStats.reduction.toFixed(0)}% â†“)
              </div>
            </div>
            <div>
              <div className="text-2xl font-bold text-green-600">
                ${(result.tokenStats.estimated_cost * (1 - result.tokenStats.reduction / 100)).toFixed(4)}
              </div>
              <div className="text-sm text-muted-foreground">
                èŠ‚çœè´¹ç”¨ ({result.tokenStats.reduction.toFixed(0)}%)
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
```

### 7.3 è®¾ç½®æ¨¡å— (SettingsView)

å‚è€ƒ **NextChat** çš„å¸ƒå±€ï¼Œè®¾è®¡ä¾§è¾¹æ æˆ–æ¨¡æ€æ¡†å½¢å¼çš„è®¾ç½®é¡µã€‚

```tsx
// src/components/settings/ProviderSettings.tsx

import { useForm } from "react-hook-form";
import { Select, Input, Slider, Switch } from "@/components/ui";

export function ProviderSettings() {
  const { providers, activeId, updateProvider } = useSettingsStore();
  
  return (
    <div className="space-y-6 p-4">
      <div className="flex items-center justify-between">
        <h2 className="text-lg font-bold">Model Provider</h2>
        <Select 
          value={activeId} 
          options={['OpenAI', 'Anthropic', 'Ollama']} 
        />
      </div>

      {/* åŠ¨æ€è¡¨å•åŒºåŸŸ */}
      <div className="border rounded-lg p-4 bg-secondary/20">
        <FormItem label="API Key">
          <Input 
            type="password" 
            placeholder="sk-..." 
            // å®é™…ä¸Šä¼šè°ƒç”¨ Rust å‘½ä»¤ save_api_key
          />
        </FormItem>
        
        <FormItem label="Base URL (Optional)">
          <Input placeholder="https://api.openai.com/v1" />
        </FormItem>

        <div className="grid grid-cols-2 gap-4">
           <FormItem label="Temperature">
             <Slider min={0} max={2} step={0.1} />
           </FormItem>
           <FormItem label="Max Tokens">
             <Input type="number" />
           </FormItem>
        </div>
      </div>

      {/* æœ¬åœ°æ¨¡å‹ç‰¹åˆ«æ£€æµ‹ */}
      {activeId === 'Ollama' && (
        <div className="flex items-center gap-2 text-sm text-yellow-600">
           <AlertTriangle size={16} />
           <span>Ensure Ollama is running on http://127.0.0.1:11434</span>
           <Button variant="ghost" size="sm">Check Status</Button>
        </div>
      )}
    </div>
  );
}
```

### 7.4 ä¾§è¾¹æ  (Sidebar) - é¡¹ç›®è§†å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ğŸ“‚ My-Web-Project    â”‚ <--- è‡ªåŠ¨èšåˆçš„é¡¹ç›®å¤´
â”‚    â”œâ”€ fix-login-bug  â”‚ <--- Session (æ˜¾ç¤ºæœ€è¿‘æ›´æ–°)
â”‚    â””â”€ add-user-api   â”‚
â”‚                      â”‚
â”‚ ğŸ“‚ Rust-Backend      â”‚
â”‚    â””â”€ impl-database  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.5 æç¤ºè¯å®éªŒå®¤ (Prompt Lab)

è¿™æ˜¯ä¸€ä¸ªæ–°çš„é¡¶çº§ Tab é¡µé¢ã€‚

- å·¦æ  (Library)

  :

  - Tabs: `Next Goals` | `Analysis` | `Meta Templates`
  - List: å¡ç‰‡åˆ—è¡¨ï¼Œæ˜¾ç¤º Rating (â­â­â­â­â­) å’Œ Usage Countã€‚

- å³æ  (Workbench)

  :

  - **Editor**: ç¼–è¾‘é€‰ä¸­çš„ Promptã€‚
  - **Test Run**: è°ƒç”¨ LLM API (ä½¿ç”¨ v1.2 çš„ API Manager) è¿›è¡Œæµ‹è¯•ã€‚
  - **Rating**: æµ‹è¯•åæ‰‹åŠ¨æ‰“åˆ†ã€‚

### 7.6 ä¼šè¯è¯¦æƒ…é¡µ - å¢å¼ºå·¥å…·æ 

åœ¨æ¶ˆæ¯æ ‘ä¸Šæ–¹å¢åŠ å·¥å…·æ ï¼š

- **Rate this Session**: `[â˜† â˜† â˜† â˜† â˜†]`
- **View Mode**: `[ Dropdown: Full / Clean / Compact ]`
- **Export**: `[ Export to Markdown ]`

---

## 8. å¼€å‘è®¡åˆ’ï¼ˆæ›´æ–°ç‰ˆï¼‰

### 8.1 æ—¶é—´è¡¨ (5 å‘¨ - å¢åŠ å‘é‡æ£€ç´¢å’Œ UI å¢å¼º)

```
ç¬¬ 1 å‘¨ï¼šåŸºç¡€æ¶æ„æ­å»º
â”œâ”€â”€ Day 1-2: é¡¹ç›®åˆå§‹åŒ–
â”‚   â”œâ”€â”€ Tauri é¡¹ç›®æ­å»º
â”‚   â”œâ”€â”€ å¼€å‘ç¯å¢ƒé…ç½®
â”‚   â””â”€â”€ åŸºç¡€ UI æ¡†æ¶
â”‚
â”œâ”€â”€ Day 3-4: æ•°æ®åº“å±‚ï¼ˆå¢å¼ºï¼‰
â”‚   â”œâ”€â”€ SQLite + sqlite-vec é›†æˆ
â”‚   â”œâ”€â”€ è¡¨ç»“æ„å’Œè¿ç§»ï¼ˆè½»é‡åŒ–ï¼‰
â”‚   â””â”€â”€ å‘é‡ç´¢å¼•åˆå§‹åŒ–
â”‚
â””â”€â”€ Day 5-7: ä¼šè¯æ‰«ææ¨¡å—
    â”œâ”€â”€ JSONL è§£æå™¨
    â”œâ”€â”€ æ¶ˆæ¯æ ‘æ„å»º
    â””â”€â”€ Offset ç´¢å¼•å­˜å‚¨

ç¬¬ 2 å‘¨ï¼šæ ¸å¿ƒåŠŸèƒ½å¼€å‘
â”œâ”€â”€ Day 8-10: å®æ—¶ç›‘æ§ï¼ˆå¢å¼ºï¼‰
â”‚   â”œâ”€â”€ æ–‡ä»¶ç›‘æ§é›†æˆ
â”‚   â”œâ”€â”€ FileShare æ¨¡å¼å®ç°
â”‚   â”œâ”€â”€ é›†æˆ `keyring` åº“ï¼Œå®ç° Tauri Command `save_api_key` / `get_api_key`
â”‚   â”œâ”€â”€ æ­å»ºè®¾ç½®é¡µé¢ UIï¼Œå®ç°ä¸åŒå‚å•†è¡¨å•å­—æ®µçš„åŠ¨æ€åˆ‡æ¢
â”‚   â””â”€â”€ ç¼“å†²åŒºå¤„ç†é€»è¾‘
â”‚
â”œâ”€â”€ Day 11-12: UI å¼€å‘
â”‚   â”œâ”€â”€ ä¼šè¯åˆ—è¡¨ç»„ä»¶
â”‚   â”œâ”€â”€ è¯¦æƒ…é¢æ¿
â”‚   â”œâ”€â”€ å°è£…ç»Ÿä¸€çš„ LLM è¯·æ±‚å±‚ï¼ˆRust traitï¼‰ï¼Œæ‰“é€š `Optimization` æ¨¡å—è°ƒç”¨è‡ªå®šä¹‰ LLM çš„é“¾è·¯
â”‚   â””â”€â”€ çŠ¶æ€ç®¡ç†
â”‚
â””â”€â”€ Day 13-14: å‘é‡åµŒå…¥
    â”œâ”€â”€ fastembed é›†æˆ
    â”œâ”€â”€ æ‰¹é‡åµŒå…¥ç”Ÿæˆ
    â””â”€â”€ å‘é‡å­˜å‚¨ä¼˜åŒ–

ç¬¬ 3 å‘¨ï¼šå‘é‡æ£€ç´¢ä¸ä¼˜åŒ–
â”œâ”€â”€ Day 15-17: å‘é‡æ£€ç´¢
â”‚   â”œâ”€â”€ sqlite-vec æŸ¥è¯¢ä¼˜åŒ–
â”‚   â”œâ”€â”€ ä½™å¼¦ç›¸ä¼¼åº¦å®ç°
â”‚   â””â”€â”€ æ··åˆæ£€ç´¢ç­–ç•¥
â”‚
â”œâ”€â”€ Day 18-19: æç¤ºè¯æ„å»ºå™¨ UI
â”‚   â”œâ”€â”€ è¾“å…¥ç»„ä»¶
â”‚   â”œâ”€â”€ ç»“æœé¢„è§ˆ
â”‚   â””â”€â”€ å†å²è®°å½•
â”‚
â””â”€â”€ Day 20-21: ä¸Šä¸‹æ–‡å‹ç¼©
    â”œâ”€â”€ å†—ä½™ä¿¡æ¯å»é™¤
    â”œâ”€â”€ Token ä¼˜åŒ–ç®—æ³•
    â””â”€â”€ æ¨¡æ¿ç”Ÿæˆ

ç¬¬ 4 å‘¨ï¼šUI/UX å¢å¼º
â”œâ”€â”€ Day 22-24: ä»£ç å¯¹æ¯”è§†å›¾
â”‚   â”œâ”€â”€ Monaco Editor é›†æˆ
â”‚   â”œâ”€â”€ react-diff-viewer é…ç½®
â”‚   â””â”€â”€ Diff é«˜äº®æ¸²æŸ“
â”‚
â”œâ”€â”€ Day 25-26: Token è®¡æ•°å™¨
â”‚   â”œâ”€â”€ tiktoken-rs é›†æˆ
â”‚   â”œâ”€â”€ å®æ—¶è®¡æ•°æ˜¾ç¤º
â”‚   â””â”€â”€ è´¹ç”¨ä¼°ç®—
â”‚
â””â”€â”€ Day 27-28: å¯¼å‡ºåŠŸèƒ½
    â”œâ”€â”€ JSON/CSV å¯¼å‡º
    â”œâ”€â”€ Markdown æŠ¥å‘Š
    â””â”€â”€ æ‰¹é‡æ“ä½œ

ç¬¬ 5 å‘¨ï¼šæµ‹è¯•ä¸å‘å¸ƒ
â”œâ”€â”€ Day 29-31: æµ‹è¯•ä¸ä¿®å¤
â”‚   â”œâ”€â”€ å•å…ƒæµ‹è¯•
â”‚   â”œâ”€â”€ é›†æˆæµ‹è¯•
â”‚   â””â”€â”€ æ€§èƒ½ä¼˜åŒ–ï¼ˆå‘é‡æ£€ç´¢ï¼‰
â”‚
â”œâ”€â”€ Day 32-33: æ‰“åŒ…ä¸éƒ¨ç½²
â”‚   â”œâ”€â”€ sqlite-vec é™æ€ç¼–è¯‘
â”‚   â”œâ”€â”€ Windows å®‰è£…ç¨‹åº
â”‚   â””â”€â”€ ä»£ç ç­¾å
â”‚
â””â”€â”€ Day 34-35: æ–‡æ¡£ä¸æ”¶å°¾
    â”œâ”€â”€ ç”¨æˆ·æ–‡æ¡£
    â”œâ”€â”€ API æ–‡æ¡£
    â””â”€â”€ æœ€ç»ˆéªŒè¯
```

### 8.2 é‡Œç¨‹ç¢‘ï¼ˆæ›´æ–°ç‰ˆï¼‰

| é‡Œç¨‹ç¢‘ | äº¤ä»˜ç‰© | å®Œæˆæ ‡å‡† |
|--------|--------|---------|
| **M1: åŸºç¡€æ¶æ„** | å¯è¿è¡Œçš„ Tauri åº”ç”¨ | èƒ½æ‰«æå¹¶æ˜¾ç¤ºä¼šè¯åˆ—è¡¨ï¼Œè½»é‡åŒ–å­˜å‚¨ |
| **M2: å®æ—¶ç›‘æ§** | å¢é‡æ›´æ–°çš„ç›‘æ§å™¨ | FileShare æ¨¡å¼ï¼Œæ–°ä¼šè¯ 2 ç§’å†…æ˜¾ç¤º |
| **M3: å‘é‡æ£€ç´¢** | è¯­ä¹‰æœç´¢åŠŸèƒ½ | 1000+ ä¼šè¯ä¸­æ£€ç´¢ Top-5 < 100ms |
| **M4: æç¤ºè¯ä¼˜åŒ–** | å‘é‡å¢å¼ºçš„ä¼˜åŒ–å™¨ | ç”Ÿæˆå¯ç”¨çš„å¢å¼ºæç¤ºè¯ï¼ŒToken èŠ‚çœ > 50% |
| **M5: UI å¢å¼º** | ä»£ç å¯¹æ¯” + Token è®¡æ•° | Monaco Editor Diff Viewï¼Œå®æ—¶ Token æ˜¾ç¤º |
| **M6: æ­£å¼å‘å¸ƒ** | Windows å®‰è£…åŒ… | å¯ç‹¬ç«‹å®‰è£…è¿è¡Œï¼Œä½“ç§¯ < 10MB |

---

## 9. é£é™©åˆ†æä¸åº”å¯¹ï¼ˆæ›´æ–°ç‰ˆï¼‰

### 9.1 æŠ€æœ¯é£é™©

| é£é™© | ç­‰çº§ | å½±å“ | ç¼“è§£ç­–ç•¥ |
|------|------|------|---------|
| æ–‡ä»¶ç›‘æ§æ€§èƒ½é—®é¢˜ | ä¸­ | CPU å ç”¨é«˜ | â€¢ ä½¿ç”¨åŸç”Ÿ API (ReadDirectoryChangesW)<br>â€¢ äº‹ä»¶å»é‡ä¸é˜²æŠ– |
| JSONL è§£æé”™è¯¯ | ä¸­ | æŸåä¼šè¯å¯¼è‡´å´©æºƒ | â€¢ å®¹é”™è§£æ<br>â€¢ è·³è¿‡æ— æ•ˆè¡Œ<br>â€¢ ç¼“å†²åŒºå¤„ç†æœªå®Œæˆçš„è¡Œ |
| æ–‡ä»¶é”å®šé—®é¢˜ | ä¸­ | æ— æ³•è¯»å–æ­£åœ¨å†™å…¥çš„æ–‡ä»¶ | â€¢ FileShare æ¨¡å¼<br>â€¢ é™çº§é‡è¯•æœºåˆ¶ |
| SQLite + æ‰©å±•ç¼–è¯‘ | ä¸­ | sqlite-vec é™æ€ç¼–è¯‘å¤±è´¥ | â€¢ ä½¿ç”¨é¢„ç¼–è¯‘ç‰ˆæœ¬<br>â€¢ Sidecar æ¨¡å¼é™çº§ |
| å‘é‡æ£€ç´¢æ€§èƒ½ | ä¸­ | å¤§é‡ä¼šè¯æ—¶æ£€ç´¢æ…¢ | â€¢ ç´¢å¼•ä¼˜åŒ–<br>â€¢ åˆ†åŒºç­–ç•¥<br>â€¢ æ‰¹é‡é™åˆ¶ |
| æ¶ˆæ¯æ ‘æ„å»ºæº¢å‡º | ä½ | æ·±å±‚åµŒå¥—æ ˆæº¢å‡º | â€¢ è¿­ä»£ç®—æ³•<br>â€¢ æ·±åº¦é™åˆ¶ |

### 9.2 ä¸šåŠ¡é£é™©

| é£é™© | ç­‰çº§ | å½±å“ | ç¼“è§£ç­–ç•¥ |
|------|------|------|---------|
| Claude Code æ ¼å¼å˜æ›´ | é«˜ | è§£æå¤±æ•ˆ | â€¢ ç‰ˆæœ¬æ£€æµ‹<br>â€¢ å‘åå…¼å®¹<br>â€¢ é™çº§å¤„ç† |
| ç”¨æˆ·æ•°æ®éšç§ | ä¸­ | æ•æ„Ÿä¿¡æ¯æ³„éœ² | â€¢ æœ¬åœ°å­˜å‚¨<br>â€¢ æ•°æ®è„±æ•<br>â€¢ éšç§å£°æ˜ |
| å‘é‡æ£€ç´¢æ•ˆæœ | ä¸­ | ç›¸å…³æ€§ä¸å‡†ç¡® | â€¢ å¤šç§æ£€ç´¢ç­–ç•¥ï¼ˆæ··åˆï¼‰<br>â€¢ ç”¨æˆ·åé¦ˆå­¦ä¹  |

### 9.3 å¼€å‘é£é™©

| é£é™© | ç­‰çº§ | å½±å“ | ç¼“è§£ç­–ç•¥ |
|------|------|------|---------|
| Rust å­¦ä¹ æ›²çº¿ | ä¸­ | å¼€å‘å»¶æœŸ | â€¢ æå‰å­¦ä¹ <br>â€¢ ä»£ç å¤ç”¨<br>â€¢ ç¤¾åŒºæ”¯æŒ |
| UI/UX å¤æ‚åº¦ | ä½ | å¼€å‘æ—¶é—´å¢åŠ  | â€¢ ä½¿ç”¨æˆç†Ÿç»„ä»¶<br>â€¢ å‚è€ƒä¼˜ç§€å®ç° |
| æ‰©å±•ç¼–è¯‘é—®é¢˜ | ä¸­ | æ‰“åŒ…å¤±è´¥ | â€¢ æä¾›é™çº§æ–¹æ¡ˆ<br>â€¢ æ–‡æ¡£å®Œå–„ |
| æ—¶é—´ä¼°ç®—ä¸å‡† | ä¸­ | é¡¹ç›®å»¶æœŸ | â€¢ é¢„ç•™ç¼“å†²<br>â€¢ MVP ä¼˜å…ˆ |

### 9.4 éœ€æ±‚å˜æ›´é£é™©

- **é£é™©**: è¯„åˆ†ç³»ç»Ÿå†·å¯åŠ¨é—®é¢˜ï¼ˆåˆæœŸæ²¡æœ‰è¯„åˆ†ï¼ŒRAG æ•ˆæœä¸æ˜æ˜¾ï¼‰ã€‚
- **åº”å¯¹**: è®¾ç½®é»˜è®¤åŸºç¡€åˆ†ï¼ˆå¦‚ 2.5/5.0ï¼‰ï¼Œå¹¶å¼•å…¥â€œæŒ‰æ—¶é—´è¡°å‡â€æƒé‡ï¼Œè®©æ–°ä¼šè¯ä¹Ÿæœ‰æœºä¼šè¢«æ£€ç´¢ã€‚

### 9.5 æ‰©å±•æ€§é£é™© (é’ˆå¯¹ Codex/Kiro)

- **é£é™©**: æœªæ¥æ”¯æŒå…¶ä»–å·¥å…·æ—¶ï¼Œæ•°æ®åº“å­—æ®µä¸å…¼å®¹ã€‚
- **åº”å¯¹**: åœ¨ `messages` è¡¨ä¸­ä½¿ç”¨ `metadata_json` å­—æ®µå­˜å‚¨å·¥å…·ç‰¹æœ‰çš„å…ƒæ•°æ®ï¼Œè€Œéä¸ºæ¯ä¸ªå·¥å…·åŠ åˆ—ã€‚

---

## 10. é™„å½•

### 10.1 å‚è€ƒèµ„æº

- [Tauri å®˜æ–¹æ–‡æ¡£](https://tauri.app/v1/guides/)
- [sqlite-vec æ–‡æ¡£](https://github.com/asg017/sqlite-vec)
- [fastembed æ–‡æ¡£](https://github.com/rapidfly/fastembed)
- [tiktoken-rs æ–‡æ¡£](https://github.com/zurawiki/tiktoken-rs)
- [Monaco Editor æ–‡æ¡£](https://microsoft.github.io/monaco-editor/)
- [react-diff-viewer æ–‡æ¡£](https://github.com/atomiks/react-diff-viewer-continued)

### 10.2 ç›¸å…³é¡¹ç›®

- [Claude Code](https://github.com/anthropics/claude-code)
- [Cursor](https://cursor.sh/) - AI ç¼–è¾‘å™¨å‚è€ƒ
- [Continue](https://github.com/continuedev/continue) - VSCode æ’ä»¶å‚è€ƒ
- [Qdrant](https://github.com/qdrant/qdrant) - å‘é‡æ•°æ®åº“å‚è€ƒ

### 10.3 æœ¯è¯­è¡¨

| æœ¯è¯­ | å®šä¹‰ |
|------|------|
| JSONL | JSON Linesï¼Œæ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡çš„æ–‡ä»¶æ ¼å¼ |
| parentUuid | æŒ‡å‘çˆ¶æ¶ˆæ¯çš„ UUIDï¼Œç”¨äºæ„å»ºæ¶ˆæ¯æ ‘ |
| offset | å­—èŠ‚åç§»é‡ï¼Œè®°å½•æ•°æ®åœ¨æ–‡ä»¶ä¸­çš„èµ·å§‹ä½ç½® |
| å‘é‡åµŒå…¥ | å°†æ–‡æœ¬è½¬æ¢ä¸ºæ•°å€¼å‘é‡çš„è¡¨ç¤ºï¼Œç”¨äºè¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®— |
| ä½™å¼¦ç›¸ä¼¼åº¦ | è¡¡é‡ä¸¤ä¸ªå‘é‡æ–¹å‘ç›¸ä¼¼åº¦çš„æŒ‡æ ‡ï¼ŒèŒƒå›´ [-1, 1]ï¼Œè¶Šæ¥è¿‘ 1 è¶Šç›¸ä¼¼ |
| Token | LLM å¤„ç†æ–‡æœ¬çš„åŸºæœ¬å•ä½ |
| FileShare æ¨¡å¼ | Windows æ–‡ä»¶å…±äº«æ¨¡å¼ï¼Œå…è®¸å¤šè¿›ç¨‹åŒæ—¶è¯»å†™æ–‡ä»¶ |
| Diff View | ä»£ç å¯¹æ¯”è§†å›¾ï¼Œé«˜äº®æ˜¾ç¤ºæ–‡ä»¶å·®å¼‚ |
| é‡ç´¢å¼•è½»å­˜å‚¨ | å­˜å‚¨ç´¢å¼•è€Œéå®Œæ•´å†…å®¹ï¼ŒæŒ‰éœ€ä»æºæ–‡ä»¶è¯»å– |

### 10.4 æ›´æ–°æ—¥å¿—

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´è¯´æ˜ |
|------|------|---------|
| 1.0 | 2025-12-24 | åˆå§‹ç‰ˆæœ¬ |
| 1.1 | 2025-12-24 | å¢å¼ºç‰ˆï¼šæ·»åŠ  sqlite-vec å‘é‡æ£€ç´¢ã€é‡ç´¢å¼•è½»å­˜å‚¨ã€FileShare æ¨¡å¼ã€Monaco Editor Diff Viewã€Token è®¡æ•° |

### 10.5 æ¨èèµ„æº (æ–°å¢)

- **Chatbox æºç **: https://github.com/Bin-Huang/chatbox (é‡ç‚¹å‚è€ƒ `src-tauri/src/app/core/llm` ç›®å½•ä¸‹çš„å®ç°)
- **Rust async-openai**: https://github.com/64bit/async-openai (å‡å°‘æ‰‹å†™ HTTP è¯·æ±‚çš„å·¥ä½œé‡)
- **Ollama API æ–‡æ¡£**: https://github.com/ollama/ollama/blob/main/docs/api.md (æœ¬åœ°æ¨¡å‹é›†æˆ)

---

**æ–‡æ¡£ç‰ˆæœ¬å†å²**ï¼š

| ç‰ˆæœ¬ | æ—¥æœŸ | ä½œè€… | å˜æ›´è¯´æ˜ |
|------|------|------|---------|
| 1.0 | 2025-12-24 | Claude | åˆå§‹ç‰ˆæœ¬ |
| 1.1 | 2025-12-24 | Claude | å¢å¼ºç‰ˆï¼šå‘é‡æ£€ç´¢ + è½»é‡åŒ–å­˜å‚¨ + UI å¢å¼º |
| 1.2 | 2025-12-24 | Claude | æ–°å¢ LLM API å¤šæ¨¡å‹ç®¡ç†æ¨¡å— (å‚è€ƒ Chatbox æ¶æ„) |

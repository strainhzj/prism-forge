# 多维计划审计方法论与技能优化方案

---

## 第一部分：多维计划审计方法论

### 一、问题类型分类体系

基于 WAVE_2 分析实践，将发现的问题归纳为 **5 大类深层问题**：

#### 1. 结构同构性冲突

**定义**：同一系统的不同描述文件中，对核心结构的定义不一致。

**典型案例**：
```
冲突源：执行顺序定义
- wave2_phase1_core.json:sequential_tasks → T1_3 → T1_2 → T1_PERF
- wave2.6_strategy.json:branch_setup_commands → T1_2 → T1_3 → T1_PERF

影响：开发者可能按错误的顺序执行任务，导致依赖缺失
```

**检测模式**：
- 正则提取所有执行顺序定义
- 构建有向图进行同构比对
- 报告非同构的顺序定义

#### 2. 符号引用完整性缺失

**定义**：引用的符号（函数、模块、配置）没有明确的创建者/实现位置。

**典型案例**：
```
引用点：wave2.2_task_t1_2.json:102
引用内容：get_active_threshold() 函数

追踪路径：
  wave2.8_prerequisites → Wave 1 migrate_v6 创建 settings 表
  wave2.3 → T2_008 模板提供函数实现
  但 T1_2/T1_3 任务中都没有明确创建 settings.rs

结果：符号孤岛，实现责任不明确
```

**检测模式**：
- 扫描所有符号引用（函数调用、模块引用）
- 建立符号索引：symbol → 定义位置
- 检查"使用但未定义"的符号

#### 3. 版本时序断层

**定义**：依赖链中的版本号不连续或跳跃。

**典型案例**：
```
版本链分析：
  Wave 1: ... → migrate_v6 (settings 表创建)
  Wave 2: migrate_v9, v10, v11, v12

问题：v7, v8 在哪里？
  - 如果 Wave 1 只到 v6，那么 v7, v8 是否在 Wave 2？
  - 还是 Wave 1 实际完成了 v8？

风险：迁移执行时可能跳过关键版本
```

**检测模式**：
- 提取所有版本号引用
- 构建版本依赖图
- 检查缺失的版本号

#### 4. 命名一致性偏差

**定义**：同一实体的名称在不同上下文中不一致。

**典型案例**：
```
引用位置：wave2.6_strategy.json:129
引用内容："wave2.3_task_t1_3.json"
实际文件："wave2.3_task_t1_3_v6.0.json"

影响：开发者查找文件失败，浪费时间
```

**检测模式**：
- 提取所有文件名引用
- 与实际文件系统对比
- 报告不匹配的引用

#### 5. 数据流链路断裂

**定义**：数据从生产者到消费者的传输路径不完整。

**典型案例**：
```
配置项：active_threshold
  定义：wave2.2:91-112
  存储：Wave 1 migrate_v6 (settings.active_threshold)
  读取：T2_008 get_active_threshold() ← 实现位置不明确
  使用：T1_2 is_session_active()

断裂点：settings.rs 文件的创建时机不明确
```

**检测模式**：
- 追踪每个数据流的完整路径
- 验证每个环节的实现者
- 报告缺失的环节

---

### 二、通用审计方法论

#### 核心思想：五维交叉验证

```
┌─────────────────────────────────────────────────┐
│          多维计划审计方法论                      │
├─────────────────────────────────────────────────┤
│                                                 │
│  ① 文件关系拓扑构建                              │
│     └─ 建立全局文件依赖图                        │
│                                                 │
│  ② 符号引用索引                                  │
│     └─ 所有符号的定义-引用映射                   │
│                                                 │
│  ③ 交叉验证执行                                  │
│     ├─ 结构同构性检查                            │
│     ├─ 符号完整性检查                            │
│     ├─ 版本连续性检查                            │
│     ├─ 命名一致性检查                            │
│     └─ 数据流完整性检查                          │
│                                                 │
│  ④ 风险优先级排序                                │
│     └─ P0(阻断性) / P1(高风险) / P2(中风险)      │
│                                                 │
│  ⑤ 改进建议生成                                  │
│     └─ 具体可执行的修复方案                      │
│                                                 │
└─────────────────────────────────────────────────┘
```

#### 检查清单模板

```markdown
## 计划审计检查清单

### 维度 1: 结构同构性 ✅/⚠️/❌
- [ ] 执行顺序在不同文件中一致
- [ ] 任务依赖关系在不同文件中一致
- [ ] 分支策略与任务依赖匹配

### 维度 2: 符号引用完整性 ✅/⚠️/❌
- [ ] 所有函数引用都有实现位置
- [ ] 所有模块引用都有创建任务
- [ ] 所有配置字段都有创建位置

### 维度 3: 版本时序连续性 ✅/⚠️/❌
- [ ] 版本依赖链完整无断层
- [ ] 迁移顺序正确（递增）
- [ ] 版本号与文件名后缀对应

### 维度 4: 命名一致性 ✅/⚠️/❌
- [ ] 文件名引用与实际文件一致
- [ ] 函数名引用与定义一致
- [ ] 变量名在不同上下文一致

### 维度 5: 数据流完整性 ✅/⚠️/❌
- [ ] 每个数据流的完整路径可追踪
- [ ] 生产者-消费者关系明确
- [ ] 无数据流断链
```

---

## 第二部分：optimize-wave 技能优化方案

### 技能定义

```yaml
name: optimize-wave
version: 2.0
description: |
  基于多维计划审计方法论的 Wave 计划优化技能。
  通过五维交叉验证发现计划中的冲突、缺失和不一致，
  输出优化后的计划和详细的风险评估报告。
```

### System Prompt

```markdown
# optimize-wave v2.0

你是一个专业的开发计划审计与优化专家。你的工作是通过**多维交叉验证**发现计划文件中的深层问题，并提供具体的改进建议。

## 核心能力

### 1. 模拟执行校验

在执行任何优化之前，必须先完成以下检查：

#### 1.1 文件关系拓扑构建
- 识别所有计划文件（*_manifest, *_task, *_integration, *_strategy, *_prerequisites）
- 建立文件依赖图：A 文件引用 B 文件
- 定位核心文件和边缘文件

#### 1.2 符号引用索引
- 扫描所有函数名、模块名、配置字段名
- 建立符号映射表：`symbol → [引用位置, 定义位置(如果有)]`
- 标记"使用但未定义"的符号（符号孤岛）

#### 1.3 五维交叉验证

**维度 1: 结构同构性检查**
```
提取所有执行顺序定义：
  - manifest.sequential_tasks
  - strategy.branch_setup_commands
  - prerequisites.execution_order

验证：
  1. 转换为有向图
  2. 检查是否同构（节点和边的一致性）
  3. 报告冲突：优先级 P0
```

**维度 2: 符号引用完整性检查**
```
对每个符号引用：
  1. 搜索定义位置（在所有计划文件中）
  2. 检查是否有明确的创建任务
  3. 验证引用时机晚于定义时机

报告：
  - 符号孤岛：被使用但未定义
  - 时序错误：使用早于定义
```

**维度 3: 版本/时序对齐检查**
```
提取所有版本号引用：
  - 数据库迁移版本 (migrate_vX)
  - 文件版本后缀 (v1.0, v2.0)
  - 文档版本 (_version字段)

验证：
  1. 版本链是否连续（无断层）
  2. 版本顺序是否递增
  3. 版本号与实际文件匹配

报告：
  - 版本断层：缺失中间版本
  - 版本回退：新版本号小于旧版本号
```

**维度 4: 命名一致性检查**
```
提取所有命名实体：
  - 文件名引用
  - 函数名引用
  - 变量名引用

验证：
  1. 文件名引用与实际文件系统对比
  2. 函数名引用与定义对比
  3. 跨文件命名风格一致性

报告：
  - 文件名不匹配
  - 命名风格不一致
```

**维度 5: 数据流完整性检查**
```
对每个关键数据流：
  1. 追踪生产者（创建位置）
  2. 追踪传输路径（哪个文件/函数使用）
  3. 追踪消费者（最终使用位置）

验证：
  - 生产者明确
  - 传输路径完整
  - 消费者明确
  - 无断链

报告：
  - 数据流断链
  - 生产者不明确
  - 消费者不明确
```

### 2. 风险评估标准

**P0 - 阻断性问题**：
- 执行顺序冲突（导致开发混乱）
- 关键符号缺失（导致编译失败）
- 数据流断链（导致功能无法实现）

**P1 - 高风险问题**：
- 版本断层（可能导致迁移失败）
- 文件名不匹配（浪费时间查找）
- 时序错误（使用早于定义）

**P2 - 中风险问题**：
- 命名风格不一致
- 文档描述模糊
- 缺少验证步骤

### 3. 输出格式

#### 3.1 风险与冲突评估报告

```markdown
# Wave 计划风险与冲突评估报告

## 执行摘要
- 分析文件数：X
- 发现问题总数：Y (P0: A, P1: B, P2: C)
- 整体风险等级：[高/中/低]

## 详细问题列表

### P0 - 阻断性问题

#### 问题 1: [标题]
**类型**：[顺序冲突/符号缺失/数据流断链]
**位置**：文件A:行号, 文件B:行号
**描述**：[具体问题描述]
**影响**：[对开发的影响]
**建议**：[具体修复方案]

### P1 - 高风险问题
[同上格式]

### P2 - 中风险问题
[同上格式]

## 优先修复建议
1. [P0 问题 1 的修复]
2. [P0 问题 2 的修复]
...

## 优化后计划概述
- 修改的文件：[列表]
- 新增的内容：[列表]
- 验证检查点：[列表]
```

#### 3.2 优化后的计划

基于风险评估结果，输出优化后的计划内容：
- 修正执行顺序
- 补充缺失的符号定义
- 修正文件名引用
- 明确数据流路径
- 添加验证检查点

## 工作流程

1. **读取并解析**：读取所有相关计划文件
2. **建立索引**：构建符号引用索引和文件依赖图
3. **执行检查**：运行五维交叉验证
4. **生成报告**：输出风险评估报告
5. **优化计划**：输出修正后的计划
6. **验证输出**：确保输出计划无新增问题

## 注意事项

- 始终基于实际文件内容，不添加假设
- 优先修复 P0 问题，确保计划可执行
- 保持与原有计划的结构兼容
- 提供具体可执行的修复建议
```

### 技能配置文件

```json
{
  "skill_id": "optimize-wave",
  "version": "2.0",
  "name": "Wave 计划优化（多维审计版）",
  "description": "基于五维交叉验证的计划审计与优化技能",
  "category": "planning",

  "input_schema": {
    "type": "object",
    "properties": {
      "wave_manifest": {
        "type": "string",
        "description": "Wave 主文件路径（如 wave2_phase1_core.json）"
      },
      "additional_files": {
        "type": "array",
        "items": {"type": "string"},
        "description": "其他相关文件路径（可选，技能会自动发现）"
      },
      "check_dimensions": {
        "type": "array",
        "items": {
          "type": "string",
          "enum": [
            "structure_isomorphism",
            "symbol_integrity",
            "version_continuity",
            "naming_consistency",
            "dataflow_completeness"
          ]
        },
        "description": "要检查的维度（默认全部）",
        "default": ["all"]
      }
    }
  },

  "output_schema": {
    "type": "object",
    "properties": {
      "risk_assessment": {
        "type": "object",
        "description": "风险评估报告"
      },
      "optimized_plan": {
        "type": "object",
        "description": "优化后的计划"
      },
      "verification_checklist": {
        "type": "array",
        "items": {"type": "string"},
        "description": "执行前验证清单"
      }
    }
  },

  "examples": [
    {
      "input": {
        "wave_manifest": "dev_plans/plan1/waves/wave2_phase1_core.json"
      },
      "output": {
        "risk_assessment": {
          "summary": "发现 8 个问题 (P0: 2, P1: 3, P2: 3)",
          "issues": [
            {
              "level": "P0",
              "type": "structure_isomorphism",
              "title": "执行顺序冲突",
              "locations": ["wave2_core:sequential_tasks", "wave2.6:branch_setup_commands"],
              "recommendation": "统一为 T1_3 → T1_2 → T1_PERF"
            }
          ]
        },
        "optimized_plan": {
          "file": "wave2_phase1_core_v6.1.json",
          "changes": ["修正 sequential_tasks 顺序", "补充 settings.rs 创建任务"]
        }
      }
    }
  ]
}
```

---

## 方法论应用示例

基于这套方法论，可以快速发现类似 WAVE_2 的问题：

```
输入：wave2_phase1_core.json

自动执行：
1. Glob("**/wave2*.json") → 发现 8 个相关文件
2. 构建符号索引 → 发现 get_active_threshold() 被 3 处引用但定义位置不明确
3. 交叉验证 → 发现执行顺序冲突
4. 版本检查 → 发现 v6-v9 之间可能缺失 v7, v8
5. 命名检查 → 发现文件名引用缺少 _v6.0 后缀
6. 数据流检查 → 发现 settings.rs 创建时机不明确

输出：
- P0 问题：2 个（执行顺序冲突、符号孤岛）
- P1 问题：3 个（文件名不匹配、版本断层、时序错误）
- P2 问题：3 个（命名风格不一致）
```

---

## 方法论核心价值

1. **系统化**：将人工经验转化为可重复的检查流程
2. **自动化**：可以通过 LLM + 工具调用自动执行
3. **可扩展**：新的检查维度可以轻松添加
4. **可量化**：风险评估有明确的优先级标准
5. **可操作**：输出具体的修复建议而非模糊的问题描述

---

## 附录：快速参考卡

```markdown
## 五维检查速查表

| 维度 | 检查内容 | 工具 | 输出 |
|------|----------|------|------|
| 结构同构性 | 执行顺序、依赖关系 | 图同构算法 | 冲突报告 |
| 符号完整性 | 函数、模块、配置 | 符号索引 | 孤岛列表 |
| 版本连续性 | 迁移版本、文件版本 | 版本图 | 断层报告 |
| 命名一致性 | 文件名、函数名 | 字符串匹配 | 不匹配列表 |
| 数据流完整性 | 生产-消费链 | 数据流图 | 断链报告 |

## 风险等级速查

| 等级 | 图标 | 响应时间 | 示例 |
|------|------|----------|------|
| P0 | 🔴 | 立即修复 | 执行顺序冲突 |
| P1 | 🟡 | 尽快修复 | 版本断层 |
| P2 | 🟢 | 计划修复 | 命名风格 |
```

---

*文档版本：v1.0*
*创建日期：2025-12-30*
*作者：Claude Code 多维分析*

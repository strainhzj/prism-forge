{
  "_file_type": "wave_manifest",
  "_description": "Wave 2 主指引文件：指向所有子任务文件（v10.0 深度审计版）",
  "_version": "v10.0",
  "_version_description": "基于 v10.0 五维深度审计引擎优化，修复语义覆盖率缺口（T2_006 模板添加 1000 会话压力测试）。保留 v6.0 所有改进（符号引用图、冲突矩阵、配置闭环验证）",
  "wave_id": "WAVE_2",
  "name": "第二波：PHASE_1 核心任务",
  "description": "完成会话扫描器和表结构扩展，实现基础的会话发现功能",
  "_v6_compliance": {
    "virtual_execution_engine": {
      "description": "v6.0 虚拟执行引擎特性",
      "features": [
        "符号引用图 (SRG) - 追踪所有函数/类型/配置的定义-引用关系",
        "冲突矩阵生成 - 自动检测跨文件字段值冲突",
        "配置闭环验证 - 确保'定义→存储→读取→写入→UI'完整链路",
        "6 大检查清单 - 符号引用、数据流、状态、实现、语义、前置条件"
      ]
    },
    "v6_rules": {
      "description": "v6.0 新增三维规则",
      "rules": [
        "17. 符号引用完整性检查 ✅ - 发现并修复 4 个符号孤岛（get_active_threshold, update_active_threshold, is_scan_cache_enabled, set_scan_cache_enabled）",
        "18. 配置闭环完整验证 ✅ - 修复 active_threshold 和 scan_cache_enabled 闭环缺口",
        "19. 跨文件冲突矩阵生成 ✅ - 自动检测并解决字段值冲突"
      ]
    },
    "retained_rules": {
      "description": "保留的 v3.1 规则",
      "rules": [
        "1-16: 基础六维 + 增强七维 + v3.1 三维规则 ✅"
      ]
    }
  },
  "branch": {
    "name": "feat/phase1-wave2",
    "base": "master",
    "strategy": "feature_branch",
    "depends_on": [
      "feat/phase1-wave1"
    ]
  },
  "_agent_instructions": {
    "execution_order": [
      "1. 首先阅读 wave2.8_prerequisites.json 确认 Wave 1 的交付物",
      "2. 阅读wave2.1_metadata.json 了解项目元数据和关键决策",
      "3. 参考 wave2.7_templates.json 获取代码模板（10 个模板）",
      "4. 根据 wave2.2_task_t1_2.json 执行 T1_2 任务（会话扫描器）",
      "5. 根据 wave2.3_task_t1_3.json 执行 T1_3 任务（扩展数据库表结构，含 migrate_v12）",
      "6. 根据 wave2.4_task_t1_perf.json 执行 T1_PERF 任务（性能基准测试）",
      "7. 根据 wave2.5_integration.json 执行集成测试和验证",
      "8. 参考 wave2.6_strategy.json 处理 Git 策略和风险"
    ],
    "required_reading_files": [
      "wave2.8_prerequisites.json",
      "wave2.1_metadata.json",
      "wave2.7_templates.json",
      "wave2.2_task_t1_2.json",
      "wave2.3_task_t1_3.json",
      "wave2.4_task_t1_perf.json",
      "wave2.5_integration.json",
      "wave2.6_strategy.json"
    ],
    "critical_prerequisites": [
      "Wave 1 (WAVE_1) 必须已完成",
      "数据库基础架构（sessions, messages, settings 等表）已建立",
      "T1_1 任务（数据库集成）已完成",
      "Wave 1 的 migrate_v6 必须已创建 settings 表（含 active_threshold 字段）"
    ]
  },
  "_file_structure": {
    "wave2_phase1_core_v6.0.json": "主指引文件（本文件）",
    "wave2.1_metadata.json": "元数据：版本历史、Agent 指令、文件操作、基本信息",
    "wave2.2_task_t1_2.json": "任务 T1_2：实现会话扫描器（v5.0，含超时机制）",
    "wave2.3_task_t1_3.json": "任务 T1_3：扩展数据库表结构（v6.0，新增 migrate_v12）",
    "wave2.4_task_t1_perf.json": "任务 T1_PERF：性能基准测试（v4.1，含完整测试用例）",
    "wave2.5_integration.json": "集成指南：集成任务、验证检查点、状态更新",
    "wave2.6_strategy.json": "策略指南：Git 策略、风险缓解、交付物",
    "wave2.7_templates.json": "代码模板引用文件（10 个模板，新增 T2_008/T2_009/T2_010）",
    "wave2.8_prerequisites.json": "前置条件规范（依赖 Wave 1 的详细交付物）",
    "wave2_v6_virtual_execution_report.md": "v6.0 虚拟执行分析报告（新增）"
  },
  "sequential_tasks": [
    {
      "task_id": "T1_3",
      "name": "扩展数据库表结构",
      "sub_branch": "feat/phase1-wave2-t1_3",
      "file_reference": "wave2.3_task_t1_3.json",
      "estimated_hours": 10,
      "priority": "high",
      "dependencies": [
        "T1_1"
      ],
      "_v6_note": "v6.0 新增 Step 6: 添加 settings.scan_cache_enabled 字段 (migrate_v12)"
    },
    {
      "task_id": "T1_2",
      "name": "实现会话扫描器",
      "sub_branch": "feat/phase1-wave2-t1_2",
      "file_reference": "wave2.2_task_t1_2.json",
      "estimated_hours": 20,
      "priority": "critical",
      "dependencies": [
        "T1_1",
        "T1_3"
      ],
      "_v6_note": "v5.0 修复依赖倒置，添加 T1_3 依赖。T1_2 使用 T2_008 模板的 settings 函数"
    },
    {
      "task_id": "T1_PERF",
      "name": "性能基准测试 - 启动与扫描",
      "sub_branch": "feat/phase1-wave2-t1_perf",
      "file_reference": "wave2.4_task_t1_perf.json",
      "estimated_hours": 6,
      "priority": "medium",
      "dependencies": [
        "T1_2"
      ],
      "_v6_note": "v4.1 新增超时处理、文件锁定检测、SQLite 版本兼容性测试"
    }
  ],
  "_quick_reference": {
    "prerequisites": "参考 wave2.8_prerequisites.json",
    "database_versions": "v9-v12 (v6.0 新增 v12: scan_cache_enabled 字段)",
    "code_templates": "参考 wave2.7_templates.json (10 个模板，新增 T2_008/T2_009/T2_010)",
    "acceptance_criteria": "参考 wave2.2_task_t1_2.json, wave2.3_task_t1_3.json, wave2.4_task_t1_perf.json",
    "verification_checkpoints": "参考 wave2.5_integration.json",
    "rollback_plan": "参考 wave2.5_integration.json",
    "git_strategy": "参考 wave2.6_strategy.json",
    "virtual_execution_report": "参考 wave2_v6_virtual_execution_report.md (v6.0 新增)"
  },
  "success_criteria": [
    "会话扫描器能正确扫描 ~/.claude/projects/ 目录",
    "返回所有会话的元数据列表（sessionId, projectPath, isActive 等）",
    "活跃会话检测正确工作（使用 get_active_threshold() 读取配置）",
    "sessions 表扩展成功（rating, tags, is_archived 字段）",
    "saved_prompts 和 meta_templates 表正确创建",
    "settings 表扩展成功（scan_cache_enabled 字段，v6.0 新增）",
    "性能达标：启动时间 < 3s，100 个会话扫描 < 2s，1000 会话压力测试 < 10s (v10.0 新增)",
    "所有单元测试通过（覆盖率 > 80%）",
    "所有验证检查点通过",
    "main_plan.json 状态已同步更新（completed_tasks, global_status）"
  ],
  "_v10_analysis": {
    "description": "v10.0 五维深度审计分析结果",
    "audit_engine": "optimize-wave v10.0 (Deep-scan)",
    "audit_date": "2025-12-30",
    "overall_score": "48.5/50 (97%)",
    "dimensions": {
      "dim1_structure_dependency": {
        "name": "结构与依赖同构",
        "score": "10/10",
        "status": "✅ 优秀",
        "findings": "Manifest 与 Strategy 完全同构，依赖关系正确（T1_2 → T1_3 已修复），无死锁"
      },
      "dim2_symbol_integrity": {
        "name": "符号引用完整性",
        "score": "10/10",
        "status": "✅ 优秀",
        "findings": "所有符号引用完整（get_active_threshold, update_active_threshold, is_scan_cache_enabled, set_scan_cache_enabled, upsert_session），无孤岛"
      },
      "dim3_temporal_logic": {
        "name": "时空逻辑与起源悖论",
        "score": "10/10",
        "status": "✅ 优秀",
        "findings": "无时间轴悖论，所有实体起源一致（active_threshold 在 Wave 1 v6，scan_cache_enabled 在 Wave 2 v12）"
      },
      "dim4_semantic_completeness": {
        "name": "语义完备性与覆盖率",
        "score": "9/10",
        "status": "✅ 良好 (v10.0 已修复)",
        "issues_found": [
          {
            "issue_id": "SEM-01",
            "severity": "P1",
            "description": "T2_006 模板缺少 1000 会话压力测试实现",
            "location": "wave2.7_templates_v6.0.json T2_006",
            "fix": "添加 setup_stress_test_environment() 函数和 test_session_scan_time_1000_stress 测试用例",
            "status": "✅ 已修复"
          }
        ]
      },
      "dim5_dataflow_closure": {
        "name": "数据流与配置闭环",
        "score": "9.5/10",
        "status": "✅ 良好",
        "findings": "核心闭环完整（定义→存储→读取→写入），UI 层标注为待实现（合理设计决策）",
        "closure_chains": [
          {
            "config": "active_threshold",
            "definition": "✅",
            "storage": "✅ Wave 1 v6",
            "read_function": "✅ T2_008",
            "write_function": "✅ T2_008",
            "ui": "⏳ 待实现"
          },
          {
            "config": "scan_cache_enabled",
            "definition": "✅",
            "storage": "✅ Wave 2 v12",
            "read_function": "✅ T2_008",
            "write_function": "✅ T2_008",
            "ui": "⏳ 待实现"
          }
        ]
      }
    },
    "improvements_summary": {
      "v10_0_fixes": [
        "修复语义覆盖率缺口：T2_006 模板添加 setup_stress_test_environment() 函数",
        "添加 1000 会话压力测试用例：test_session_scan_time_1000_stress",
        "更新 success_criteria 包含压力测试目标"
      ],
      "v6_0_retained": [
        "符号引用完整性修复（4 个符号孤岛）",
        "配置闭环验证（active_threshold, scan_cache_enabled）",
        "依赖关系修复（T1_2 → T1_3）",
        "冲突矩阵生成"
      ]
    },
    "validation": {
      "safe_to_execute": true,
      "ai_ready": true,
      "blocking_issues": 0,
      "recommendation": "可直接执行，已通过五维深度审计"
    }
  },
  "_v6_analysis": {
    "symbol_reference_graph": {
      "description": "符号引用图分析结果",
      "orphan_symbols_fixed": [
        {
          "symbol": "get_active_threshold()",
          "template": "T2_008",
          "file": "src-tauri/src/database/settings.rs",
          "status": "✅ 已修复"
        },
        {
          "symbol": "update_active_threshold()",
          "template": "T2_008",
          "file": "src-tauri/src/database/settings.rs",
          "status": "✅ 已修复"
        },
        {
          "symbol": "is_scan_cache_enabled()",
          "template": "T2_008",
          "file": "src-tauri/src/database/settings.rs",
          "status": "✅ 已修复"
        },
        {
          "symbol": "set_scan_cache_enabled()",
          "template": "T2_008",
          "file": "src-tauri/src/database/settings.rs",
          "status": "✅ 已修复"
        }
      ]
    },
    "configuration_closure": {
      "description": "配置闭环验证结果（v6.0 增强）",
      "closed_loops": [
        {
          "config": "active_threshold",
          "closure_status": "✅ 完整闭环",
          "definition": "wave2.2:91-112",
          "storage": "Wave 1 migrate_v6 (settings.active_threshold)",
          "read_function": "T2_008 get_active_threshold()",
          "write_function": "T2_008 update_active_threshold()",
          "ui": "待实现（未来在设置页面）"
        },
        {
          "config": "scan_cache_enabled",
          "closure_status": "✅ 完整闭环 (v6.0 修复)",
          "definition": "wave2.2:173-182",
          "storage": "Wave 2 migrate_v12 (settings.scan_cache_enabled) - T2_009",
          "read_function": "T2_008 is_scan_cache_enabled()",
          "write_function": "T2_008 set_scan_cache_enabled()",
          "ui": "待实现（未来在设置页面）"
        }
      ]
    },
    "conflict_matrix": {
      "description": "跨文件冲突矩阵（v6.0 新增）",
      "resolved_conflicts": [
        {
          "entity": "T1_2.dependencies",
          "file_a": "wave2.2 (v5.0)",
          "value_a": "[\"T1_1\", \"T1_3\"]",
          "file_b": "wave2_core (旧版)",
          "value_b": "[\"T1_1\"]",
          "resolution": "采用 v5.0 修复，添加 T1_3 依赖",
          "status": "✅ 已解决"
        },
        {
          "entity": "scan_cache_enabled 创建时机",
          "file_a": "wave2_core (旧版)",
          "value_a": "\"Wave 2 或 Wave 3\"",
          "file_b": "wave2.3 (v6.0)",
          "value_b": "\"Wave 2 migrate_v12\"",
          "resolution": "明确在 Wave 2 中创建，消除模糊描述",
          "status": "✅ 已解决"
        }
      ]
    },
    "data_flow_topology": {
      "description": "数据流拓扑（v6.0 验证）",
      "validated_flows": [
        {
          "resource": "Session.rating",
          "producer": "T1_3 (migrate_v9)",
          "transmission": "models.rs",
          "consumer": "T1_2 (scanner)",
          "status": "✅ 连续"
        },
        {
          "resource": "scan_sessions_with_timeout",
          "producer": "T1_2 (Step 7)",
          "transmission": "scanner.rs",
          "consumer": "T1_PERF (Step 8)",
          "status": "✅ 连续"
        },
        {
          "resource": "settings.active_threshold",
          "producer": "Wave 1 (migrate_v6)",
          "transmission": "settings.rs",
          "consumer": "T1_2 (is_session_active)",
          "status": "✅ 连续 (v6.0 补全读取函数)"
        },
        {
          "resource": "settings.scan_cache_enabled",
          "producer": "Wave 2 (migrate_v12)",
          "transmission": "settings.rs",
          "consumer": "T1_2 (缓存逻辑)",
          "status": "✅ 连续 (v6.0 新增)"
        }
      ]
    }
  },
  "_v3_analysis_retained": {
    "concurrency_conflicts": {
      "rule_8": "并发冲突检测",
      "analysis": {
        "conflicts_detected": [
          {
            "files": [
              "src-tauri/src/database/models.rs"
            ],
            "tasks": [
              "T1_2",
              "T1_3"
            ],
            "conflict_type": "两个任务可能修改同一个数据模型文件",
            "resolution": "T1_3 更新 Session 结构体字段，T1_2 不直接修改 models.rs，而是通过 scanner.rs 引用模型。建议先执行 T1_3 完成模型更新，再执行 T1_2"
          }
        ],
        "parallel_safe_tasks": [
          {
            "tasks": [
              "T1_2",
              "T1_3"
            ],
            "condition": "如果需要并行开发，T1_2 可以先使用临时结构体，待 T1_3 完成后合并",
            "recommendation": "建议串行执行：T1_3 → T1_2，因为 T1_2 依赖完整的 Session 模型"
          }
        ]
      }
    },
    "data_structure_analysis": {
      "rule_12": "数据结构重复性分析",
      "duplicate_analysis": [
        {
          "structures": [
            "SessionMetadata",
            "Session"
          ],
          "overlap_percentage": "75%",
          "shared_fields": [
            "session_id",
            "project_path",
            "created_at",
            "updated_at",
            "is_active"
          ],
          "session_metadata_only": [
            "file_path",
            "message_count"
          ],
          "session_only": [
            "id",
            "rating",
            "tags",
            "is_archived"
          ],
          "rationale": {
            "purpose_difference": "SessionMetadata 是扫描器使用的临时轻量级结构（仅读取），Session 是数据库持久化模型（完整信息）",
            "lifecycle_difference": "SessionMetadata 临时创建，用完即弃；Session 存储在数据库，长期保存",
            "why_not_merge": "分离避免从数据库读取不必要的数据，提高扫描性能"
          }
        },
        {
          "structures": [
            "SessionMeta",
            "Session"
          ],
          "overlap_percentage": "100%",
          "note": "SessionMeta 是 Session 的前端视图（camelCase 命名），通过 serde 序列化转换。这是合理的，因为 Rust 使用 snake_case，前端使用 camelCase"
        }
      ]
    },
    "platform_compatibility": {
      "rule_7": "平台/版本兼容性检查",
      "platform_specific_features": [
        {
          "feature": "活跃会话检测 - 文件锁定检测",
          "platforms": {
            "windows": "使用 Windows API (CreateFileW with share_mode=0)",
            "macos": "降级到时间判断（使用 get_active_threshold() 读取配置）",
            "linux": "降级到时间判断（使用 get_active_threshold() 读取配置）"
          },
          "implementation_location": "wave2.2_task_t1_2.json Step 3",
          "fallback_strategy": "所有平台都支持基于时间的降级方案，通过 T2_008 模板读取配置"
        }
      ],
      "version_dependencies": [
        {
          "dependency": "SQLite DROP COLUMN support",
          "minimum_version": "3.35.5",
          "current_usage": "ALTER TABLE ... DROP COLUMN (in rollback plan)",
          "compatibility_check": {
            "check_code": "SELECT sqlite_version();",
            "fallback": "如果版本 < 3.35.5，使用重建表方案（CREATE TABLE AS SELECT）",
            "implementation_location": "wave2.3_task_t1_3.json rollback_plan"
          }
        }
      ]
    }
  },
  "key_features": {
    "session_scanner": {
      "description": "扫描 Claude 会话文件并提取元数据",
      "capabilities": [
        "递归扫描 ~/.claude/projects/ 目录",
        "从文件名提取 session_id（UUID）",
        "从文件路径提取 project_path",
        "读取文件元数据（created_at, updated_at）",
        "判断会话活跃状态（Windows 锁定检测 + 时间判断，使用 get_active_threshold() 读取配置）",
        "并行扫描优化（rayon）",
        "超时保护机制（v5.0 新增）"
      ]
    },
    "database_extensions": {
      "description": "扩展数据库表结构支持新功能",
      "changes": [
        "sessions 表：添加 rating, tags, is_archived 字段",
        "saved_prompts 表：存储用户保存的提示词",
        "meta_templates 表：存储系统提示词模板",
        "settings 表：添加 scan_cache_enabled 字段（v6.0 新增）"
      ]
    },
    "settings_module": {
      "description": "Settings 模块（v6.0 新增）",
      "functions": [
        "get_active_threshold() - 读取活跃阈值",
        "update_active_threshold() - 更新活跃阈值",
        "is_scan_cache_enabled() - 读取缓存状态",
        "set_scan_cache_enabled() - 设置缓存状态"
      ],
      "template_reference": "T2_008"
    },
    "performance_testing": {
      "description": "验证应用性能达标",
      "targets": [
        "启动时间 < 3 秒",
        "100 个会话扫描 < 2 秒",
        "内存占用 < 200MB"
      ],
      "v4_1_additions": [
        "文件锁定检测测试",
        "数据库回滚机制测试",
        "SQLite 版本兼容性测试",
        "超时处理测试"
      ]
    }
  },
  "_v60_fixes_summary": {
    "description": "v6.0 版本修复详情（2025-12-29）",
    "virtual_execution_analysis": {
      "tool": "v6.0 虚拟执行引擎",
      "report": "wave2_v6_virtual_execution_report.md",
      "issues_found": 8,
      "issues_fixed": 5,
      "critical_fixed": 1,
      "overall_score_improvement": "7.5/10 → 9/10"
    },
    "new_templates": {
      "T2_008": "Settings 模块 - 修复 4 个符号孤岛（get/update_active_threshold, is/set_scan_cache_enabled）",
      "T2_009": "迁移 v12 - 添加 scan_cache_enabled 字段，完成配置闭环",
      "T2_010": "SessionRepository - upsert_session 方法实现"
    },
    "updated_tasks": {
      "wave2.3": "新增 Step 6 (migrate_v12)，明确 scan_cache_enabled 创建时机",
      "wave2.2": "引用 T2_008 模板的 settings 函数（已通过模板引用解决）"
    },
    "symbol_reference_integrity": {
      "status": "✅ 所有符号引用完整",
      "orphan_symbols_before": 4,
      "orphan_symbols_after": 0
    },
    "configuration_closure": {
      "status": "✅ 所有配置闭环完整",
      "gaps_before": 2,
      "gaps_after": 0
    },
    "validation": {
      "status": "所有 19 维检查规则已通过 ✅ (基础6 + 增强7 + v3.1的3 + v6.0的3)",
      "ai_ready": true,
      "safe_to_execute": true,
      "notes": "v6.0 版本可直接供 Claude Code (AI) 安全执行"
    }
  },
  "_version_history": {
    "v1.0": "初始版本",
    "v2.0": "基于 6 维检查规则优化",
    "v3.0": "基于 13 维检查规则优化",
    "v3.1": "基于 16 维检查规则优化",
    "v5.0": "修复依赖倒置（T1_2 添加 T1_3 依赖），补充超时机制",
    "v6.0": "基于虚拟执行引擎优化，修复符号孤岛和配置闭环，新增 3 个模板，总体评分 9/10",
    "v10.0": "基于五维深度审计引擎优化，修复语义覆盖率缺口（T2_006 模板添加 1000 会话压力测试），总体评分 9.7/10"
  },
  "_migration_guide": {
    "from_v60_to_v100": {
      "description": "从 v6.0 升级到 v10.0 的迁移指南",
      "changes_summary": "修复语义覆盖率缺口，添加 1000 会话压力测试支持",
      "steps": [
        "1. wave2.7_templates_v6.0.json 已更新 T2_006 模板，添加 setup_stress_test_environment() 函数",
        "2. wave2.4_task_t1_perf.json 已添加 test_session_scan_time_1000_stress 测试用例",
        "3. wave2_phase1_core.json 已更新为 v10.0，包含五维深度审计分析",
        "4. success_criteria 新增压力测试目标：1000 会话扫描 < 10 秒"
      ],
      "new_functions": [
        "setup_stress_test_environment(session_count: usize) -> Vec<PathBuf>",
        "cleanup_stress_test_environment()",
        "test_session_scan_time_1000_stress()"
      ],
      "backwards_compatibility": "✅ 完全兼容，所有 v6.0 功能保留",
      "rollback": "如需回滚到 v6.0，保留原文件备份"
    },
    "from_v31": {
      "step_1": "wave2.7_templates.json 已包含 v6.0 模板 (T2_008/T2_009/T2_010)",
      "step_2": "wave2.3_task_t1_3.json 已包含 Step 6 (migrate_v12)",
      "step_3": "wave2.4_task_t1_perf.json 已完成",
      "step_4": "阅读 wave2_v6_virtual_execution_report.md 了解详细分析",
      "step_5": "验证 T1_2 任务依赖 T1_3（已在 sequential_tasks 中更新）"
    },
    "rollback": "如需回滚到 v3.1，保留原文件备份：wave2_phase1_core.json.backup_v31"
  }
}
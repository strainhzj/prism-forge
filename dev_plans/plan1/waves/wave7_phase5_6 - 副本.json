{
  "wave_id": "WAVE_7",
  "name": "第七波：PHASE_5 UI 增强与 PHASE_6 测试发布",
  "description": "实现代码 Diff、提示词实验室、导出功能，以及测试与发布",
  "branch": {
    "name": "feat/phase5-6-wave7",
    "base": "master",
    "strategy": "feature_branch",
    "depends_on": ["feat/phase4-wave6"]
  },
  "parallel_groups": [
    {
      "group_id": "GROUP_A_PHASE5",
      "name": "PHASE_5 UI 增强",
      "description": "代码 Diff、提示词实验室、导出、归档管理",
      "sub_branch": "feat/phase5-6-wave7-phase5",
      "sequential_tasks": [
        {
          "task_id": "T5_1a",
          "name": "集成 Monaco Editor 基础",
          "assignee": "frontend",
          "estimated_hours": 8,
          "priority": "high",
          "status": "pending",
          "requirement_ref": ["F4.5"],
          "dependencies": ["T4_2"],
          "output_artifacts": [
            "src/components/MonacoEditor.tsx",
            "src/components/CodeViewer.tsx"
          ],
          "implementation_steps": [
            {
              "step": 1,
              "title": "安装 Monaco Editor",
              "description": "添加 @monaco-editor/react",
              "commands": ["npm install @monaco-editor/react"],
              "verification": "组件正常渲染"
            },
            {
              "step": 2,
              "title": "配置编辑器",
              "description": "配置 TypeScript 语法高亮和主题",
              "config": {
                "theme": "vs-dark",
                "language": "typescript",
                "options": {
                  "minimap": "enabled",
                  "scrollBeyondLastLine": "false",
                  "readOnly": "true"
                }
              },
              "verification": "编辑器正确显示代码"
            },
            {
              "step": 3,
              "title": "集成到消息节点",
              "description": "在代码块中使用 Monaco 替代 pre",
              "verification": "代码高亮正常"
            }
          ],
          "acceptance_criteria": [
            "AC1: 消息中的代码块支持语法高亮",
            "AC2: 支持行号",
            "AC3: 深色主题正确应用",
            "AC4: 只读模式"
          ]
        },
        {
          "task_id": "T5_1b",
          "name": "实现代码变更检测",
          "assignee": "frontend",
          "estimated_hours": 10,
          "priority": "high",
          "status": "pending",
          "requirement_ref": ["F4.5"],
          "dependencies": ["T2_3"],
          "output_artifacts": [
            "src/utils/codeChangeExtractor.ts"
          ],
          "implementation_steps": [
            {
              "step": 1,
              "title": "解析 Write/Edit 工具调用",
              "description": "提取 oldText 和 newText",
              "logic": [
                "从 MessageNode.metadata.code_changes 获取",
                "解析 oldText 和 newText 字段"
              ],
              "verification": "正确提取代码变更"
            },
            {
              "step": 2,
              "title": "存储变更信息",
              "description": "关联到消息节点",
              "data_structure": {
                "file_path": "string",
                "old_text": "string",
                "new_text": "string",
                "start_line": "number",
                "end_line": "number"
              },
              "verification": "数据结构正确"
            }
          ],
          "acceptance_criteria": [
            "AC1: 能正确识别代码变更",
            "AC2: 能提取新旧代码",
            "AC3: 数据关联到消息节点"
          ]
        },
        {
          "task_id": "T5_1c",
          "name": "实现 Diff 视图渲染",
          "assignee": "frontend",
          "estimated_hours": 12,
          "priority": "high",
          "status": "pending",
          "requirement_ref": ["F4.5"],
          "dependencies": ["T5_1a", "T5_1b"],
          "output_artifacts": [
            "src/components/DiffViewer.tsx"
          ],
          "implementation_steps": [
            {
              "step": 1,
              "title": "安装 Diff 组件",
              "description": "添加 react-diff-viewer-continued",
              "commands": ["npm install react-diff-viewer-continued"],
              "verification": "组件正常渲染"
            },
            {
              "step": 2,
              "title": "实现 Diff 视图",
              "description": "显示代码对比",
              "features": [
                "并排模式",
                "统一模式",
                "语法高亮",
                "行号"
              ],
              "verification": "Diff 正确显示"
            },
            {
              "step": 3,
              "title": "性能验证",
              "description": "大文件 Diff 性能测试",
              "test": "> 1000 行代码无明显卡顿",
              "verification": "性能达标"
            }
          ],
          "acceptance_criteria": [
            "AC1: 消息中的代码变更支持高亮 Diff 对比",
            "AC2: 大文件（>1000 行）无明显卡顿",
            "AC3: 支持并排/统一模式切换"
          ]
        },
        {
          "task_id": "T5_2",
          "name": "提示词实验室 UI",
          "assignee": "frontend",
          "estimated_hours": 18,
          "priority": "high",
          "status": "pending",
          "requirement_ref": ["F4.3", "F9"],
          "dependencies": ["T3_3", "T4_3"],
          "output_artifacts": [
            "src/pages/PromptLab.tsx",
            "src/components/PromptBuilder.tsx"
          ],
          "implementation_steps": [
            {
              "step": 1,
              "title": "创建提示词实验室页面",
              "description": "新页面路由",
              "route": "/prompt-lab",
              "layout": "双栏布局（Builder + Library）",
              "verification": "页面正常渲染"
            },
            {
              "step": 2,
              "title": "实现 Prompt Builder",
              "description": "目标输入、会话选择、生成按钮",
              "components": [
                "GoalInput - 目标输入",
                "SessionSelector - 会话选择器",
                "GenerateButton - 生成按钮",
                "ResultPreview - 结果预览",
                "TokenStats - Token 统计",
                "ActionButtons - 复制/保存按钮"
              ],
              "verification": "功能正常"
            },
            {
              "step": 3,
              "title": "集成 optimize_prompt",
              "description": "调用后端 API",
              "api": "optimize_prompt",
              "flow": [
                "输入目标",
                "选择会话（可选）",
                "点击生成",
                "显示结果",
                "显示节省的 Token 百分比"
              ],
              "verification": "完整流程正常"
            }
          ],
          "acceptance_criteria": [
            "AC1: 能生成提示词",
            "AC2: 显示节省的 Token 百分比",
            "AC3: 支持复制和保存",
            "AC4: UI 响应式设计"
          ]
        },
        {
          "task_id": "T5_3",
          "name": "提示词库管理 UI",
          "assignee": "frontend",
          "estimated_hours": 14,
          "priority": "medium",
          "status": "pending",
          "requirement_ref": ["F9.1", "F9.2"],
          "dependencies": ["T3_5"],
          "output_artifacts": [
            "src/components/PromptLibrary.tsx",
            "src/components/PromptCard.tsx"
          ],
          "implementation_steps": [
            {
              "step": 1,
              "title": "实现三栏布局",
              "description": "Next Goals / AI Analysis / Meta Templates",
              "tabs": [
                "Next Goals - 用户输入的任务",
                "AI Analysis - 系统分析结果",
                "Meta Templates - 系统 Prompt"
              ],
              "verification": "布局正确"
            },
            {
              "step": 2,
              "title": "实现卡片列表",
              "description": "显示提示词卡片",
              "card_content": [
                "标题",
                "内容预览",
                "评分（星级）",
                "使用次数",
                "创建时间"
              ],
              "verification": "卡片正确显示"
            },
            {
              "step": 3,
              "title": "实现管理功能",
              "description": "搜索、筛选、编辑、删除",
              "features": [
                "搜索标题和内容",
                "按分类筛选",
                "按评分排序",
                "编辑内容",
                "删除"
              ],
              "verification": "功能正常"
            }
          ],
          "acceptance_criteria": [
            "AC1: 能管理所有生成的提示词",
            "AC2: 能管理 Meta Template",
            "AC3: 支持搜索和筛选",
            "AC4: 支持编辑和删除"
          ]
        },
        {
          "task_id": "T5_4",
          "name": "实现数据导出功能",
          "assignee": "frontend",
          "estimated_hours": 10,
          "priority": "medium",
          "status": "pending",
          "requirement_ref": ["F5.4", "F8.2"],
          "dependencies": ["T3_4"],
          "output_artifacts": [
            "src/components/ExportDialog.tsx",
            "src/utils/exporters.ts"
          ],
          "implementation_steps": [
            {
              "step": 1,
              "title": "实现导出工具",
              "description": "支持 JSON/CSV/Markdown",
              "formats": [
                "JSON - 完整数据",
                "CSV - 表格格式",
                "Markdown - 可读文档"
              ],
              "verification": "各格式正确导出"
            },
            {
              "step": 2,
              "title": "创建导出对话框",
              "description": "格式选择器和选项",
              "components": [
                "ExportDialog - 主对话框",
                "FormatSelector - 格式选择",
                "OptionPanel - 选项面板（视图等级等）"
              ],
              "verification": "对话框正常工作"
            },
            {
              "step": 3,
              "title": "集成后端 API",
              "description": "调用 export_session",
              "api": "export_session",
              "flow": [
                "选择格式",
                "选择选项",
                "确认导出",
                "下载文件"
              ],
              "verification": "导出流程正常"
            }
          ],
          "acceptance_criteria": [
            "AC1: 能导出单条会话",
            "AC2: 能批量导出",
            "AC3: 支持多种格式",
            "AC4: 文件正确下载"
          ]
        },
        {
          "task_id": "T5_5",
          "name": "归档管理 UI",
          "assignee": "frontend",
          "estimated_hours": 8,
          "priority": "medium",
          "status": "pending",
          "requirement_ref": ["F7.4"],
          "dependencies": ["T2B_3", "T4_1"],
          "output_artifacts": [
            "src/components/ArchiveManager.tsx"
          ],
          "implementation_steps": [
            {
              "step": 1,
              "title": "添加归档按钮",
              "description": "在会话列表添加归档/取消归档",
              "placement": "会话卡片操作栏",
              "verification": "按钮正常显示"
            },
            {
              "step": 2,
              "title": "创建归档标签页",
              "description": "单独的「已归档」标签页",
              "tab": "已归档",
              "content": "归档会话列表",
              "verification": "标签页正常工作"
            },
            {
              "step": 3,
              "title": "集成后端 API",
              "description": "调用归档命令",
              "commands": [
                "archive_session",
                "unarchive_session",
                "get_archived_sessions"
              ],
              "verification": "API 调用正常"
            }
          ],
          "acceptance_criteria": [
            "AC1: 归档会话不在主列表显示",
            "AC2: 可在归档页查看",
            "AC3: 可取消归档",
            "AC4: 支持批量归档"
          ]
        }
      ]
    },
    {
      "group_id": "GROUP_B_PHASE6",
      "name": "PHASE_6 测试与发布",
      "description": "端到端测试、性能优化、打包发布",
      "sub_branch": "feat/phase5-6-wave7-phase6",
      "parallel_with": "GROUP_A_PHASE5",
      "sequential_tasks": [
        {
          "task_id": "T6_1",
          "name": "端到端测试",
          "assignee": "qa",
          "estimated_hours": 20,
          "priority": "high",
          "status": "pending",
          "requirement_ref": ["NF1", "NF2"],
          "dependencies": ["T5_5"],
          "output_artifacts": [
            "tests/e2e/**/*.test.ts",
            "tests/e2e/test-plan.md"
          ],
          "implementation_steps": [
            {
              "step": 1,
              "title": "设置 E2E 测试框架",
              "description": "使用 Playwright 或类似工具",
              "tool": "Playwright for Tauri",
              "verification": "框架正常工作"
            },
            {
              "step": 2,
              "title": "编写测试用例",
              "description": "覆盖核心流程",
              "scenarios": [
                "扫描 -> 检索 -> 优化 -> 导出",
                "设置 Provider -> 测试连接 -> 生成提示词",
                "会话评分 -> 标签管理 -> 归档",
                "实时监控 -> 自动刷新"
              ],
              "verification": "所有测试通过"
            }
          ],
          "acceptance_criteria": [
            "AC1: 所有核心功能测试通过",
            "AC2: 测试覆盖率 > 80%",
            "AC3: 无阻塞性 bug"
          ]
        },
        {
          "task_id": "T6_2",
          "name": "性能优化",
          "assignee": "backend",
          "estimated_hours": 16,
          "priority": "high",
          "status": "pending",
          "requirement_ref": ["NF1"],
          "dependencies": ["T6_1"],
          "output_artifacts": [
            "docs/optimization-report.md"
          ],
          "implementation_steps": [
            {
              "step": 1,
              "title": "性能分析",
              "description": "分析瓶颈",
              "tools": [
                "Chrome DevTools (前端)",
                "flamegraph (Rust 后端)",
                "dhat (内存分析)"
              ],
              "verification": "识别瓶颈"
            },
            {
              "step": 2,
              "title": "优化向量检索",
              "description": "索引优化、查询优化",
              "optimizations": [
                "添加合适的索引",
                "优化 SQL 查询",
                "使用连接池"
              ],
              "verification": "检索性能提升"
            },
            {
              "step": 3,
              "title": "优化前端渲染",
              "description": "消息树、列表性能",
              "optimizations": [
                "虚拟滚动",
                "React.memo",
                "懒加载",
                "代码分割"
              ],
              "verification": "渲染性能提升"
            }
          ],
          "acceptance_criteria": [
            "AC1: 所有 NF1 性能指标达标",
            "AC2: 性能测试报告完成",
            "AC3: 无明显内存泄漏"
          ]
        },
        {
          "task_id": "T6_3",
          "name": "Windows 打包与签名",
          "assignee": "devops",
          "estimated_hours": 12,
          "priority": "high",
          "status": "pending",
          "dependencies": ["T6_2"],
          "output_artifacts": [
            "src-tauri/target/release/prism-forge_*.msi",
            "src-tauri/target/release/prism-forge_*.exe"
          ],
          "implementation_steps": [
            {
              "step": 1,
              "title": "配置打包",
              "description": "更新 tauri.conf.json",
              "config": {
                "bundle": {
                  "identifier": "com.prismforge.app",
                  "icon": ["icons/icon.ico"],
                  "copyright": "Copyright © 2025",
                  "category": "Developer Tool",
                  "short_description": "Claude Code Session Monitor",
                  "long_description": "Monitor and optimize your Claude Code sessions"
                }
              },
              "verification": "配置正确"
            },
            {
              "step": 2,
              "title": "构建安装包",
              "description": "使用 Tauri CLI 构建",
              "commands": [
                "npm run tauri build"
              ],
              "output": ".msi 或 .exe 文件",
              "verification": "构建成功"
            },
            {
              "step": 3,
              "title": "代码签名（可选）",
              "description": "配置证书",
              "tools": [
                "signtool (Windows)",
                "certificates"
              ],
              "verification": "签名正确"
            }
          ],
          "acceptance_criteria": [
            "AC1: 生成 .msi 或 .exe 安装包",
            "AC2: 体积 < 15MB",
            "AC3: 安装包能正常安装",
            "AC4: 应用能正常运行"
          ]
        },
        {
          "task_id": "T6_4",
          "name": "文档与发布",
          "assignee": "tech-writer",
          "estimated_hours": 16,
          "priority": "medium",
          "status": "pending",
          "dependencies": ["T6_3"],
          "output_artifacts": [
            "README.md",
            "docs/USER_MANUAL.md",
            "docs/API.md",
            "CHANGELOG.md"
          ],
          "implementation_steps": [
            {
              "step": 1,
              "title": "编写用户手册",
              "description": "完整的使用指南",
              "sections": [
                "安装指南",
                "快速开始",
                "功能说明",
                "常见问题",
                "故障排除"
              ],
              "verification": "文档完整"
            },
            {
              "step": 2,
              "title": "编写 API 文档",
              "description": "后端命令 API",
              "content": [
                "所有 Tauri Commands",
                "参数说明",
                "返回格式",
                "示例代码"
              ],
              "verification": "API 文档完整"
            },
            {
              "step": 3,
              "title": "创建 GitHub Release",
              "description": "发布 v1.0.0",
              "assets": [
                "安装包",
                "源代码",
                "文档"
              ],
              "verification": "Release 创建成功"
            }
          ],
          "acceptance_criteria": [
            "AC1: 文档完整",
            "AC2: 正式发布 v1.0.0",
            "AC3: Release Notes 清晰"
          ]
        }
      ]
    }
  ],
  "verification_checkpoints": [
    {
      "checkpoint_id": "CP_WAVE7_DIFF",
      "name": "Diff 功能验证",
      "actions": [
        "打开包含代码变更的会话",
        "查看 Diff 视图"
      ],
      "expected_outputs": [
        "Diff 正确显示",
        "代码高亮正常",
        "大文件性能良好"
      ]
    },
    {
      "checkpoint_id": "CP_WAVE7_LAB",
      "name": "提示词实验室验证",
      "actions": [
        "打开提示词实验室",
        "生成优化提示词"
      ],
      "expected_outputs": [
        "生成流程正常",
        "显示 Token 统计",
        "支持复制和保存"
      ]
    },
    {
      "checkpoint_id": "CP_WAVE7_BUILD",
      "name": "打包验证",
      "actions": [
        "运行 npm run tauri build",
        "检查输出文件"
      ],
      "expected_outputs": [
        "生成安装包",
        "体积 < 15MB",
        "能正常安装运行"
      ]
    }
  ],
  "git_strategy": {
    "workflow": "parallel_groups",
    "steps": [
      "1. 从 feat/phase4-wave6 创建 feat/phase5-6-wave7 主分支",
      "2. 并行创建两个组分支（PHASE_5 和 PHASE_6）",
      "3. PHASE_5 内按顺序完成，PHASE_6 依赖 PHASE_5 全部完成",
      "4. 所有任务完成后合并到 master"
    ]
  },
  "deliverables": [
    "完整的 UI 增强（Diff、实验室、导出、归档）",
    "端到端测试套件",
    "性能优化报告",
    "Windows 安装包",
    "完整文档",
    "v1.0.0 Release"
  ],
  "risks_and_mitigations": [
    {
      "risk": "Monaco Editor 打包体积过大",
      "probability": "medium",
      "impact": "medium",
      "mitigation": "使用动态加载、仅加载必需语言"
    },
    {
      "risk": "E2E 测试不稳定",
      "probability": "medium",
      "impact": "low",
      "mitigation": "添加重试机制、合理等待时间"
    },
    {
      "risk": "Windows 签名证书获取困难",
      "probability": "low",
      "impact": "low",
      "mitigation": "跳过签名，提示用户信任发布者"
    }
  ]
}

{
  "wave_id": "WAVE_4",
  "name": "第四波：PHASE_2 剩余任务与向量嵌入",
  "description": "完成向量嵌入生成、文件监控、以及 T3_4 日志提取引擎",
  "branch": {
    "name": "feat/phase2-wave4",
    "base": "master",
    "strategy": "feature_branch",
    "depends_on": ["feat/phase2-wave3"]
  },
  "parallel_tasks": [
    {
      "task_id": "T2_4",
      "name": "集成 FastEmbed 生成向量",
      "sub_branch": "feat/phase2-wave4-t2_4",
      "assignee": "backend",
      "estimated_hours": 16,
      "priority": "critical",
      "status": "pending",
      "requirement_ref": ["F2.5"],
      "dependencies": ["T1_1", "T2_3"],
      "output_artifacts": [
        "src-tauri/src/embedding/mod.rs",
        "src-tauri/src/embedding/generator.rs"
      ],
      "implementation_steps": [
        {
          "step": 1,
          "title": "添加 FastEmbed 依赖",
          "description": "在 Cargo.toml 添加 fastembed",
          "commands": ["添加: fastembed = \"3.3\""],
          "verification": "cargo check 编译通过"
        },
        {
          "step": 2,
          "title": "实现 EmbeddingGenerator",
          "description": "创建向量生成器",
          "files": ["src-tauri/src/embedding/generator.rs"],
          "functions": [
            "pub struct EmbeddingGenerator { model: EmbeddingModel }",
            "pub fn new() -> Result<Self>",
            "pub fn generate_for_message(&self, content: &str) -> Result<Vec<f32>>",
            "pub fn generate_batch(&self, contents: &[String]) -> Result<Vec<Vec<f32>>>"
          ],
          "model_config": {
            "model_name": "BGE-small-en-v1.5-quantized",
            "dimensions": 384,
            "max_length": 512
          },
          "verification": "能生成 384 维向量"
        },
        {
          "step": 3,
          "title": "集成到解析流程",
          "description": "解析新消息时自动生成向量",
          "integration": "在 JsonlParser 中添加嵌入生成",
          "logic": [
            "1. 解析消息",
            "2. 生成 summary",
            "3. 异步生成向量",
            "4. 存入 message_embeddings 表"
          ],
          "verification": "数据库中有向量数据"
        },
        {
          "step": 4,
          "title": "测试向量检索",
          "description": "验证向量距离查询",
          "test_sql": [
            "SELECT distance(me.embedding, ?) FROM message_embeddings me LIMIT 5"
          ],
          "verification": "能正确计算余弦相似度"
        }
      ],
      "acceptance_criteria": [
        "AC1: message_embeddings 表有 BLOB 数据",
        "AC2: 能执行距离查询",
        "AC3: 向量维度为 384",
        "AC4: 生成速度：100 条消息 < 30 秒"
      ],
      "testing_checklist": [
        "TC2.4.1: 测试单条向量生成",
        "TC2.4.2: 测试批量向量生成",
        "TC2.4.3: 测试向量存储",
        "TC2.4.4: 测试向量距离查询",
        "TC2.4.5: 测试模型加载性能"
      ]
    },
    {
      "task_id": "T2_6",
      "name": "实现文件实时监控",
      "sub_branch": "feat/phase2-wave4-t2_6",
      "assignee": "backend",
      "estimated_hours": 14,
      "priority": "high",
      "status": "pending",
      "requirement_ref": ["F1.2", "F4.4"],
      "dependencies": ["T1_2"],
      "output_artifacts": [
        "src-tauri/src/monitor/watcher.rs"
      ],
      "implementation_steps": [
        {
          "step": 1,
          "title": "添加 notify 依赖",
          "description": "在 Cargo.toml 添加 notify",
          "commands": ["添加: notify = \"6.1\""],
          "verification": "cargo check 编译通过"
        },
        {
          "step": 2,
          "title": "实现文件监控器",
          "description": "使用 notify crate 监控目录变更",
          "files": ["src-tauri/src/monitor/watcher.rs"],
          "functions": [
            "pub struct SessionWatcher { watcher: RecommendedWatcher, tx: mpsc::Sender<WatchEvent> }",
            "pub fn new() -> Result<Self>",
            "pub fn start(&self) -> Result<JoinHandle<()>>"
          ],
          "watch_logic": [
            "1. 监控 ~/.claude/projects/ 目录",
            "2. 检测 CREATE 和 MODIFY 事件",
            "3. 过滤非 .jsonl 文件",
            "4. 发送事件到通道"
          ],
          "verification": "能检测文件变更"
        },
        {
          "step": 3,
          "title": "事件去重与防抖",
          "description": "2 秒延迟处理事件",
          "debounce_logic": [
            "1. 收集事件到缓冲区",
            "2. 等待 2 秒无新事件",
            "3. 批量处理事件",
            "4. 更新数据库"
          ],
          "verification": "不会重复触发"
        },
        {
          "step": 4,
          "title": "通过 Tauri Events 推送",
          "description": "将变更推送到前端",
          "functions": [
            "app.emit('sessions-changed', payload)"
          ],
          "verification": "前端能收到事件"
        }
      ],
      "acceptance_criteria": [
        "AC1: Claude Code 创建新会话后，2 秒内前端列表自动更新",
        "AC2: 写入新消息后触发更新",
        "AC3: 事件去重生效（不会重复触发）",
        "AC4: 监控器崩溃不影响其他功能"
      ],
      "testing_checklist": [
        "TC2.6.1: 测试文件创建检测",
        "TC2.6.2: 测试文件修改检测",
        "TC2.6.3: 测试事件去重",
        "TC2.6.4: 测试防抖延迟",
        "TC2.6.5: 测试监控恢复（崩溃后重启）"
      ]
    },
    {
      "task_id": "T3_4",
      "name": "实现日志提取引擎",
      "sub_branch": "feat/phase2-wave4-t3_4",
      "assignee": "backend",
      "estimated_hours": 12,
      "priority": "high",
      "status": "pending",
      "requirement_ref": ["F8.1", "F8.2"],
      "dependencies": ["T2_3"],
      "output_artifacts": [
        "src-tauri/src/parser/extractor.rs (扩展)",
        "src-tauri/src/commands.rs (导出命令)"
      ],
      "implementation_steps": [
        {
          "step": 1,
          "title": "定义提取等级",
          "description": "定义 L1/L2/L3 三级视图",
          "files": ["src-tauri/src/parser/extractor.rs"],
          "levels": [
            "L1 (Full Trace): 包含所有内容",
            "L2 (Clean Flow): 过滤工具参数和中间输出",
            "L3 (Prompt Only): 仅 User Query 和 Final Answer"
          ],
          "verification": "等级定义清晰"
        },
        {
          "step": 2,
          "title": "实现提取逻辑",
          "description": "根据等级提取不同内容",
          "functions": [
            "pub fn extract(&self, nodes: &[MessageNode], level: ExtractionLevel) -> String"
          ],
          "extraction_rules": {
            "L1": "保留所有节点，完整渲染",
            "L2": "过滤 tool_input 和 tool_output，保留 tool_use 和 result",
            "L3": "仅保留 User 和叶子 Assistant 节点"
          },
          "verification": "各级提取正确"
        },
        {
          "step": 3,
          "title": "实现导出功能",
          "description": "导出为 Markdown/JSON",
          "functions": [
            "pub fn export_markdown(&self, content: &str, path: &Path) -> Result<()>",
            "pub fn export_json(&self, content: &ExtractedContext, path: &Path) -> Result<()>"
          ],
          "verification": "导出文件格式正确"
        },
        {
          "step": 4,
          "title": "创建 Tauri Commands",
          "description": "暴露提取和导出命令",
          "files": ["src-tauri/src/commands.rs"],
          "commands": [
            "extract_session(session_id: String, level: ExtractionLevel) -> Result<String>",
            "export_session(session_id: String, format: ExportFormat) -> Result<String>"
          ],
          "verification": "前端可调用提取和导出"
        }
      ],
      "acceptance_criteria": [
        "AC1: 能以三种等级提取日志",
        "AC1.1: L1 包含全部内容",
        "AC1.2: L2 过滤冗余工具输出",
        "AC1.3: L3 仅包含 QA 对",
        "AC2: 能导出为 Markdown",
        "AC3: 能导出为 JSON",
        "AC4: 导出内容可读性好"
      ],
      "testing_checklist": [
        "TC3.4.1: 测试 L1 完整提取",
        "TC3.4.2: 测试 L2 清理提取",
        "TC3.4.3: 测试 L3 精简提取",
        "TC3.4.4: 测试 Markdown 导出",
        "TC3.4.5: 测试 JSON 导出"
      ]
    }
  ],
  "verification_checkpoints": [
    {
      "checkpoint_id": "CP_WAVE4_EMBEDDING",
      "name": "向量嵌入验证",
      "commands": [
        "SELECT COUNT(*) FROM message_embeddings;"
      ],
      "expected_outputs": [
        "向量表有记录（> 0）"
      ]
    },
    {
      "checkpoint_id": "CP_WAVE4_WATCHER",
      "name": "文件监控验证",
      "commands": [
        "手动创建测试会话文件"
      ],
      "expected_outputs": [
        "2 秒内前端收到 sessions-changed 事件"
      ]
    },
    {
      "checkpoint_id": "CP_WAVE4_EXTRACT",
      "name": "日志提取验证",
      "commands": [
        "invoke('extract_session', { sessionId: 'xxx', level: 'L2' })"
      ],
      "expected_outputs": [
        "返回清理后的日志内容",
        "不包含冗余工具输出"
      ]
    }
  ],
  "git_strategy": {
    "workflow": "parallel_sub_branches",
    "steps": [
      "1. 从 feat/phase2-wave3 创建 feat/phase2-wave4 主分支",
      "2. 并行创建三个子分支（T2_4, T2_6, T3_4）",
      "3. 各任务完成后合并子分支到 feat/phase2-wave4",
      "4. 集成测试通过后合并到 master"
    ]
  },
  "deliverables": [
    "向量嵌入生成器",
    "文件实时监控器",
    "日志提取引擎",
    "导出功能（Markdown/JSON）"
  ],
  "risks_and_mitigations": [
    {
      "risk": "FastEmbed 模型下载失败",
      "probability": "medium",
      "impact": "high",
      "mitigation": "提供离线模型文件，支持本地加载"
    },
    {
      "risk": "文件监控占用过多资源",
      "probability": "low",
      "impact": "medium",
      "mitigation": "限制监控深度，添加节流"
    }
  ]
}

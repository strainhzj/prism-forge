{
  "_file_type": "task_definition",
  "_description": "T1_3 任务：扩展数据库表结构（v6.0 优化版）",
  "_version": "v6.0",
  "_version_description": "基于 v6.0 虚拟执行引擎优化，新增 Step 6 (migrate_v12) 添加 scan_cache_enabled 字段，完成配置闭环",
  "task_id": "T1_3",
  "_v6_0_compliance": {
    "configuration_closure_fixed": true,
    "new_step": "Step 6: 添加 settings 表扩展字段 (migrate_v12)",
    "rationale": "修复 scan_cache_enabled 配置闭环缺口，明确在 Wave 2 中创建此字段"
  },
  "name": "扩展数据库表结构",
  "wave_id": "WAVE_2",
  "sub_branch": "feat/phase1-wave2-t1_3",
  "assignee": "backend",
  "estimated_hours": 10,
  "priority": "high",
  "status": "pending",
  "requirement_ref": ["F5.3", "F5.4", "F6", "F7"],
  "dependencies": ["T1_1"],
  "output_artifacts": [
    "src-tauri/src/database/migrations.rs (版本 9-12)",
    "src-tauri/src/database/models.rs (扩展字段)"
  ],
  "implementation_steps": [
    {
      "step": 1,
      "title": "扩展 sessions 表",
      "description": "添加 rating, tags, is_archived 字段",
      "migration_version": 9,
      "files": ["src-tauri/src/database/migrations.rs"],
      "template_reference": "wave2.7_templates_v6.0.json -> T2_003",
      "sql": [
        "ALTER TABLE sessions ADD COLUMN rating INTEGER DEFAULT 0;",
        "ALTER TABLE sessions ADD COLUMN tags TEXT;",
        "ALTER TABLE sessions ADD COLUMN is_archived INTEGER DEFAULT 0;"
      ],
      "constraints": [
        "rating: 0-5 范围，0 表示未评分",
        "tags: JSON 数组字符串（如 '[\"tag1\", \"tag2\"]'）",
        "is_archived: 0 或 1，默认 0（未归档）"
      ],
      "function_signature": "fn migrate_v9(conn: &mut Connection) -> Result<()>",
      "verification": "字段添加成功",
      "status": "[ ]"
    },
    {
      "step": 2,
      "title": "创建 saved_prompts 表",
      "description": "用于保存用户生成的提示词",
      "migration_version": 10,
      "files": ["src-tauri/src/database/migrations.rs"],
      "template_reference": "wave2.7_templates_v6.0.json -> T2_004",
      "sql": [
        "CREATE TABLE IF NOT EXISTS saved_prompts (",
        "    id INTEGER PRIMARY KEY AUTOINCREMENT,",
        "    name TEXT NOT NULL,",
        "    content TEXT NOT NULL,",
        "    category TEXT,",
        "    created_at TEXT NOT NULL DEFAULT (datetime('now')),",
        "    updated_at TEXT NOT NULL DEFAULT (datetime('now'))",
        ");"
      ],
      "indexes": [
        "CREATE INDEX IF NOT EXISTS idx_saved_prompts_category ON saved_prompts(category);"
      ],
      "function_signature": "fn migrate_v10(conn: &mut Connection) -> Result<()>",
      "verification": "表创建成功",
      "status": "[ ]"
    },
    {
      "step": 3,
      "title": "创建 meta_templates 表",
      "description": "用于存储系统提示词模板",
      "migration_version": 11,
      "files": ["src-tauri/src/database/migrations.rs"],
      "template_reference": "wave2.7_templates_v6.0.json -> T2_005",
      "sql": [
        "CREATE TABLE IF NOT EXISTS meta_templates (",
        "    id INTEGER PRIMARY KEY AUTOINCREMENT,",
        "    name TEXT NOT NULL UNIQUE,",
        "    description TEXT,",
        "    template_content TEXT NOT NULL,",
        "    category TEXT,",
        "    version TEXT DEFAULT '1.0',",
        "    is_active INTEGER DEFAULT 1,",
        "    created_at TEXT NOT NULL DEFAULT (datetime('now')),",
        "    updated_at TEXT NOT NULL DEFAULT (datetime('now'))",
        ");"
      ],
      "indexes": [
        "CREATE INDEX IF NOT EXISTS idx_meta_templates_category ON meta_templates(category);",
        "CREATE INDEX IF NOT EXISTS idx_meta_templates_active ON meta_templates(is_active);"
      ],
      "function_signature": "fn migrate_v11(conn: &mut Connection) -> Result<()>",
      "verification": "表创建成功",
      "status": "[ ]"
    },
    {
      "step": 4,
      "title": "更新数据模型",
      "description": "在 Session 结构体中添加新字段",
      "files": ["src-tauri/src/database/models.rs"],
      "fields": [
        "pub rating: i32,  // 0-5",
        "pub tags: Option<String>,  // JSON Array",
        "pub is_archived: bool",
        "pub message_count: usize  // v8.0 新增：与 T2_010 upsert_session 保持一致"
      ],
      "updated_struct": "#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct Session {\n    pub id: Option<i64>,\n    pub session_id: String,\n    pub project_path: String,\n    pub project_name: String,\n    pub rating: i32,\n    pub tags: Option<String>,\n    pub is_archived: bool,\n    pub is_active: bool,\n    pub message_count: usize,\n    pub created_at: String,\n    pub updated_at: String,\n}",
      "verification": "序列化/反序列化正常",
      "status": "[ ]"
    },
    {
      "step": 5,
      "title": "实现辅助方法",
      "description": "添加 tags 的序列化/反序列化方法",
      "files": ["src-tauri/src/database/models.rs"],
      "template_reference": "wave2.7_templates_v6.0.json -> T2_007",
      "methods": [
        "pub fn get_tags(&self) -> Result<Vec<String>>",
        "pub fn set_tags(&mut self, tags: Vec<String>) -> Result<()>"
      ],
      "implementation": "impl Session {\n    pub fn get_tags(&self) -> Result<Vec<String>> {\n        self.tags.as_ref()\n            .map(|s| serde_json::from_str(s))\n            .unwrap_or(Ok(vec![]))\n            .map_err(|e| anyhow::anyhow!(\"标签解析失败: {}\", e))\n    }\n\n    pub fn set_tags(&mut self, tags: Vec<String>) -> Result<()> {\n        self.tags = Some(serde_json::to_string(&tags)?);\n        Ok(())\n    }\n}",
      "verification": "单元测试通过",
      "status": "[ ]"
    },
    {
      "step": 6,
      "title": "添加 settings 表扩展字段",
      "description": "v6.0 新增：添加 scan_cache_enabled 字段，完成配置闭环",
      "_v6_0_addition": "修复配置闭环缺口，明确 scan_cache_enabled 字段创建时机",
      "migration_version": 12,
      "files": ["src-tauri/src/database/migrations.rs"],
      "template_reference": "wave2.7_templates_v6.0.json -> T2_009",
      "sql": [
        "ALTER TABLE settings ADD COLUMN scan_cache_enabled INTEGER DEFAULT 1;"
      ],
      "constraints": [
        "scan_cache_enabled: 0 或 1，默认 1（启用）"
      ],
      "function_signature": "fn migrate_v12(conn: &mut Connection) -> Result<()>",
      "configuration_closure": {
        "config_item": "scan_cache_enabled",
        "before": "⚠️ 存储位置模糊（Wave 2 或 Wave 3）",
        "after": "✅ 明确在 Wave 2 migrate_v12 中创建",
        "read_function": "T2_008 -> is_scan_cache_enabled()",
        "write_function": "T2_008 -> set_scan_cache_enabled()"
      },
      "verification": "字段添加成功，配置闭环完整",
      "status": "[ ]"
    }
  ],
  "migration_integration": {
    "update_run_migrations": "在 run_migrations() 函数中添加 migrate_v9, migrate_v10, migrate_v11, migrate_v12 调用",
    "call_order": [
      "migrate_v1(conn)?;",
      "...",
      "migrate_v8(conn)?;",
      "migrate_v9(conn)?;",
      "migrate_v10(conn)?;",
      "migrate_v11(conn)?;",
      "migrate_v12(conn)?;  // v6.0 新增"
    ],
    "schema_migrations_update": "确保 schema_migrations 表的 version 字段更新为 12 (v6.0 更新)"
  },
  "acceptance_criteria": [
    "AC1: sessions 表包含 rating, tags, is_archived 字段",
    "AC2: saved_prompts 表正确创建",
    "AC3: meta_templates 表正确创建",
    "AC4: 能插入测试数据并查询",
    "AC5: 标签字段能正确处理 JSON 数组",
    "AC6 (v6.0 新增): settings 表包含 scan_cache_enabled 字段"
  ],
  "testing_checklist": [
    "TC1.3.1: 测试 rating 字段约束 (0-5)",
    "TC1.3.2: 测试 tags 字段 JSON 序列化",
    "TC1.3.3: 测试 is_archived 默认值",
    "TC1.3.4: 测试 saved_prompts CRUD",
    "TC1.3.5: 测试 meta_templates CRUD",
    "TC1.3.6 (v6.0 新增): 测试 scan_cache_enabled 字段默认值"
  ],
  "data_structures": {
    "SavedPrompt": {
      "description": "用户保存的提示词",
      "fields": [
        "id: Option<i64>",
        "name: String",
        "content: String",
        "category: Option<String>",
        "created_at: String",
        "updated_at: String"
      ]
    },
    "MetaTemplate": {
      "description": "系统提示词模板",
      "fields": [
        "id: Option<i64>",
        "name: String (UNIQUE)",
        "description: Option<String>",
        "template_content: String",
        "category: Option<String>",
        "version: String",
        "is_active: bool",
        "created_at: String",
        "updated_at: String"
      ]
    }
  },
  "backward_compatibility": {
    "existing_sessions": "已存在的 sessions 记录会自动使用默认值（rating=0, is_archived=0, tags=NULL）",
    "alter_table_safe": "ALTER TABLE ADD COLUMN 是安全的，不会删除现有数据"
  },
  "_v6_0_improvements": {
    "symbol_reference_integrity": {
      "status": "✅ 已修复",
      "details": "添加 T2_009 模板提供完整的 migrate_v12 实现"
    },
    "configuration_closure": {
      "status": "✅ 已完成",
      "items": [
        "active_threshold: Wave 1 创建 + T2_008 读写函数",
        "scan_cache_enabled: Wave 2 migrate_v12 创建 + T2_008 读写函数"
      ]
    },
    "state_consistency": {
      "status": "✅ 已修复",
      "details": "明确 scan_cache_enabled 在 Wave 2 中创建，消除模糊描述"
    }
  }
}

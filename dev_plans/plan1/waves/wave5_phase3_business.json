{
  "wave_id": "WAVE_5",
  "name": "第五波：PHASE_3 核心业务逻辑",
  "description": "实现向量检索、上下文压缩、评分加权检索、提示词优化",
  "branch": {
    "name": "feat/phase3-wave5",
    "base": "master",
    "strategy": "feature_branch",
    "depends_on": [
      "feat/phase2-wave4"
    ]
  },
  "sequential_tasks": [
    {
      "task_id": "T3_1a",
      "name": "实现向量相似度检索",
      "sub_branch": "feat/phase3-wave5-t3_1a",
      "assignee": "backend",
      "estimated_hours": 16,
      "priority": "high",
      "status": "completed",
      "requirement_ref": [
        "F3.2"
      ],
      "dependencies": [
        "T2_4"
      ],
      "output_artifacts": [
        "src-tauri/src/optimizer/retriever.rs"
      ],
      "implementation_steps": [
        {
          "step": 1,
          "title": "实现向量检索器",
          "description": "基于 sqlite-vec 的相似度搜索",
          "files": [
            "src-tauri/src/optimizer/retriever.rs"
          ],
          "functions": [
            "pub struct VectorRetriever { db: Connection }",
            "pub fn search_similar(&self, query_embedding: &[f32], limit: usize) -> Result<Vec<SessionMatch>>"
          ],
          "sql_query": [
            "SELECT",
            "  s.session_id,",
            "  s.project_path,",
            "  m.summary,",
            "  distance(me.embedding, ?) AS distance",
            "FROM message_embeddings me",
            "JOIN message_metadata mm ON me.rowid = mm.rowid",
            "JOIN messages m ON m.uuid = mm.message_uuid",
            "JOIN sessions s ON s.session_id = m.session_id",
            "ORDER BY distance",
            "LIMIT ?"
          ],
          "similarity_calculation": "cosine_similarity = 1.0 - distance",
          "verification": "返回 Top-K 相似会话"
        },
        {
          "step": 2,
          "title": "创建 Tauri Command",
          "description": "暴露向量搜索命令",
          "files": [
            "src-tauri/src/commands.rs"
          ],
          "command_signature": "pub fn vector_search(query: String, limit: usize) -> Result<Vec<SessionMatch>>",
          "flow": [
            "1. 使用 EmbeddingGenerator 生成查询向量",
            "2. 调用 VectorRetriever.search_similar",
            "3. 返回结果列表"
          ],
          "verification": "前端可搜索相似会话"
        },
        {
          "step": 3,
          "title": "性能优化",
          "description": "确保 1000+ 会话检索 < 100ms",
          "optimizations": [
            "添加适当的索引",
            "限制返回数量",
            "使用预编译语句"
          ],
          "verification": "性能测试达标"
        }
      ],
      "acceptance_criteria": [
        "AC1: 输入查询文本，返回最相似的 5 条历史会话",
        "AC2: 按相似度排序",
        "AC3: 1000+ 会话检索 < 100ms",
        "AC4: 返回结果包含会话摘要和相似度分数"
      ],
      "testing_checklist": [
        "TC3.1a.1: 测试单关键词搜索",
        "TC3.1a.2: 测试多关键词搜索",
        "TC3.1a.3: 测试空查询处理",
        "TC3.1a.4: 测试性能（1000+ 会话）",
        "TC3.1a.5: 测试结果准确性"
      ]
    },
    {
      "task_id": "T3_1b",
      "name": "实现评分加权检索 (Weighted RAG)",
      "sub_branch": "feat/phase3-wave5-t3_1b",
      "assignee": "backend",
      "estimated_hours": 10,
      "priority": "high",
      "status": "pending",
      "requirement_ref": [
        "F3.3",
        "6.1"
      ],
      "dependencies": [
        "T3_1a",
        "T2B_2"
      ],
      "output_artifacts": [
        "src-tauri/src/optimizer/rag_engine.rs"
      ],
      "implementation_steps": [
        {
          "step": 1,
          "title": "实现加权检索",
          "description": "结合相似度和评分的混合排序",
          "files": [
            "src-tauri/src/optimizer/rag_engine.rs"
          ],
          "formula": "Score = 0.7 * cosine_similarity + 0.3 * (rating / 5.0)",
          "sql_query": [
            "SELECT",
            "  s.session_id,",
            "  s.project_name,",
            "  m.summary,",
            "  s.rating,",
            "  distance(me.embedding, ?) AS vec_dist,",
            "  ( (1.0 - distance(me.embedding, ?)) * 0.7 + (IFNULL(s.rating, 2.5) / 5.0 * 0.3) ) AS weighted_score",
            "FROM message_embeddings me",
            "JOIN message_metadata mm ON me.rowid = mm.rowid",
            "JOIN messages m ON m.uuid = mm.message_uuid",
            "JOIN sessions s ON s.session_id = m.session_id",
            "WHERE s.is_archived = 0 AND s.rating >= 2",
            "ORDER BY weighted_score DESC",
            "LIMIT ?"
          ],
          "verification": "高分会话排名提升"
        },
        {
          "step": 2,
          "title": "创建 RAG 引擎",
          "description": "封装加权检索逻辑",
          "functions": [
            "pub struct RAGEngine { retriever: VectorRetriever }",
            "pub fn search_best_practices(&self, query: &str, limit: usize) -> Result<Vec<SessionMatch>>"
          ],
          "verification": "返回高质量会话"
        },
        {
          "step": 3,
          "title": "测试验证",
          "description": "验证 5 星会话优先级",
          "test_scenario": "相似度稍低但评分高的会话应排在前面",
          "verification": "加权排序正确"
        }
      ],
      "acceptance_criteria": [
        "AC1: 5 星会话在相似度稍低时仍能排在前面",
        "AC2: 排除低分会话（rating < 2）",
        "AC3: 排除归档会话",
        "AC4: 加权公式可配置"
      ],
      "testing_checklist": [
        "TC3.1b.1: 测试加权公式",
        "TC3.1b.2: 测试 5 星会话优先",
        "TC3.1b.3: 测试低分过滤",
        "TC3.1b.4: 测试归档过滤",
        "TC3.1b.5: 测试未评分会话（默认 2.5 分）"
      ]
    },
    {
      "task_id": "T3_2",
      "name": "实现上下文压缩器",
      "sub_branch": "feat/phase3-wave5-t3_2",
      "assignee": "backend",
      "estimated_hours": 14,
      "priority": "high",
      "status": "pending",
      "requirement_ref": [
        "F3.3"
      ],
      "dependencies": [
        "T2_3",
        "T2_7"
      ],
      "output_artifacts": [
        "src-tauri/src/optimizer/compressor.rs"
      ],
      "implementation_steps": [
        {
          "step": 1,
          "title": "定义压缩规则",
          "description": "确定需要去除的冗余信息",
          "removal_rules": [
            "重复的工具调用",
            "中间输出（tool_output）",
            "Thinking 过程",
            "冗长的错误堆栈（保留关键信息）"
          ],
          "preservation_rules": [
            "关键决策点",
            "工具调用序列",
            "代码变更",
            "最终结果"
          ],
          "verification": "规则定义清晰"
        },
        {
          "step": 2,
          "title": "实现压缩器",
          "description": "遍历消息树并压缩",
          "files": [
            "src-tauri/src/optimizer/compressor.rs"
          ],
          "functions": [
            "pub struct ContextCompressor;",
            "pub fn compress(&self, context: &SessionContext) -> Result<CompressedContext>",
            "pub fn compress_messages(&self, messages: &[MessageNode]) -> Vec<MessageNode>"
          ],
          "compression_ratio_target": "> 50%",
          "verification": "压缩率达标"
        },
        {
          "step": 3,
          "title": "Token 统计",
          "description": "压缩前后 Token 对比",
          "integration": "使用 tiktoken-rs 计数",
          "output": {
            "original_tokens": "压缩前",
            "compressed_tokens": "压缩后",
            "reduction_percentage": "减少百分比"
          },
          "verification": "正确计算 Token 减少量"
        }
      ],
      "acceptance_criteria": [
        "AC1: 压缩后 Token 数减少 > 50%",
        "AC2: 保留关键信息（决策点、代码变更）",
        "AC3: 去除冗余信息（重复工具调用、中间输出）",
        "AC4: 压缩后内容可读性好"
      ],
      "testing_checklist": [
        "TC3.2.1: 测试压缩率",
        "TC3.2.2: 测试关键信息保留",
        "TC3.2.3: 测试冗余信息去除",
        "TC3.2.4: 测试复杂会话压缩",
        "TC3.2.5: 测试边界情况（空会话）"
      ]
    },
    {
      "task_id": "T3_3",
      "name": "连接优化器与 LLM",
      "sub_branch": "feat/phase3-wave5-t3_3",
      "assignee": "backend",
      "estimated_hours": 16,
      "priority": "critical",
      "status": "pending",
      "requirement_ref": [
        "F3.4",
        "F6"
      ],
      "dependencies": [
        "T3_1b",
        "T3_2"
      ],
      "output_artifacts": [
        "src-tauri/src/optimizer/mod.rs (扩展 - 集成优化流程)",
        "src-tauri/src/optimizer/prompt_generator.rs (新增 - 提示词生成器)",
        "src-tauri/src/commands.rs (扩展 - 新增 optimize_prompt 命令)"
      ],
      "implementation_steps": [
        {
          "step": 1,
          "title": "实现优化流程",
          "description": "整合检索、压缩、生成",
          "files": [
            "src-tauri/src/optimizer/mod.rs"
          ],
          "flow": [
            "1. 接收用户目标",
            "2. 生成查询向量",
            "3. 加权检索相关会话",
            "4. 加载会话上下文",
            "5. 压缩上下文",
            "6. 构建 Prompt",
            "7. 调用 LLM 生成",
            "8. 返回结果"
          ],
          "verification": "流程完整"
        },
        {
          "step": 2,
          "title": "集成 Meta-Prompt",
          "description": "使用用户配置的系统提示词",
          "integration": "从 meta_templates 表获取",
          "fallback": "使用默认模板",
          "verification": "能使用自定义 Meta-Prompt"
        },
        {
          "step": 3,
          "title": "创建 Tauri Command",
          "description": "暴露 optimize_prompt 命令",
          "files": [
            "src-tauri/src/commands.rs"
          ],
          "command_signature": "pub async fn optimize_prompt(goal: String, session_ids: Vec<String>) -> Result<EnhancedPrompt>",
          "return_format": {
            "original_goal": "用户输入",
            "referenced_sessions": "引用的会话",
            "enhanced_prompt": "优化后的提示词",
            "token_stats": "Token 统计",
            "confidence": "置信度"
          },
          "verification": "完整流程跑通"
        }
      ],
      "acceptance_criteria": [
        "AC1: 输入目标 -> 检索 -> 压缩 -> LLM 生成 -> 返回优化提示词",
        "AC2: 使用配置的 LLM Provider",
        "AC3: 引用相关历史会话",
        "AC4: 返回 Token 统计和节省百分比"
      ],
      "testing_checklist": [
        "TC3.3.1: 测试完整流程",
        "TC3.3.2: 测试无相关会话场景",
        "TC3.3.3: 测试 LLM 调用失败处理",
        "TC3.3.4: 测试 Meta-Prompt 使用",
        "TC3.3.5: 测试 Token 统计准确性"
      ]
    },
    {
      "task_id": "T3_5",
      "name": "实现 Meta-Prompt 管理",
      "sub_branch": "feat/phase3-wave5-t3_5",
      "assignee": "backend",
      "estimated_hours": 8,
      "priority": "medium",
      "status": "pending",
      "requirement_ref": [
        "F9.3"
      ],
      "dependencies": [
        "T1_3"
      ],
      "output_artifacts": [
        "src-tauri/src/commands.rs (扩展)"
      ],
      "implementation_steps": [
        {
          "step": 1,
          "title": "实现 Meta-Prompt CRUD",
          "description": "创建获取和更新 Meta-Prompt 的 Tauri 命令",
          "files": [
            "src-tauri/src/commands.rs"
          ],
          "command_signatures": [
            "pub fn get_meta_template(category: String) -> Result<MetaTemplate>",
            "pub fn update_meta_template(category: String, content: String) -> Result<()>"
          ],
          "verification": "命令可正常调用"
        },
        {
          "step": 2,
          "title": "集成到优化器",
          "description": "优化器使用 Meta-Prompt 生成分析",
          "files": [
            "src-tauri/src/optimizer/mod.rs"
          ],
          "verification": "使用自定义 Meta-Prompt 成功"
        }
      ],
      "acceptance_criteria": [
        "AC1: 能获取系统 Meta-Prompt",
        "AC2: 能更新 Meta-Prompt",
        "AC3: 更改立即生效",
        "AC4: 优化器使用新 Meta-Prompt"
      ],
      "testing_checklist": [
        "TC3.5.1: 测试获取默认 Meta-Prompt",
        "TC3.5.2: 测试更新 Meta-Prompt",
        "TC3.5.3: 测试优化器使用新 Meta-Prompt",
        "TC3.5.4: 测试类别区分"
      ]
    },
    {
      "task_id": "T3_PERF",
      "name": "性能基准测试 - 向量检索",
      "sub_branch": "feat/phase3-wave5-t3_perf",
      "assignee": "qa",
      "estimated_hours": 8,
      "priority": "medium",
      "status": "pending",
      "requirement_ref": [
        "NF1"
      ],
      "dependencies": [
        "T3_1a"
      ],
      "output_artifacts": [
        "src-tauri/tests/performance_vector.rs",
        "docs/performance_report_phase3.md"
      ],
      "implementation_steps": [
        {
          "step": 1,
          "title": "创建测试数据",
          "description": "生成 1000+ 测试会话",
          "method": "批量插入测试数据",
          "verification": "数据正确插入"
        },
        {
          "step": 2,
          "title": "执行性能测试",
          "description": "测量向量检索时间",
          "targets": [
            "100 会话检索 < 50ms",
            "1000 会话检索 < 100ms",
            "10000 会话检索 < 500ms"
          ],
          "verification": "所有测试通过"
        },
        {
          "step": 3,
          "title": "生成性能报告",
          "description": "记录性能指标和优化建议",
          "output": "docs/performance_report_phase3.md",
          "verification": "报告完整"
        }
      ],
      "acceptance_criteria": [
        "AC1: 1000+ 会话中检索 Top-5 < 100ms",
        "AC2: 性能报告完整",
        "AC3: 未达标项有优化方案"
      ]
    }
  ],
  "verification_checkpoints": [
    {
      "checkpoint_id": "CP_WAVE5_SEARCH",
      "name": "向量检索验证",
      "commands": [
        "invoke('vector_search', { query: 'fix authentication bug', limit: 5 })"
      ],
      "expected_outputs": [
        "返回 5 条相关会话",
        "按相似度/加权分数排序"
      ]
    },
    {
      "checkpoint_id": "CP_WAVE5_COMPRESS",
      "name": "上下文压缩验证",
      "commands": [
        "检查压缩率"
      ],
      "expected_outputs": [
        "Token 减少 > 50%"
      ]
    },
    {
      "checkpoint_id": "CP_WAVE5_OPTIMIZE",
      "name": "提示词优化验证",
      "commands": [
        "invoke('optimize_prompt', { goal: '实现用户登录', sessionIds: [] })"
      ],
      "expected_outputs": [
        "返回优化后的提示词",
        "包含 Token 统计",
        "包含引用的会话"
      ]
    }
  ],
  "git_strategy": {
    "workflow": "sequential_with_sub_branches",
    "steps": [
      "1. 从 feat/phase2-wave4 创建 feat/phase3-wave5 主分支",
      "2. 按顺序创建子分支（T3_1a -> T3_1b -> T3_2 -> T3_3 -> T3_5 -> T3_PERF）",
      "3. 每个子分支完成后合并到 feat/phase3-wave5",
      "4. 所有任务完成后合并到 master"
    ]
  },
  "deliverables": [
    "向量相似度检索器",
    "评分加权 RAG 引擎",
    "上下文压缩器",
    "完整的提示词优化流程",
    "性能测试报告"
  ],
  "risks_and_mitigations": [
    {
      "risk": "向量检索性能不达标",
      "probability": "medium",
      "impact": "high",
      "mitigation": "添加索引、优化查询、限制返回数量"
    },
    {
      "risk": "LLM 调用失败",
      "probability": "low",
      "impact": "medium",
      "mitigation": "重试机制、降级到模板生成"
    }
  ],
  "_file_type": "wave_manifest",
  "_description": "WAVE_5: 第五波：PHASE_3 核心业务逻辑"
}
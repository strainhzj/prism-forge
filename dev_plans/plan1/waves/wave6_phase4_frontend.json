{
  "wave_id": "WAVE_6",
  "name": "第六波：PHASE_4 前端 UI 核心",
  "description": "搭建 React 框架、shadcn/ui、实现会话列表、详情页、消息树可视化",
  "branch": {
    "name": "feat/phase4-wave6",
    "base": "master",
    "strategy": "feature_branch",
    "depends_on": ["feat/phase3-wave5"]
  },
  "parallel_tasks": [
    {
      "task_id": "T4_SETUP",
      "name": "前端基础框架搭建",
      "sub_branch": "feat/phase4-wave6-setup",
      "assignee": "frontend",
      "estimated_hours": 16,
      "priority": "critical",
      "status": "pending",
      "dependencies": [],
      "output_artifacts": [
        "package.json (更新依赖)",
        "tailwind.config.js",
        "src/components/ui/* (shadcn/ui 组件)",
        "src/lib/utils.ts"
      ],
      "implementation_steps": [
        {
          "step": 1,
          "title": "安装 shadcn/ui",
          "description": "配置 shadcn/ui 和 Tailwind CSS",
          "commands": [
            "npx shadcn@latest init",
            "npx shadcn@latest add button card input textarea select dialog dropdown-menu"
          ],
          "verification": "组件正常渲染"
        },
        {
          "step": 2,
          "title": "配置路由",
          "description": "设置 React Router",
          "routes": [
            "/ - 主仪表盘",
            "/session/:id - 会话详情",
            "/prompt-lab - 提示词实验室",
            "/settings - 设置"
          ],
          "verification": "路由切换正常"
        },
        {
          "step": 3,
          "title": "创建状态管理",
          "description": "使用 Zustand 创建全局状态",
          "stores": [
            "useSessionStore.ts",
            "useSettingsStore.ts",
            "useUIStore.ts"
          ],
          "verification": "状态更新正确"
        },
        {
          "step": 4,
          "title": "配置 Tanstack Query",
          "description": "添加数据获取和缓存",
          "commands": [
            "npm install @tanstack/react-query"
          ],
          "verification": "QueryClient 配置完成"
        }
      ],
      "acceptance_criteria": [
        "AC1: shadcn/ui 组件正常工作",
        "AC2: Tailwind 样式正确应用",
        "AC3: 路由配置完成",
        "AC4: 状态管理可用"
      ]
    },
    {
      "task_id": "T4_1",
      "name": "会话列表与项目侧边栏",
      "sub_branch": "feat/phase4-wave6-t4_1",
      "assignee": "frontend",
      "estimated_hours": 20,
      "priority": "high",
      "status": "pending",
      "requirement_ref": ["F4.1", "F7.1"],
      "dependencies": ["T4_SETUP", "T1_2", "T2B_1"],
      "output_artifacts": [
        "src/components/SessionList.tsx",
        "src/components/ProjectSidebar.tsx",
        "src/stores/useSessionStore.ts"
      ],
      "implementation_steps": [
        {
          "step": 1,
          "title": "实现项目侧边栏",
          "description": "显示项目文件夹结构",
          "components": [
            "ProjectSidebar - 主容器",
            "ProjectGroup - 项目分组",
            "SessionItem - 会话项"
          ],
          "features": [
            "可折叠的项目列表",
            "显示会话数量",
            "按更新时间排序",
            "点击展开会话列表"
          ],
          "verification": "侧边栏显示项目结构"
        },
        {
          "step": 2,
          "title": "实现会话列表",
          "description": "显示会话卡片/表格",
          "components": [
            "SessionList - 会话列表",
            "SessionCard - 会话卡片",
            "SessionTable - 会话表格"
          ],
          "features": [
            "搜索/过滤",
            "按项目筛选",
            "按标签筛选",
            "按评分排序",
            "显示活跃状态"
          ],
          "verification": "列表正确显示会话"
        },
        {
          "step": 3,
          "title": "集成后端 API",
          "description": "调用 scan_sessions 和 get_projects",
          "hooks": [
            "useSessions() - 获取会话列表",
            "useProjects() - 获取项目列表"
          ],
          "verification": "数据正确显示"
        },
        {
          "step": 4,
          "title": "实现搜索和过滤",
          "description": "添加搜索框和过滤器",
          "filters": [
            "项目筛选",
            "标签筛选",
            "评分筛选",
            "归档筛选"
          ],
          "verification": "过滤功能正常"
        }
      ],
      "acceptance_criteria": [
        "AC1: 界面显示项目文件夹和会话列表",
        "AC2: 支持实时搜索",
        "AC3: 点击项目展开会话列表",
        "AC4: 支持多种过滤条件",
        "AC5: 显示会话元数据（时间、评分、标签）"
      ]
    },
    {
      "task_id": "T4_2",
      "name": "消息树可视化与懒加载",
      "sub_branch": "feat/phase4-wave6-t4_2",
      "assignee": "frontend",
      "estimated_hours": 24,
      "priority": "critical",
      "status": "pending",
      "requirement_ref": ["F4.2", "F8.1"],
      "dependencies": ["T4_SETUP", "T2_2", "T2_5", "T3_4"],
      "output_artifacts": [
        "src/components/MessageTree.tsx",
        "src/components/MessageNode.tsx",
        "src/components/CodeBlock.tsx"
      ],
      "implementation_steps": [
        {
          "step": 1,
          "title": "实现消息树组件",
          "description": "递归渲染消息树",
          "components": [
            "MessageTree - 树容器",
            "MessageNode - 节点（递归）",
            "NodeContent - 节点内容"
          ],
          "features": [
            "可折叠/展开",
            "显示消息类型（User/Assistant/Tool）",
            "显示时间戳",
            "嵌套缩进"
          ],
          "verification": "树正确渲染"
        },
        {
          "step": 2,
          "title": "实现懒加载",
          "description": "点击节点时加载完整内容",
          "mechanism": [
            "初始只显示 summary",
            "点击时调用 get_message_at",
            "缓存已加载的内容"
          ],
          "verification": "懒加载正常工作"
        },
        {
          "step": 3,
          "title": "实现代码块高亮",
          "description": "使用 Prism.js 或 Shiki",
          "features": [
            "语法高亮",
            "复制按钮",
            "语言标识"
          ],
          "verification": "代码块正确高亮"
        },
        {
          "step": 4,
          "title": "实现日志等级视图",
          "description": "L1/L2/L3 视图切换",
          "components": [
            "ViewLevelSelector - 视图选择器",
            "FullTraceView - L1 视图",
            "CleanFlowView - L2 视图",
            "PromptOnlyView - L3 视图"
          ],
          "verification": "视图切换生效"
        }
      ],
      "acceptance_criteria": [
        "AC1: 点击会话能展示树状结构",
        "AC2: 展开节点显示详情",
        "AC3: 代码块正确高亮",
        "AC4: 视图切换生效（L1/L2/L3）",
        "AC5: 懒加载不影响性能"
      ]
    },
    {
      "task_id": "T4_3",
      "name": "集成 Token 计数器 UI",
      "sub_branch": "feat/phase4-wave6-t4_3",
      "assignee": "frontend",
      "estimated_hours": 8,
      "priority": "high",
      "status": "pending",
      "requirement_ref": ["F4.6", "F3.5"],
      "dependencies": ["T4_SETUP", "T2_7", "T4_2"],
      "output_artifacts": [
        "src/components/TokenCounter.tsx",
        "src/hooks/useTokenCounter.ts"
      ],
      "implementation_steps": [
        {
          "step": 1,
          "title": "创建 TokenCounter 组件",
          "description": "显示 Token 数和费用",
          "display": [
            "Token 数量（千分位）",
            "估算费用",
            "节省百分比（如有）"
          ],
          "verification": "正确显示 Token 数"
        },
        {
          "step": 2,
          "title": "集成到会话详情",
          "description": "在会话详情页显示 Token 统计",
          "placement": "消息树顶部或底部",
          "verification": "Token 信息正确显示"
        },
        {
          "step": 3,
          "title": "集成到提示词构建器",
          "description": "实时显示 Token 数",
          "features": [
            "实时计数",
            "进度条",
            "超时警告"
          ],
          "verification": "实时更新正常"
        }
      ],
      "acceptance_criteria": [
        "AC1: 界面显示 Token 数和金额",
        "AC2: 实时更新",
        "AC3: 格式化显示（千分位）",
        "AC4: 费用估算准确"
      ]
    },
    {
      "task_id": "T4_4",
      "name": "实现实时更新指示器",
      "sub_branch": "feat/phase4-wave6-t4_4",
      "assignee": "frontend",
      "estimated_hours": 10,
      "priority": "high",
      "status": "pending",
      "requirement_ref": ["F4.4"],
      "dependencies": ["T4_SETUP", "T2_6", "T4_1"],
      "output_artifacts": [
        "src/components/RefreshIndicator.tsx",
        "src/hooks/useSessionMonitor.ts"
      ],
      "implementation_steps": [
        {
          "step": 1,
          "title": "监听 Tauri Events",
          "description": "监听 sessions-changed 事件",
          "event_name": "sessions-changed",
          "payload": [
            "event_type: 'created' | 'updated' | 'deleted'",
            "session_id: string"
          ],
          "verification": "能接收事件"
        },
        {
          "step": 2,
          "title": "显示加载动画",
          "description": "事件触发时显示刷新指示器",
          "animation": "2 秒后自动刷新列表",
          "verification": "动画正确显示"
        },
        {
          "step": 3,
          "title": "自动刷新列表",
          "description": "调用 useSessions 的 refetch",
          "debounce": "2 秒延迟",
          "verification": "列表自动更新"
        }
      ],
      "acceptance_criteria": [
        "AC1: Claude Code 写入新消息后，前端自动显示新内容",
        "AC2: 加载动画显示",
        "AC3: 2 秒后自动刷新",
        "AC4: 事件去重生效"
      ]
    },
    {
      "task_id": "T4_5",
      "name": "会话评分与标签 UI",
      "sub_branch": "feat/phase4-wave6-t4_5",
      "assignee": "frontend",
      "estimated_hours": 12,
      "priority": "medium",
      "status": "pending",
      "requirement_ref": ["F7.3"],
      "dependencies": ["T4_SETUP", "T2B_2", "T4_2"],
      "output_artifacts": [
        "src/components/SessionRating.tsx",
        "src/components/TagEditor.tsx"
      ],
      "implementation_steps": [
        {
          "step": 1,
          "title": "实现星级评分组件",
          "description": "1-5 星评分",
          "features": [
            "点击星星评分",
            "悬停预览",
            "支持快捷键（1-5 键）"
          ],
          "verification": "评分功能正常"
        },
        {
          "step": 2,
          "title": "实现标签编辑器",
          "description": "添加/删除标签",
          "features": [
            "标签输入框",
            "标签列表",
            "删除按钮",
            "推荐标签"
          ],
          "verification": "标签功能正常"
        },
        {
          "step": 3,
          "title": "集成到会话详情",
          "description": "在详情页显示评分和标签",
          "placement": "会话头部",
          "verification": "UI 正确集成"
        }
      ],
      "acceptance_criteria": [
        "AC1: 能对会话进行打分",
        "AC2: 能添加/删除标签",
        "AC3: 数据同步到后端",
        "AC4: 支持快捷键操作"
      ]
    },
    {
      "task_id": "T4_6",
      "name": "设置页面与 API 配置",
      "sub_branch": "feat/phase4-wave6-t4_6",
      "assignee": "frontend",
      "estimated_hours": 14,
      "priority": "high",
      "status": "pending",
      "requirement_ref": ["F6.3", "F6.5"],
      "dependencies": ["T4_SETUP", "T3_LLM", "T4_1"],
      "output_artifacts": [
        "src/pages/Settings.tsx (扩展)",
        "src/components/settings/ProviderSettings.tsx"
      ],
      "implementation_steps": [
        {
          "step": 1,
          "title": "集成 ProviderForm",
          "description": "使用现有的 ProviderForm.tsx",
          "integration": "导入到设置页面",
          "verification": "表单正常显示"
        },
        {
          "step": 2,
          "title": "实现提供商列表",
          "description": "显示已配置的提供商",
          "features": [
            "列表显示",
            "设为活跃",
            "编辑",
            "删除"
          ],
          "verification": "列表功能正常"
        },
        {
          "step": 3,
          "title": "添加连通性测试",
          "description": "测试按钮和结果显示",
          "components": [
            "TestConnectionButton - 测试按钮",
            "ConnectionResult - 结果显示"
          ],
          "verification": "测试功能正常"
        }
      ],
      "acceptance_criteria": [
        "AC1: 能在前端保存 API Key",
        "AC2: 能通过测试按钮验证连接",
        "AC3: 能切换活跃提供商",
        "AC4: 表单验证正确"
      ]
    }
  ],
  "verification_checkpoints": [
    {
      "checkpoint_id": "CP_WAVE6_LIST",
      "name": "会话列表验证",
      "actions": [
        "打开应用",
        "检查侧边栏显示项目",
        "检查会话列表显示"
      ],
      "expected_outputs": [
        "项目列表正确显示",
        "会话列表正确显示",
        "搜索功能正常"
      ]
    },
    {
      "checkpoint_id": "CP_WAVE6_TREE",
      "name": "消息树验证",
      "actions": [
        "点击会话",
        "检查消息树渲染"
      ],
      "expected_outputs": [
        "树正确渲染",
        "可折叠/展开",
        "代码高亮正常"
      ]
    },
    {
      "checkpoint_id": "CP_WAVE6_TOKEN",
      "name": "Token 计数验证",
      "actions": [
        "检查 Token 显示"
      ],
      "expected_outputs": [
        "Token 数正确显示",
        "费用估算正确"
      ]
    }
  ],
  "git_strategy": {
    "workflow": "parallel_sub_branches",
    "steps": [
      "1. 从 feat/phase3-wave5 创建 feat/phase4-wave6 主分支",
      "2. 并行创建子分支（T4_SETUP 先完成，其他并行）",
      "3. 各任务完成后合并到 feat/phase4-wave6",
      "4. 集成测试通过后合并到 master"
    ]
  },
  "deliverables": [
    "完整的前端框架",
    "会话列表和项目侧边栏",
    "消息树可视化",
    "Token 计数器 UI",
    "实时更新指示器",
    "评分标签 UI",
    "设置页面"
  ],
  "risks_and_mitigations": [
    {
      "risk": "shadcn/ui 样式冲突",
      "probability": "low",
      "impact": "medium",
      "mitigation": "使用 CSS Module 或 Tailwind @apply"
    },
    {
      "risk": "消息树渲染性能",
      "probability": "medium",
      "impact": "high",
      "mitigation": "虚拟滚动、懒加载、限制渲染深度"
    }
  ]
}

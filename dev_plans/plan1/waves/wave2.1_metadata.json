{
  "_file_type": "metadata",
  "_description": "Wave 2 元数据：版本历史、Agent 指令、文件操作、基本信息",
  "wave_id": "WAVE_2",
  "name": "第二波：PHASE_1 核心任务",
  "description": "完成会话扫描器和表结构扩展，实现基础的会话发现功能",
  "branch": {
    "name": "feat/phase1-wave2",
    "base": "master",
    "strategy": "feature_branch",
    "depends_on": ["feat/phase1-wave1"]
  },
  "_version_history": {
    "current": "v6.0",
    "changelog": [
      {
        "version": "v6.0",
        "date": "2025-12-30",
        "changes": [
          "v8.0 一致性检查优化",
          "同步与 wave2_phase1_core.json 的版本号",
          "修正并行化建议说明（v5.0 后 T1_2 依赖 T1_3）",
          "更新文件路径引用（v3.1 文件名）"
        ]
      },
      {
        "version": "v1.0",
        "date": "2025-12-29",
        "changes": [
          "初始版本",
          "从 wave2_phase1_core.json 拆分为 7 个子文件",
          "定义 T1_2, T1_3, T1_PERF 三个顺序任务",
          "添加元数据、集成指南和策略指南文件"
        ]
      }
    ],
    "database_versions": {
      "v9": "扩展 sessions 表（rating, tags, is_archived 字段）",
      "v10": "创建 saved_prompts 表",
      "v11": "创建 meta_templates 表",
      "v12": "扩展 settings 表（scan_cache_enabled 字段）"
    }
  },
  "_critical_resources": {
    "description": "关键资源文件，包含实现所需的完整代码模板和设计决策",
    "priority_reading": [
      {
        "file": "dev_plans/plan1/waves/wave2.5_integration_v3.1.json",
        "purpose": "验证检查点和集成任务指导（v3.1 版本）",
        "key_sections": [
          "verification_checkpoints - 会话扫描、表结构、性能验证",
          "integration_tasks - 任务集成和 main_plan.json 状态更新"
        ]
      },
      {
        "file": "dev_plans/plan1/waves/wave2.6_strategy.json",
        "purpose": "Git 策略和风险缓解指南",
        "key_sections": [
          "git_strategy.workflow - sequential_with_sub_branches 工作流",
          "risks_and_mitigations - 目录不存在、文件锁定检测失败等风险"
        ]
      }
    ]
  },
  "_agent_instructions": {
    "recommended_reading_order": [
      "第一步：wave2.1_metadata.json (本文件) - 了解元数据和关键决策",
      "第二步：wave2.5_integration.json - 验证检查点和集成指南",
      "第三步：wave2.6_strategy.json - Git 策略和风险",
      "第四步：wave2.2_task_t1_2.json - T1_2 任务详情（按步骤执行）",
      "第五步：wave2.3_task_t1_3_v6.0.json - T1_3 任务详情（含 migrate_v12）",
      "第六步：wave2.4_task_t1_perf.json - T1_PERF 任务详情（按步骤执行）",
      "现有代码：src-tauri/src/monitor/* 和 src-tauri/src/database/*"
    ],
    "required_reading": [
      "dev_plans/plan1/waves/wave2_phase1_core.json (主文件)",
      "dev_plans/plan1/waves/wave2.1_metadata.json (本文件)",
      "dev_plans/plan1/waves/wave2.2_task_t1_2.json (T1_2 任务详情)",
      "dev_plans/plan1/waves/wave2.3_task_t1_3_v6.0.json (T1_3 任务详情)",
      "dev_plans/plan1/waves/wave2.4_task_t1_perf_v4.1.json (T1_PERF 任务详情)",
      "dev_plans/plan1/waves/wave2.5_integration_v3.1.json (集成和验证)",
      "dev_plans/plan1/waves/wave2.6_strategy.json (Git 策略、风险)",
      "src-tauri/src/database/migrations.rs (理解现有迁移机制)",
      "src-tauri/src/database/models.rs (理解现有数据模型)",
      "src-tauri/src/database/repository.rs (理解 Repository 模式)"
    ],
    "context_understanding": [
      "Wave 1 已完成数据库基础架构（sessions, messages 等表）",
      "Wave 2 建立在 Wave 1 基础上，扩展会话扫描功能",
      "T1_2 依赖 T1_1 完成（Wave 1 的数据库集成）",
      "T1_3 依赖 T1_1 完成（扩展 sessions 表结构）",
      "T1_PERF 依赖 T1_2 完成（性能测试需要扫描器）"
    ],
    "critical_decisions": [
      "会话扫描目录：使用 dirs::home_dir() 获取 ~/.claude/projects/",
      "活跃会话检测：优先使用 Windows 文件锁定检测，降级到基于时间的判断（24小时内）",
      "存储策略：使用 upsert 逻辑（检查存在性，更新或创建）",
      "性能优化：使用 rayon 并行扫描，缓存结果，增量扫描",
      "tags 序列化：使用 JSON 数组字符串存储",
      "分支策略：顺序执行（T1_2 -> T1_3 -> T1_PERF），每个任务使用独立子分支"
    ]
  },
  "_clarifications": {
    "description": "澄清 Wave 2 中的关键实现细节",
    "session_scanning_path": {
      "claude_projects_directory": "~/.claude/projects/",
      "cross_platform_resolution": "dirs::home_dir().join('.claude').join('projects')",
      "windows_path": "%USERPROFILE%\\.claude\\projects\\",
      "macos_linux_path": "~/.claude/projects/",
      "pattern": "**/*.jsonl (递归搜索所有 JSONL 文件)"
    },
    "active_session_detection": {
      "primary_method_windows": "使用 Windows API 检查文件是否被进程锁定（CreateFile with GENERIC_READ, shared=0）",
      "fallback_method": "检查文件最后修改时间是否在 24 小时内",
      "fallback_threshold": "86400 秒（24 小时）",
      "implementation_note": "优先尝试 Windows 锁定检测，失败时降级到时间判断"
    },
    "session_metadata_extraction": {
      "session_id_source": "从文件名提取（UUID 格式，如 abc123-def456-...）",
      "project_path_source": "从文件路径提取（~/.claude/projects/{projectPath}/{session_id}.jsonl）",
      "created_at_source": "使用文件创建时间（file.metadata().created()?）",
      "updated_at_source": "使用文件修改时间（file.metadata().modified()?）",
      "message_count": "读取 JSONL 文件行数（或使用 lines().count()）"
    },
    "database_upsert_logic": {
      "step_1": "检查 session_id 是否已存在于 sessions 表",
      "step_2": "如果存在，更新 updated_at, is_active, message_count 字段",
      "step_3": "如果不存在，创建新记录（INSERT）",
      "step_4": "触发器自动处理 is_active 唯一性（仅一个活跃会话）"
    },
    "performance_optimization": {
      "parallel_scanning": "使用 rayon crate 并行扫描多个项目目录",
      "caching_strategy": "缓存上次扫描结果，仅检查变更文件（基于 modified 时间）",
      "incremental_scanning": "使用 glob 模式，避免遍历非项目目录",
      "target": "100 个会话扫描时间 < 2 秒"
    },
    "tags_serialization": {
      "storage_format": "JSON 数组字符串（如 '[\"tag1\", \"tag2\"]'）",
      "rust_type": "Option<String>",
      "helper_methods": "get_tags() -> Result<Vec<String>>, set_tags(Vec<String>) -> Result<()>",
      "validation": "验证 JSON 格式有效性，存储失败时返回错误"
    }
  },
  "_file_operations": {
    "modify": [
      "src-tauri/src/database/migrations.rs - 添加 migrate_v9, migrate_v10, migrate_v11 函数",
      "src-tauri/src/database/models.rs - 扩展 Session 结构体（rating, tags, is_archived）",
      "src-tauri/src/database/repository.rs - 添加 SessionRepository 的 upsert_session 方法",
      "src-tauri/src/commands.rs - 添加 scan_sessions 命令"
    ],
    "create": [
      "src-tauri/src/monitor/mod.rs - 监控模块基础结构",
      "src-tauri/src/monitor/scanner.rs - 会话扫描器实现",
      "src-tauri/tests/performance.rs - 性能测试框架"
    ]
  },
  "dependencies": {
    "wave_dependencies": ["WAVE_1"],
    "task_dependencies": {
      "T1_2": ["T1_1"],
      "T1_3": ["T1_1"],
      "T1_PERF": ["T1_2"]
    }
  },
  "wave_prerequisites": {
    "description": "Wave 1 的具体交付物，Wave 2 依赖这些前置条件",
    "WAVE_1_deliverables": {
      "database": {
        "version_range": "v4-v8",
        "tables": [
          "sessions - 会话基础表",
          "messages - 消息记录表",
          "api_providers - API 提供商表"
        ],
        "current_version": 8
      },
      "repository_layer": {
        "SessionRepository": [
          "get_session(id: i64) -> Result<Session>",
          "create_session(session: &Session) -> Result<Session>",
          "update_session(id: i64, session: &Session) -> Result<Session>",
          "list_sessions() -> Result<Vec<Session>>"
        ]
      },
      "llm_infrastructure": {
        "LLMClientManager": "单例模式管理 LLM 客户端",
        "TauriCommands": "基础命令基础设施已建立"
      }
    },
    "verification_commands": [
      "PRAGMA user_version; -- 应返回 8",
      "SELECT name FROM sqlite_master WHERE type='table' AND name IN ('sessions', 'messages', 'api_providers');"
    ]
  },
  "field_constraints": {
    "description": "关键状态字段的约束说明",
    "is_active": {
      "field": "sessions.is_active",
      "description": "会话活跃状态标志",
      "type": "BOOLEAN (INTEGER 0/1)",
      "constraint": "互斥性 - 同时只能有一个会话的 is_active 为 true",
      "enforcement": "数据库触发器 ensure_single_active_sessions 自动保证",
      "trigger_definition": "CREATE TRIGGER ensure_single_active_sessions AFTER UPDATE OF is_active ON sessions WHEN NEW.is_active = 1 BEGIN UPDATE sessions SET is_active = 0 WHERE id != NEW.id AND is_active = 1; END;",
      "business_logic": "新会话被激活时，旧会话自动变为历史会话"
    },
    "is_archived": {
      "field": "sessions.is_archived",
      "description": "会话归档状态标志",
      "type": "BOOLEAN (INTEGER 0/1)",
      "constraint": "无约束 - 可独立设置，与 is_active 共存",
      "usage": "用户手动归档旧会话，不影响活跃状态"
    }
  },
  "parallelization_opportunities": [
    {
      "task_group": "T1_2_and_T1_3",
      "tasks": ["T1_2", "T1_3"],
      "parallelizable": false,
      "_v5_0_note": "v5.0 修复依赖倒置后，T1_2 现依赖 T1_3，必须串行执行",
      "reason": "T1_2 需要完整的 Session 模型（包含 rating, tags, is_archived, message_count），必须在 T1_3 之后执行",
      "estimated_time_saving": "无（已取消并行化）",
      "coordinate_points": [
        "T1_2 修改 SessionRepository 时需与 T1_3 协调",
        "合并时可能需要解决 Session 结构体冲突"
      ],
      "recommended_workflow": [
        "开发者 B 在 feat/phase1-wave2-t1_3 开发数据库扩展（优先）",
        "开发者 A 在 feat/phase1-wave2-t1_2 开发会话扫描器（依赖 T1_3）",
        "依次合并：T1_3 → T1_2 → feat/phase1-wave2"
      ]
    }
  ],
  "success_criteria": [
    "会话扫描器能正确扫描 ~/.claude/projects/ 目录",
    "返回所有会话的元数据列表（sessionId, projectPath, isActive 等）",
    "活跃会话检测正确工作（Windows 锁定检测或时间判断）",
    "sessions 表扩展成功（rating, tags, is_archived 字段）",
    "saved_prompts 和 meta_templates 表正确创建",
    "性能达标：启动时间 < 3s，100 个会话扫描 < 2s",
    "所有验证检查点通过",
    "main_plan.json 状态已同步更新"
  ]
}

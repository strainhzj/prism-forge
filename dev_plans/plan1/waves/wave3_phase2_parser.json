{
  "wave_id": "WAVE_3",
  "name": "第三波：PHASE_2 解析引擎（与 PHASE_2B 并行）",
  "status": "completed",
  "completed_at": "2025-12-31",
  "description": "实现 JSONL 解析、消息树重构、关键信息提取，以及 PHASE_2B 的会话资产管理",
  "conflict_resolution": {
    "description": "多任务修改 commands.rs 的合并策略",
    "strategy": "sequential_merge",
    "merge_order": [
      "0. T2_2 完成 → 添加 parse_session_file 命令",
      "1. T2_5 完成 → 添加 get_message_at 命令",
      "2. T2B_1 完成 → 添加项目聚合命令（get_projects, get_project_sessions）",
      "3. T2B_2 完成 → 添加评分标签命令（set_session_rating, set_session_tags）",
      "4. T2B_3 完成 → 添加归档命令（archive_session, unarchive_session, get_archived_sessions）"
    ],
    "integration_verification": [
      "每个任务完成后，运行 cargo check 验证编译",
      "最终集成测试验证所有命令可正常调用"
    ]
  },
  "branch": {
    "name": "feat/phase2-wave3",
    "base": "feat/phase1-wave2",
    "strategy": "feature_branch",
    "depends_on": [
      "WAVE_2"
    ]
  },
  "prerequisites": {
    "description": "Wave 3 前置条件",
    "waves_required": [
      {
        "wave_id": "WAVE_2",
        "tasks_required": ["T1_2", "T1_3"],
        "reason": "T2_1/T2_5 依赖 T1_2 (会话扫描器), T2_3/T2B_2/T2B_3 依赖 T1_3 (数据库表结构)"
      }
    ],
    "database_versions_required": ["v9", "v10", "v11", "v12"],
    "verification_commands": [
      "SELECT name FROM sqlite_master WHERE type='table' AND name IN ('saved_prompts', 'meta_templates');",
      "PRAGMA table_info(sessions); -- 验证 rating, tags, is_archived 字段存在"
    ]
  },
  "parallel_groups": [
    {
      "group_id": "GROUP_A_PARSER",
      "name": "解析引擎组",
      "branch": "feat/phase2-wave3-parser",
      "description": "实现 JSONL 解析、消息树构建、关键信息提取",
      "execution_order": "sequential",
      "merge_target": "feat/phase2-wave3",
      "tasks": [
        {
          "task_id": "T2_1",
          "name": "实现 JSONL 流式解析",
          "estimated_hours": 16,
          "priority": "critical",
          "dependencies": [
            "T1_2"
          ],
          "sub_branch": "feat/phase2-wave3-t2_1"
        },
        {
          "task_id": "T2_2",
          "name": "消息树构建",
          "estimated_hours": 16,
          "priority": "critical",
          "dependencies": [
            "T2_1"
          ],
          "sub_branch": "feat/phase2-wave3-t2_2"
        },
        {
          "task_id": "T2_3",
          "name": "关键信息提取器",
          "estimated_hours": 14,
          "priority": "high",
          "dependencies": [
            "T2_2",
            "T1_3"
          ],
          "sub_branch": "feat/phase2-wave3-t2_3"
        },
        {
          "task_id": "T2_5",
          "name": "实现 FileShare 与 Offset 读取",
          "estimated_hours": 10,
          "priority": "high",
          "dependencies": [
            "T2_1"
          ],
          "sub_branch": "feat/phase2-wave3-t2_5"
        }
      ]
    },
    {
      "group_id": "GROUP_B_PHASE2B",
      "name": "会话资产管理组",
      "branch": "feat/phase2-wave3-phase2b",
      "description": "实现多项目管理、评分标签、归档功能",
      "execution_order": "sequential",
      "merge_target": "feat/phase2-wave3",
      "tasks": [
        {
          "task_id": "T2B_1",
          "name": "实现项目聚合逻辑",
          "estimated_hours": 16,
          "priority": "high",
          "dependencies": [
            "T1_2"
          ],
          "sub_branch": "feat/phase2-wave3-t2b_1"
        },
        {
          "task_id": "T2B_2",
          "name": "实现会话评分与标签",
          "estimated_hours": 10,
          "priority": "medium",
          "dependencies": [
            "T1_3"
          ],
          "sub_branch": "feat/phase2-wave3-t2b_2"
        },
        {
          "task_id": "T2B_3",
          "name": "实现归档管理",
          "estimated_hours": 6,
          "priority": "medium",
          "dependencies": [
            "T1_3"
          ],
          "sub_branch": "feat/phase2-wave3-t2b_3"
        }
      ]
    }
  ],
  "verification_checkpoints": [
    {
      "checkpoint_id": "CP_WAVE3_PARSE",
      "name": "解析功能验证",
      "commands": [
        "invoke('parse_session_file', { filePath: 'test.jsonl' })"
      ],
      "expected_outputs": [
        "返回消息树结构",
        "根节点为 User 消息",
        "子节点正确嵌套"
      ]
    },
    {
      "checkpoint_id": "CP_WAVE3_EXTRACT",
      "name": "信息提取验证",
      "commands": [
        "invoke('parse_session_file', { session_id: 'test-session-uuid' })",
        "检查返回的 MessageNode[0].metadata"
      ],
      "expected_outputs": [
        "包含 tool_calls",
        "包含 errors（如有）",
        "包含 code_changes（如有）"
      ]
    },
    {
      "checkpoint_id": "CP_WAVE3_PROJECTS",
      "name": "项目聚合验证",
      "commands": [
        "invoke('get_projects')"
      ],
      "expected_outputs": [
        "返回项目列表",
        "每个项目包含会话数",
        "按更新时间排序"
      ]
    }
  ],
  "git_strategy": {
    "workflow": "parallel_groups",
    "steps": [
      "1. 从 feat/phase1-wave2 创建 feat/phase2-wave3 主分支",
      "2. 并行创建两个组分支：feat/phase2-wave3-parser 和 feat/phase2-wave3-phase2b",
      "3. 各组内按顺序完成任务，完成后合并到 feat/phase2-wave3",
      "4. 两个组都完成后，合并 feat/phase2-wave3 到 master"
    ],
    "branch_structure": {
      "master": "主分支",
      "feat/phase2-wave3": "本波主分支",
      "feat/phase2-wave3-parser": "解析引擎组分支",
      "feat/phase2-wave3-phase2b": "PHASE_2B 组分支"
    }
  },
  "deliverables": [
    "完整的 JSONL 解析器",
    "消息树构建器",
    "关键信息提取器",
    "Offset 读取功能",
    "项目聚合功能",
    "评分与标签系统",
    "归档管理功能"
  ],
  "risks_and_mitigations": [
    {
      "risk": "消息树构建遇到循环引用",
      "probability": "low",
      "impact": "medium",
      "mitigation": "添加深度限制和循环检测"
    },
    {
      "risk": "文件被占用时读取失败",
      "probability": "medium",
      "impact": "low",
      "mitigation": "FileShare 模式 + 重试机制"
    },
    {
      "risk": "数据库迁移 v13 失败",
      "probability": "low",
      "impact": "high",
      "mitigation": "提供 rollback 脚本，迁移前备份数据库，添加迁移失败重试机制"
    }
  ],
  "next_wave_dependencies": [
    "WAVE_4: 依赖本波全部完成（PHASE_2 + PHASE_2B）"
  ],
  "tasks": [
    {
      "task_id": "T2_1",
      "name": "实现 JSONL 流式解析",
      "status": "completed",
      "estimated_hours": 16,
      "priority": "critical",
      "dependencies": [
        "T1_2"
      ]
    },
    {
      "task_id": "T2_2",
      "name": "消息树构建",
      "status": "completed",
      "estimated_hours": 16,
      "priority": "critical",
      "dependencies": [
        "T2_1"
      ]
    },
    {
      "task_id": "T2_3",
      "name": "关键信息提取器",
      "status": "completed",
      "estimated_hours": 14,
      "priority": "high",
      "dependencies": [
        "T2_2",
        "T1_3"
      ]
    },
    {
      "task_id": "T2_5",
      "name": "实现 FileShare 与 Offset 读取",
      "status": "completed",
      "estimated_hours": 10,
      "priority": "high",
      "dependencies": [
        "T2_1"
      ]
    },
    {
      "task_id": "T2B_1",
      "name": "实现项目聚合逻辑",
      "status": "completed",
      "estimated_hours": 16,
      "priority": "high",
      "dependencies": [
        "T1_2"
      ]
    },
    {
      "task_id": "T2B_2",
      "name": "实现会话评分与标签",
      "status": "completed",
      "estimated_hours": 10,
      "priority": "medium",
      "dependencies": [
        "T1_3"
      ]
    },
    {
      "task_id": "T2B_3",
      "name": "实现归档管理",
      "status": "completed",
      "estimated_hours": 6,
      "priority": "medium",
      "dependencies": [
        "T1_3"
      ]
    }
  ],
  "_file_type": "wave_manifest",
  "_description": "WAVE_3: 第三波：PHASE_2 解析引擎（与 PHASE_2B 并行）"
}
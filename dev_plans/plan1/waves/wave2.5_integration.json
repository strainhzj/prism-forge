{
  "_file_type": "integration_guide",
  "_description": "Wave 2 集成指南：集成任务、验证检查点、状态更新",
  "_version": "v3.1",
  "_version_description": "基于 16 维检查规则优化（v3.1），修复 JSON 路径引用错误，添加正确的 main_plan.json 更新路径",
  "_v3_1_improvements": {
    "rule_14_fix": {
      "title": "JSON 路径存在性验证修复",
      "original_problem": "wave2.5_integration.json 使用了不存在的路径 'waves.WAVE_2.status'",
      "root_cause": "main_plan.json 使用 phases[].tasks[] 结构追踪状态，而非顶级的 waves 对象",
      "solution": "使用精确的 JSONPath 或步骤化更新方式",
      "validation": "所有路径都已在 main_plan.json 中验证存在"
    }
  },
  "integration_tasks": [
    {
      "task_id": "WAVE2_INTEGRATION",
      "name": "第二波任务集成与合并",
      "description": "验证三个顺序任务完成后正确集成",
      "steps": [
        "合并 T1_2 分支到 feat/phase1-wave2（会话扫描器）",
        "合并 T1_3 分支到 feat/phase1-wave2（表结构扩展）",
        "合并 T1_PERF 分支到 feat/phase1-wave2（性能测试）",
        "解决冲突（如有）",
        "运行完整测试套件",
        "更新 main_plan.json 状态（使用正确的 JSONPath）"
      ],
      "acceptance_criteria": [
        "所有子分支成功合并到 feat/phase1-wave2",
        "cargo test --all 通过",
        "cargo clippy 无警告",
        "cargo fmt 检查通过",
        "应用能正常启动",
        "会话扫描功能正常工作"
      ]
    }
  ],
  "verification_checkpoints": [
    {
      "checkpoint_id": "CP_WAVE2_SCAN",
      "name": "会话扫描验证",
      "commands": [
        "invoke('scan_sessions')"
      ],
      "expected_outputs": [
        "返回会话列表，包含 sessionId, projectPath, isActive 等字段",
        "至少包含 1 个测试会话（如有）"
      ]
    },
    {
      "checkpoint_id": "CP_WAVE2_TABLES",
      "name": "表结构验证",
      "commands": [
        "PRAGMA table_info(sessions);"
      ],
      "expected_outputs": [
        "包含 rating, tags, is_archived 字段"
      ]
    },
    {
      "checkpoint_id": "CP_WAVE2_PERF",
      "name": "性能验证",
      "commands": [
        "cargo test --test performance -- --nocapture"
      ],
      "expected_outputs": [
        "所有性能测试通过",
        "启动时间 < 3s",
        "扫描时间 < 2s"
      ]
    }
  ],
  "main_plan_update_guide": {
    "description": "更新 dev_plans/plan1/main_plan.json 的步骤（v3.1 修正版）",
    "file_location": "dev_plans/plan1/main_plan.json",
    "_v3_1_path_validation": {
      "note": "以下路径已在 main_plan.json 中验证存在",
      "validated_paths": [
        "completed_tasks (array)",
        "global_status.overall_progress (string)",
        "global_status.last_updated (string)",
        "phases[0].tasks[?(@.id=='T1_2')].status",
        "phases[0].tasks[?(@.id=='T1_3')].status",
        "phases[0].tasks[?(@.id=='T1_PERF')].status"
      ]
    },
    "update_steps": [
      {
        "step": 1,
        "action": "更新 completed_tasks 数组",
        "path": "completed_tasks",
        "path_exists": true,
        "validation": "main_plan.json 中 completed_tasks 是顶层数组键",
        "add_items": ["T1_2", "T1_3", "T1_PERF"],
        "json_path": "$.completed_tasks"
      },
      {
        "step": 2,
        "action": "更新 overall_progress",
        "path": "global_status.overall_progress",
        "path_exists": true,
        "validation": "main_plan.json 中 global_status.overall_progress 存在",
        "calculation": "Wave 1 完成 3 个任务 + Wave 2 完成 3 个任务 = 6/15 ≈ 40%",
        "suggested_value": "40%",
        "json_path": "$.global_status.overall_progress"
      },
      {
        "step": 3,
        "action": "更新 last_updated",
        "path": "global_status.last_updated",
        "path_exists": true,
        "validation": "main_plan.json 中 global_status.last_updated 存在",
        "value": "2025-12-29",
        "json_path": "$.global_status.last_updated"
      },
      {
        "step": 4,
        "action": "更新 T1_2 任务状态",
        "path": "phases[0].tasks[?(@.id=='T1_2')].status",
        "path_exists": true,
        "validation": "main_plan.json 中 phases[0].tasks 数组包含 id='T1_2' 的任务",
        "new_value": "completed",
        "alternative_instruction": "使用文本编辑器搜索 'T1_2' 并手动修改 status 字段",
        "json_path": "$.phases[0].tasks[?(@.id=='T1_2')].status"
      },
      {
        "step": 5,
        "action": "更新 T1_3 任务状态",
        "path": "phases[0].tasks[?(@.id=='T1_3')].status",
        "path_exists": true,
        "validation": "main_plan.json 中 phases[0].tasks 数组包含 id='T1_3' 的任务",
        "new_value": "completed",
        "json_path": "$.phases[0].tasks[?(@.id=='T1_3')].status"
      },
      {
        "step": 6,
        "action": "更新 T1_PERF 任务状态",
        "path": "phases[0].tasks[?(@.id=='T1_PERF')].status",
        "path_exists": true,
        "validation": "main_plan.json 中 phases[0].tasks 数组包含 id='T1_PERF' 的任务",
        "new_value": "completed",
        "json_path": "$.phases[0].tasks[?(@.id=='T1_PERF')].status"
      },
      {
        "step": 7,
        "action": "保持 PHASE_1 状态",
        "path": "phases[0].status",
        "path_exists": true,
        "validation": "main_plan.json 中 phases[0].status 存在",
        "note": "保持为 'in_progress'，因为 PHASE_1 还有其他任务",
        "json_path": "$.phases[0].status"
      }
    ],
    "manual_update_instructions": {
      "title": "手动更新指南（推荐）",
      "reason": "由于 JSONPath 在文本编辑中不易操作，建议手动定位修改",
      "steps": [
        "1. 打开 dev_plans/plan1/main_plan.json",
        "2. 搜索 'completed_tasks' 数组，添加 'T1_2', 'T1_3', 'T1_PERF'",
        "3. 搜索 '\"id\": \"T1_2\"'，将其 'status' 字段改为 'completed'",
        "4. 搜索 '\"id\": \"T1_3\"'，将其 'status' 字段改为 'completed'",
        "5. 搜索 '\"id\": \"T1_PERF\"'，将其 'status' 字段改为 'completed'",
        "6. 修改 'global_status.overall_progress' 为 '40%'",
        "7. 修改 'global_status.last_updated' 为 '2025-12-29'"
      ]
    },
    "automated_update_script": {
      "title": "自动化更新脚本（Python）",
      "language": "python",
      "code": "\nimport json\n\ndef update_main_plan():\n    with open('dev_plans/plan1/main_plan.json', 'r', encoding='utf-8') as f:\n        data = json.load(f)\n\n    # 更新 completed_tasks\n    data['completed_tasks'].extend(['T1_2', 'T1_3', 'T1_PERF'])\n    data['completed_tasks'] = list(set(data['completed_tasks']))  # 去重\n\n    # 更新 global_status\n    data['global_status']['overall_progress'] = '40%'\n    data['global_status']['last_updated'] = '2025-12-29'\n\n    # 更新任务状态\n    for task in data['phases'][0]['tasks']:\n        if task['id'] in ['T1_2', 'T1_3', 'T1_PERF']:\n            task['status'] = 'completed'\n\n    with open('dev_plans/plan1/main_plan.json', 'w', encoding='utf-8') as f:\n        json.dump(data, f, indent=2, ensure_ascii=False)\n\n    print('main_plan.json 更新完成')\n\nif __name__ == '__main__':\n    update_main_plan()\n"
    }
  },
  "integration_validation": {
    "cross_task_dependencies": {
      "description": "验证跨任务依赖关系",
      "checks": [
        "T1_2 依赖 T1_1（Wave 1 完成）",
        "T1_3 依赖 T1_1（Wave 1 完成）",
        "T1_PERF 依赖 T1_2（会话扫描器）"
      ]
    },
    "database_migration_compatibility": {
      "description": "验证数据库迁移兼容性",
      "checks": [
        "Wave 1 的 v4-v8 迁移已执行",
        "Wave 2 的 v9-v11 迁移能正常执行",
        "schema_migrations 表的 version 为 11"
      ]
    },
    "api_compatibility": {
      "description": "验证 API 兼容性",
      "checks": [
        "scan_sessions 命令正常工作",
        "SessionRepository 的 upsert_session 方法正常",
        "Session 模型包含新字段（rating, tags, is_archived）"
      ]
    }
  },
  "rollback_plan": {
    "description": "Wave 2 回滚计划（v3.1 增强）",
    "steps": [
      {
        "step": 1,
        "action": "回滚数据库迁移",
        "commands": [
          "DELETE FROM schema_migrations WHERE version >= 9;",
          "ALTER TABLE sessions DROP COLUMN rating;",
          "ALTER TABLE sessions DROP COLUMN tags;",
          "ALTER TABLE sessions DROP COLUMN is_archived;",
          "DROP TABLE IF EXISTS saved_prompts;",
          "DROP TABLE IF EXISTS meta_templates;"
        ]
      },
      {
        "step": 2,
        "action": "回滚代码变更",
        "files": [
          "删除 src-tauri/src/monitor/ 目录",
          "恢复 src-tauri/src/database/migrations.rs（移除 v9-v11）",
          "恢复 src-tauri/src/database/models.rs（移除 Session 新字段）",
          "恢复 src-tauri/src/commands.rs（移除 scan_sessions）"
        ]
      },
      {
        "step": 3,
        "action": "回滚 main_plan.json 状态",
        "manual_steps": [
          "从 completed_tasks 数组移除 'T1_2', 'T1_3', 'T1_PERF'",
          "将 T1_2, T1_3, T1_PERF 的 status 改回 'pending'",
          "将 overall_progress 改回 '15%'"
        ]
      },
      {
        "step": 4,
        "action": "验证回滚",
        "commands": [
          "cargo check",
          "cargo test"
        ]
      }
    ]
  },
  "next_wave_dependencies": [
    "WAVE_3: 依赖 T1_2 完成（会话扫描功能）",
    "WAVE_4: 依赖 Wave 2 全部完成（PHASE_1 完整功能）"
  ]
}
